<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Valgbar – Folketingsvalg 2019</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{ --vb-navy:#234a5a; --vb-navy-2:#1b3d4d; }
.vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
.vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
.vb-btn:disabled{ opacity:.5; cursor:not-allowed; }
.vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
.vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }
.vb-tabbox.small{ flex:0 0 auto; padding:.4rem .8rem; font-size:.9rem; }
.vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff; display:flex; align-items:center; justify-content:space-between; }
.vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
.vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
.vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }
.vb-menu{ position:absolute; z-index:50; margin-top:.25rem; min-width:16rem; max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
.vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
.vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }
.table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{ position:sticky; left:0; background:#fff; }
.vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }
.kreds-divider { padding:0; line-height:0; height:0; border-top:3px solid #111827; }
.rank-pill{ width:28px; height:28px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; border:1px solid #e5e7eb; background:#f9fafb; }
.top10-item{ display:flex; align-items:center; gap:.75rem; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:12px; cursor:pointer; }
.top10-item:hover{ background:#f9fafb; }
.top10-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; }
@media (min-width:768px){ .top10-grid{ grid-template-columns:1fr 1fr; } }
.context-bar{ display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; }
.crumb{ color:#374151; text-decoration:underline; cursor:pointer; }
.crumb-strong{ background:#111827; color:#fff; border-radius:9999px; padding:.15rem .6rem; font-weight:600; }
.sep{ color:#9ca3af; }
.cell-na{ color:#9ca3af; }
.loader-wrap{ display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#6b7280; }
.progress{ position:relative; height:6px; background:#f3f4f6; border-radius:9999px; overflow:hidden; }
.progress::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg, rgba(0,0,0,0) 0%, #c7d2fe 50%, rgba(0,0,0,0) 100%); animation:loadbar 1.2s infinite; }
@keyframes loadbar{ 0%{transform:translateX(-100%)} 50%{transform:translateX(0%)} 100%{transform:translateX(100%)} }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="../../" class="flex items-center gap-3">
      <img src="../../Valgbar-transparent3.png" alt="Valgbar" class="h-32 w-auto" />
    </a>
  </div>
  <div class="mx-auto max-w-6xl px-4 pb-1"><div id="error" class="mt-2 text-sm text-red-200"></div></div>
  <nav aria-label="Brødkrumme" class="mx-auto max-w-6xl px-4 pb-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <ol class="flex items-center gap-2 text-lg font-semibold">
        <li><a href="../../" class="underline text-white">Forside</a></li>
        <li class="opacity-70 text-white">/</li>
        <li><span aria-current="page" class="text-white">Folketingsvalg 2019</span></li>
      </ol>
      <div class="flex items-center gap-3 text-lg font-semibold">
        <label for="ftYearSelect" class="text-white whitespace-nowrap">Skift år:</label>
        <select id="ftYearSelect" class="rounded-lg bg-white text-gray-900 text-sm md:text-base px-2 py-1">
          <option value="../2007/">Folketingsvalg 2007</option>
          <option value="../2011/">Folketingsvalg 2011</option>
          <option value="../2015/">Folketingsvalg 2015</option>
          <option value="../2019/" selected>Folketingsvalg 2019</option>
          <option value="../2022/">Folketingsvalg 2022</option>
        </select>
      </div>
    </div>
  </nav>
</header>

<main class="mx-auto max-w-6xl p-4 space-y-6">
  <div id="contextBar" class="context-bar"></div>

  <section class="vb-card p-4 space-y-3">
    <div class="mt-1 grid grid-cols-1 md:grid-cols-3 gap-3 md:items-end">
      <div class="relative md:col-span-3">
        <label class="text-sm text-gray-600">Søg kandidat</label>
        <input id="candidateSearch" type="text" class="w-full mt-1 rounded-xl border p-2" placeholder="Skriv fx 'Jensen' eller 'Lars Løkke'…" autocomplete="off" />
        <div id="candidateMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="candidateSearch" style="max-width:48rem"></div>
      </div>
      <div><label class="text-sm text-gray-600">Storkreds</label><select id="storkredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select></div>
      <div><label class="text-sm text-gray-600">Kreds</label><select id="kredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select></div>
      <div><label class="text-sm text-gray-600">Valgsted</label><select id="valgstedSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled><option value="">(Vælg kreds først)</option></select></div>
    </div>
  </section>

  <section id="overviewTop" class="vb-card p-4">
    <div class="flex items-center justify-between mb-2">
      <div>
        <h2 id="top10Title" class="font-semibold">Top 10 kandidater (personlige stemmer)</h2>
        <div id="percentInfoOverview" class="mt-1 text-xs text-gray-600 bg-gray-50 border border-dashed border-gray-200 rounded-lg px-3 py-1 hidden"></div>
      </div>
      <div class="flex items-center gap-3">
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnModeCand" class="vb-tabbox small active" type="button">Kandidater</button>
          <button id="btnModeParty" class="vb-tabbox small" type="button">Partitotal</button>
        </div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnTop10" class="vb-tabbox small active" type="button">Top 10</button>
          <button id="btnAll" class="vb-tabbox small" type="button">Alle kandidater</button>
        </div>
      </div>
    </div>

    <div id="loader" class="loader-wrap hidden" aria-live="polite"><div class="progress w-48 rounded-full"></div><span id="loaderText">Indlæser…</span></div>

    <div id="top10List" class="top10-grid">
      <ol id="top10ColLeft" class="space-y-2"></ol>
      <ol id="top10ColRight" class="space-y-2"></ol>
    </div>
  </section>

  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Partier og kandidater</h2>
      <div id="storkredstitel" class="text-gray-500"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <aside class="md:col-span-1 vb-card p-4 space-y-2">
        <label class="text-sm font-medium">Vælg parti</label>
        <div id="partyCombo" class="relative">
          <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
            <span id="partyButtonContent" class="vb-combo-label">
              <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
              <span class="truncate text-gray-500">Vælg kreds først…</span>
            </span>
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0l-4.24-4.43a.75.75 0 01.02-1.06z"/></svg>
          </button>
          <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
        </div>
      </aside>

      <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
        <div class="flex items-center justify-between gap-3">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg et parti i drop-down menuen.</div>
          <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
            <button id="btnSortAlpha" class="vb-tabbox small active" type="button" title="Alfabetisk">A–Å</button>
            <button id="btnSortVotes" class="vb-tabbox small" type="button" title="Flest stemmer">Flest stemmer</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div id="candidateColLeft" class="space-y-2"></div>
          <div id="candidateColRight" class="space-y-2"></div>
        </div>
      </section>
    </div>
  </section>

  <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenligning af kandidater</h2>
      <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <div class="relative">
        <button id="btnAddKreds" class="vb-btn" aria-haspopup="listbox" aria-expanded="false">Tilføj kreds</button>
        <div id="addKredsMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="btnAddKreds"></div>
      </div>
      <div id="extraKredsChips" class="flex flex-wrap gap-2"></div>
    </div>
    <div id="selectedList" class="space-y-2"></div>
  </section>

  <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
    <div class="text-sm text-gray-600">Tabel pr. valgsted</div>
    <div class="overflow-auto">
      <table class="table-sticky w-full text-sm min-w-[720px]" id="psTable">
        <thead id="psThead"></thead>
        <tbody id="psTbody"></tbody>
        <tfoot id="psTFoot"></tfoot>
      </table>
    </div>
  </section>
</main>

<script>
/* ====== DATA-STI (FT 2019) ====== */
const BASE_PATH='../../data/ft/2019/';
const KREDS_ALL_VALUE="__ALL__";
const VALGSTED_ALL_VALUE="__ALL_PS__";
const DK_VALUE="__DK__";

/* Storkredse */
const STORKREDSE=["Bornholms Storkreds","Fyns Storkreds","Københavns Omegns Storkreds","Københavns Storkreds","Nordjyllands Storkreds","Nordsjællands Storkreds","Sjællands Storkreds","Sydjyllands Storkreds","Vestjyllands Storkreds","Østjyllands Storkreds"];

/* Kredse */
const KREDS_BY_STORKREDS={ "Bornholms Storkreds":["Rønnekredsen","Aakirkebykredsen"], "Fyns Storkreds":["Assenskredsen","Faaborgkredsen","Middelfartkredsen","Nyborgkredsen","Odense Sydkredsen","Odense Vestkredsen","Odense Østkredsen","Svendborgkredsen"], "Københavns Omegns Storkreds":["Ballerupkredsen","Brøndbykredsen","Gentoftekredsen","Gladsaxekredsen","Hvidovrekredsen","Lyngbykredsen","Rødovrekredsen","Taastrupkredsen"], "Københavns Storkreds":["Bispebjergkredsen","Brønshøjkredsen","Falkonerkredsen","Indre Bykredsen","Nørrebrokredsen","Slotskredsen","Sundbyvesterkredsen","Sundbyøsterkredsen","Tårnbykredsen","Valbykredsen","Vesterbrokredsen","Østerbrokredsen"], "Nordjyllands Storkreds":["Brønderslevkredsen","Frederikshavnkredsen","Himmerlandkredsen","Hjørringkredsen","Mariagerfjordkredsen","Thistedkredsen","Aalborg Nordkredsen","Aalborg Vestkredsen","Aalborg Østkredsen"], "Nordsjællands Storkreds":["Egedalkredsen","Fredensborgkredsen","Frederikssundkredsen","Helsingørkredsen","Hillerødkredsen","Rudersdalkredsen"], "Sjællands Storkreds":["Faxekredsen","Grevekredsen","Guldborgsundkredsen","Holbækkredsen","Kalundborgkredsen","Køgekredsen","Lollandkredsen","Næstvedkredsen","Ringstedkredsen","Roskildekredsen","Slagelsekredsen","Vordingborgkredsen"], "Sydjyllands Storkreds":["Esbjerg Bykredsen","Esbjerg Omegnskredsen","Fredericiakredsen","Haderslevkredsen","Kolding Nordkredsen","Kolding Sydkredsen","Sønderborgkredsen","Tønderkredsen","Vardekredsen","Vejenkredsen","Vejle Nordkredsen","Vejle Sydkredsen","Aabenraakredsen"], "Vestjyllands Storkreds":["Herning Nordkredsen","Herning Sydkredsen","Holstebrokredsen","Ikastkredsen","Ringkøbingkredsen","Silkeborg Nordkredsen","Silkeborg Sydkredsen","Skivekredsen","Struerkredsen","Viborg Vestkredsen","Viborg Østkredsen"], "Østjyllands Storkreds":["Djurskredsen","Favrskovkredsen","Hedenstedkredsen","Horsenskredsen","Randers Nordkredsen","Randers Sydkredsen","Skanderborgkredsen","Aarhus Nordkredsen","Aarhus Sydkredsen","Aarhus Vestkredsen","Aarhus Østkredsen"] };

/* Kreds → storkreds map */
const KREDS_TO_STORKREDS=(()=>{const m=new Map();for(const[sk,ks]of Object.entries(KREDS_BY_STORKREDS)){ks.forEach(k=>m.set((k||"").trim(),sk));}return m;})();
function inferStorkredsFromKreds(k){return KREDS_TO_STORKREDS.get((k||"").trim())||"";}

/* Parti/farver */
const norm=s=>(s||"").toLowerCase().replace(/[–—-]/g," ").replace(/[().]/g," ").replace(/\s+/g," ").trim();
const PARTY_COLORS={"A":"#e03a3e","B":"#712082","C":"#2e7d32","D":"#0f766e","F":"#e5003d","I":"#00a0e3","O":"#0044aa","V":"#1b5eaa","Ø":"#c8102e","Å":"#3aaa35","Q":"#ff4fa3","K":"#ff9800","Æ":"#666666","M":"#6f42c1"};
const PARTY_LETTERS_BY_NAME={"socialdemokratiet":"A","radikale venstre":"B","det radikale venstre":"B","konservative folkeparti":"C","det konservative folkeparti":"C","nye borgerlige":"D","sf":"F","socialistisk folkeparti":"F","sf - socialistisk folkeparti":"F","sf socialistisk folkeparti":"F","liberal alliance":"I","venstre, danmarks liberale parti":"V","venstre":"V","dansk folkeparti":"O","enhedslisten":"Ø","enhedslisten - de rød-grønne":"Ø","enhedslisten de rød grønne":"Ø","alternativet":"Å","kristendemokraterne":"K","kd - kristendemokraterne":"K","kd kristendemokraterne":"K","moderaterne":"M","danmarksdemokraterne":"Æ","frie grønne":"Q"};
const PARTY_LETTERS_BY_NAME_NORM=Object.fromEntries(Object.entries(PARTY_LETTERS_BY_NAME).map(([k,v])=>[norm(k),v]));
const DEFAULT_BADGE_BG="#e5e7eb", DEFAULT_BADGE_FG="#111827";
const state={rows:[],storkreds:"",kreds:"",valgsted:"",valgstedName:"",activeParty:"",selected:new Map(),selectedKredse:new Set(),csvCache:new Map(),topListMode:"top10",overviewMode:"cand",candidateSortMode:"alpha"};
const el=id=>document.getElementById(id);
const fmt=n=>new Intl.NumberFormat("da-DK").format(n);
const fmtPct=v=>new Intl.NumberFormat("da-DK",{style:"percent",minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
const canon=s=>(s||"").toString().trim();
const escapeHtml=s=>(s||"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const isListestemmer=name=>{const t=canon(name).toLowerCase();return t==="partiliste"||t==="listestemmer"||t==="liste";};
const cleanPollingPlaceName=name=>canon(name).replace(/^\s*\d+\.\s*/,'').trim();
const storkredsSlug=name=>(name||"").toString().split(" ").join("_");
const sortKandidaterAlpha=(a,b)=>{const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn); if(al&&!bl) return 1; if(!al&&bl) return -1; return a.kandidat_navn.localeCompare(b.kandidat_navn,"da");};
function parseVote(v){ if(v==null||v==="") return 0; const n=Number(String(v).trim().replace(/\./g,'').replace(',','.')); return Number.isFinite(n)?n:0; }
const sortKandidaterVotes=(a,b)=>{const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn); if(al&&!bl) return 1; if(!al&&bl) return -1; const dv=(b.total||0)-(a.total||0); if(dv!==0) return dv; return a.kandidat_navn.localeCompare(b.kandidat_navn,"da");};
function badge(letter){ const bg=letter&&PARTY_COLORS[letter]?PARTY_COLORS[letter]:DEFAULT_BADGE_BG; const fg=letter&&PARTY_COLORS[letter]?"#fff":DEFAULT_BADGE_FG; return {style:`background-color:${bg};color:${fg};border-color:${bg}`,text:(letter||" ")};}

/* Loader */
function showLoading(msg="Indlæser…"){ const box=el('loader'); const txt=el('loaderText'); if(txt) txt.textContent=msg||"Indlæser…"; if(box) box.classList.remove('hidden'); el('overviewTop')?.setAttribute('aria-busy','true'); el('storkredsSelect')?.setAttribute('disabled',''); el('kredsSelect')?.setAttribute('disabled',''); el('valgstedSelect')?.setAttribute('disabled',''); }
function hideLoading(){ const box=el('loader'); if(box) box.classList.add('hidden'); el('overviewTop')?.removeAttribute('aria-busy'); el('storkredsSelect')?.removeAttribute('disabled'); if(state.storkreds) el('kredsSelect')?.removeAttribute('disabled'); if(state.kreds&&state.kreds!==KREDS_ALL_VALUE) el('valgstedSelect')?.removeAttribute('disabled'); }

/* Util */
function chunkArray(arr,size){const out=[]; for(let i=0;i<arr.length;i+=size){out.push(arr.slice(i,i+size));} return out;}
function primaryStorkredsForCandidate(candId,rows){ const count=new Map(); for(const r of rows){ if(r.kandidat_id===candId && r.storkreds){ count.set(r.storkreds,(count.get(r.storkreds)||0)+1);} } if(!count.size) return ""; return Array.from(count.entries()).sort((a,b)=>b[1]-a[1])[0][0]; }
function selectCandidateById(candId){ const sample=state.rows.find(r=>r.kandidat_id===candId); if(!sample) return; if(!state.selected.has(candId)){ state.selected.set(candId,{kandidat_id:candId,kandidat_navn:sample.kandidat_navn,parti:sample.parti}); } renderAll(); document.getElementById('compareSection')?.scrollIntoView({behavior:'smooth',block:'start'}); }
function gotoStorkreds(stk,candId=null){ if(!stk) return; const u=new URL(location.href); u.searchParams.set("storkreds",stk); u.searchParams.set("kreds",KREDS_ALL_VALUE); u.searchParams.delete("valgsted"); if(candId) u.searchParams.set("kandidat",candId); else u.searchParams.delete("kandidat"); history.replaceState({}, "", u); el("storkredsSelect").value=stk; populateKredse(stk); state.storkreds=stk; state.kreds=KREDS_ALL_VALUE; state.valgsted=""; state.valgstedName=""; resetValgstedDropdown(); loadStorkredsData(stk).then(()=>{ if(candId) selectCandidateById(candId); else { renderAll(); renderContextBar(); } }); }

/* Kandidatsøg dropdown (på siden) */
const fold=s=>(s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
function buildCandidateList(rows){ const m=new Map(); for(const r of rows){ if(isListestemmer(r.kandidat_navn)) continue; if(!m.has(r.kandidat_id)){ m.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti}); } } return Array.from(m.values()); }
function rankCandidates(cands,q){ const Q=fold(q); if(!Q) return []; return cands.map(c=>{ const f=fold(c.kandidat_navn); let score=-Infinity; if(f.startsWith(Q)) score=300-(f.length-Q.length); else{ const ws=f.split(/\s+/).some(w=>w.startsWith(Q)); if(ws) score=200-f.indexOf(Q); else if(f.includes(Q)) score=100-f.indexOf(Q); } const pf=fold(c.parti); if(pf.startsWith(Q)||pf.includes("("+Q+")")) score+=20; return {...c,_score:score,_name:c.kandidat_navn}; }).filter(x=>x._score>-Infinity).sort((a,b)=>b._score-a._score||a._name.localeCompare(b._name,"da")).slice(0,15); }

/* INIT */
window.addEventListener("DOMContentLoaded", async ()=>{
  initStorkredsDropdown(); initCandidateSearch();

  el("ftYearSelect")?.addEventListener("change",()=>{ const url=el("ftYearSelect").value; if(url) window.location.href=url; });

  ["btnModeCand","btnModeParty","btnTop10","btnAll","btnSortAlpha","btnSortVotes"].forEach(id=>{});
  el("btnModeCand").onclick=()=>{ if(state.overviewMode!=="cand"){ state.overviewMode="cand"; updateModeToggleUI(); updateTopButtonsForScope(); updateTopToggleUI(); renderOverview(); } };
  el("btnModeParty").onclick=()=>{ if(state.overviewMode!=="party"){ state.overviewMode="party"; updateModeToggleUI(); updateTopButtonsForScope(); updateTopToggleUI(); renderOverview(); } };
  el("btnTop10").onclick=()=>{ state.topListMode="top10"; updateTopButtonsForScope(); updateTopToggleUI(); renderOverview(); };
  el("btnAll").onclick=()=>{ state.topListMode="all"; updateTopButtonsForScope(); updateTopToggleUI(); renderOverview(); };
  el("btnSortAlpha").onclick=()=>{ state.candidateSortMode="alpha"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); };
  el("btnSortVotes").onclick=()=>{ state.candidateSortMode="votes"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); };

  const p=new URLSearchParams(location.search);
  const s=p.get("storkreds");
  const k=p.get("kreds");
  // === accepter alias: kandidat | cand | cid ===
  const candParam = p.get("kandidat") || p.get("cand") || p.get("cid");
  const ps=p.get("valgsted");

  if(s && STORKREDSE.includes(s)){
    el("storkredsSelect").value=s; state.storkreds=s; populateKredse(s); await loadStorkredsData(s);
    if(k===KREDS_ALL_VALUE){ el("kredsSelect").value=KREDS_ALL_VALUE; state.kreds=KREDS_ALL_VALUE; resetValgstedDropdown(); }
    else if(k && (KREDS_BY_STORKREDS[s]||[]).includes(k)){ el("kredsSelect").value=k; state.kreds=k; await loadKredsData(s,k); populateValgstederFromRows(); if(ps){ const found=currentValgsteder().find(v=>v.id===ps); if(found){ el("valgstedSelect").value=ps; state.valgsted=ps; state.valgstedName=found.navn; } } }
    if(candParam) selectCandidateById(candParam);
  }else{
    el("storkredsSelect").value=DK_VALUE; state.storkreds=""; state.kreds=""; state.valgsted=""; state.valgstedName=""; resetValgstedDropdown(); await loadNationalData();
    // AUTO-GOTO hvis kun kandidat-id gives
    if(candParam){ const stk=primaryStorkredsForCandidate(candParam,state.rows); if(stk){ gotoStorkreds(stk,candParam); return; } }
    renderContextBar();
  }

  el("btnClearAll")?.addEventListener('click',()=>{ state.selected.clear(); renderAll(); });
  document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });
  setupAddKredsUI(); renderContextBar(); updateModeToggleUI(); updateTopButtonsForScope(); updateTopToggleUI(); updateCandSortToggleUI();
});

/* UI toggles */
function updateTopButtonsForScope(){ const isDK=!state.storkreds; const btnAll=el("btnAll"); if(!btnAll) return; btnAll.textContent = state.overviewMode==="party" ? "Alle partier" : (isDK ? "Top 50" : "Alle kandidater"); }
function updateTopToggleUI(){ const a=el("btnTop10"),b=el("btnAll"); if(state.topListMode==="top10"){a.classList.add("active"); b.classList.remove("active");} else {b.classList.add("active"); a.classList.remove("active");} }
function updateCandSortToggleUI(){ const a=el("btnSortAlpha"),b=el("btnSortVotes"); if(state.candidateSortMode==="alpha"){a.classList.add("active"); b.classList.remove("active");} else {b.classList.add("active"); a.classList.remove("active");} }
function updateModeToggleUI(){ const a=el("btnModeCand"),b=el("btnModeParty"); const isParty=state.overviewMode==="party"; a?.classList.toggle("active",!isParty); b?.classList.toggle("active",isParty); }

/* Dropdowns + dataindlæsning – (samme som før, uændret i logik) */
function initStorkredsDropdown(){ const ssel=el("storkredsSelect"); ssel.innerHTML=`<option value="">Vælg storkreds…</option><option value="${DK_VALUE}">Hele Danmark</option>`+STORKREDSE.map(s=>`<option value="${s}">${s}</option>`).join(""); ssel.onchange=async()=>{ const v=ssel.value; state.activeParty=""; state.kreds=""; state.valgsted=""; state.valgstedName=""; state.selectedKredse.clear(); clearAll(); renderExtraKredsChips(); updateAddKredsUIState(); resetValgstedDropdown(); const u=new URL(location.href); if(v===DK_VALUE||!v){ u.searchParams.delete("storkreds"); u.searchParams.delete("kreds"); u.searchParams.delete("valgsted"); u.searchParams.delete("kandidat"); history.replaceState({}, "", u); el("kredsSelect").disabled=true; el("kredsSelect").innerHTML=`<option value="">(Vælg storkreds for at vælge kreds)</option>`; state.storkreds=""; await loadNationalData(); } else { state.storkreds=v; populateKredse(v); u.searchParams.set("storkreds",v); u.searchParams.delete("kreds"); u.searchParams.delete("valgsted"); u.searchParams.delete("kandidat"); history.replaceState({}, "", u); await loadStorkredsData(v); } renderContextBar(); updateTopButtonsForScope(); renderOverview(); }; el("kredsSelect").disabled=true; }
function populateKredse(stk){ const ks=KREDS_BY_STORKREDS[stk]||[]; const ksel=el("kredsSelect"); if(ks.length){ ksel.disabled=false; const allOpt=`<option value="${KREDS_ALL_VALUE}">Alle kredse i storkredsen</option>`; ksel.innerHTML=`<option value="">Vælg kreds…</option>${allOpt}`+ks.map(k=>`<option value="${k}">${k}</option>`).join(""); ksel.onchange=async()=>{ const v=ksel.value; state.activeParty=""; clearAll(); state.selectedKredse.clear(); renderExtraKredsChips(); state.valgsted=""; state.valgstedName=""; resetValgstedDropdown(); const u=new URL(location.href); u.searchParams.set("storkreds",stk); u.searchParams.delete("parti"); u.searchParams.delete("kandidat"); u.searchParams.delete("valgsted"); if(v===KREDS_ALL_VALUE){ state.kreds=KREDS_ALL_VALUE; u.searchParams.set("kreds",KREDS_ALL_VALUE); history.replaceState({}, "", u); await loadStorkredsData(stk); } else if(v){ state.kreds=v; u.searchParams.set("kreds",v); history.replaceState({}, "", u); await loadKredsData(stk,v); populateValgstederFromRows(); } updateAddKredsUIState(); renderContextBar(); }; } else { ksel.disabled=true; ksel.innerHTML=`<option value="">(Ingen kredsvalg – viser hele storkredsen)</option>`; } }
function resetValgstedDropdown(){ const psSel=el("valgstedSelect"); psSel.disabled=true; psSel.innerHTML=`<option value="">(Vælg kreds først)</option>`; }
function currentValgsteder(){ const m=new Map(); for(const r of state.rows){ if(r.valgsted_id){ const id=r.valgsted_id; if(!m.has(id)) m.set(id,{id,navn:cleanPollingPlaceName(r.valgsted_navn)}); } } return Array.from(m.values()).sort((a,b)=>a.navn.localeCompare(b.navn,"da")); }
function populateValgstederFromRows(){ const psSel=el("valgstedSelect"); if(!state.kreds||state.kreds===KREDS_ALL_VALUE){ resetValgstedDropdown(); return; } const list=currentValgsteder(); const allOpt=`<option value="${VALGSTED_ALL_VALUE}">Alle valgsteder i kredsen</option>`; psSel.disabled=false; psSel.innerHTML=`<option value="">Vælg valgsted…</option>${allOpt}`+list.map(p=>`<option value="${p.id}">${escapeHtml(p.navn)}</option>`).join(""); psSel.onchange=()=>{ const v=psSel.value; state.valgsted=(v&&v!==VALGSTED_ALL_VALUE)?v:""; const found=currentValgsteder().find(x=>x.id===state.valgsted); state.valgstedName=found?found.navn:""; const u=new URL(location.href); if(state.valgsted){ u.searchParams.set("valgsted",state.valgsted);} else { u.searchParams.delete("valgsted"); } history.replaceState({}, "", u); updateAddKredsUIState(); renderContextBar(); renderAll(); }; }
function updateAddKredsUIState(){ const btn=el("btnAddKreds"); const disable=!state.storkreds || state.kreds===KREDS_ALL_VALUE || !state.kreds || !!state.valgsted; if(btn){ btn.disabled=disable; btn.title=disable?"Tilføjelse af kredse er ikke tilgængelig her.":""; } }
function clearAll(){ state.rows=[]; state.selected.clear(); const btn=el("partyButton"), btnc=el("partyButtonContent"); btn.disabled=true; btn.setAttribute('aria-expanded','false'); btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg kreds først…</span>`; el("partyMenu").innerHTML=""; el("partyDetailHeader").textContent="Vælg et parti i drop-down menuen."; el("candidateColLeft").innerHTML=""; el("candidateColRight").innerHTML=""; el("storkredstitel").textContent=""; renderAll(); }

/* National / storkreds / kreds indlæsning */
async function loadNationalData(){ showLoading("Indlæser Danmark…"); try{ el("error").textContent=""; el("storkredstitel").textContent=`(Danmark)`; state.valgsted=""; state.valgstedName=""; resetValgstedDropdown(); const candidates=[`${BASE_PATH}Danmark_allepartier.csv`,`${BASE_PATH}Danmark.csv`]; for(const url of candidates){ try{ const text=await fetchCsvText(url); const rows=parseCsvTextToRows(text,null); state.rows=rows; afterDataLoaded(); return; }catch(_){}} const allRows=[]; const tasks=STORKREDSE.map(sk=>loadRowsForStorkreds(sk).catch(()=>[])); for(const batch of chunkArray(tasks,4)){ const settled=await Promise.allSettled(batch); for(const r of settled){ if(r.status==="fulfilled"&&Array.isArray(r.value)) allRows.push(...r.value); } } state.rows=allRows; afterDataLoaded(); if(!allRows.length){ el("error").textContent=`Kunne ikke indlæse landsdata (ingen filer fundet).`; } } finally { hideLoading(); } }
async function loadKredsData(stk,k){ showLoading("Indlæser…"); try{ el("error").textContent=""; el("storkredstitel").textContent=k?`(${stk} – ${k})`:`(${stk})`; let allRows=state.csvCache.get(`${stk}::__ALL__`); if(!allRows||!allRows.length){ allRows=await loadRowsForStorkreds(stk); } const filtered=allRows.filter(r=>r.kreds===k); if(!filtered.length){ el("error").textContent=`Kunne ikke finde data for ${stk} / ${k}.`; } state.rows=filtered; afterDataLoaded(); } finally { hideLoading(); } }
async function loadStorkredsData(stk){ showLoading("Indlæser…"); try{ el("error").textContent=""; el("storkredstitel").textContent=`(${stk})`; state.valgsted=""; state.valgstedName=""; resetValgstedDropdown(); const rows=await loadRowsForStorkreds(stk); state.rows=rows; state.csvCache.set(`${stk}::__ALL__`,rows.slice()); afterDataLoaded(); } catch(e){ el("error").textContent=`Kunne ikke finde data for ${stk}.`; } finally { hideLoading(); } }

/* CSV helpers */
function parseCsvTextToRows(text,kOverride){ const res=Papa.parse(text,{header:true,skipEmptyLines:true,transformHeader:h=>canon(h.toLowerCase())}); return res.data.map(r=>{ const kandidatNavnRaw=r.kandidat_navn||r["navn"]||r.kandidat; let kandidat_navn=canon(kandidatNavnRaw); const nl=kandidat_navn.toLowerCase(); if(["partiliste","listestemmer","liste"].includes(nl)) kandidat_navn="Partiliste"; const parti=canon(r.parti||r["partinavn"]); const rawLetter=r.parti_bogstav||r.bogstav||r.parti_kode||r['parti (bogstav)']||r.listebogstav||r["partibogstav"]; const L=canon(rawLetter).toUpperCase(); const parti_letter=/^[A-ZÆØÅ]$/.test(L)?L:""; const kredsnavn=kOverride||canon(r.kredsnavn||r.kreds||r["opstillingskreds"]||""); const storkredsnavn=canon(r.storkreds||"")||inferStorkredsFromKreds(kredsnavn); const rawValgsted=r.valgsted_navn||r.afstemningssted||r.sted_navn||r["afstemningsområde"]||""; const kandidat_id=`${parti.toLowerCase()}::${kandidat_navn.toLowerCase()}`; return { storkreds:storkredsnavn, kreds:kredsnavn, valgsted_id:canon(r.valgsted_id||r.afstemningssted_id||r.sted_id||`${cleanPollingPlaceName(rawValgsted)}`), valgsted_navn:cleanPollingPlaceName(rawValgsted), kandidat_id, kandidat_navn, parti, parti_letter, stemmer:parseVote(r.stemmer ?? r["stemmetal"]) }; }); }
async function fetchCsvText(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("404"); return await r.text(); }
async function loadRowsForStorkreds(stk){ const keyAll=`${stk}::__ALL__`; if(state.csvCache.has(keyAll)) return state.csvCache.get(keyAll); const slug=encodeURIComponent(storkredsSlug(stk)); const candidates=[`${BASE_PATH}${slug}_allepartier.csv`,`${BASE_PATH}${slug}.csv`]; for(const url of candidates){ try{ const text=await fetchCsvText(url); const rows=parseCsvTextToRows(text,null); state.csvCache.set(keyAll,rows); return rows; }catch(e){} } throw new Error(`Ingen data for ${stk}`); }
async function loadRowsForKreds(stk,k){ const key=`${stk}::${k}`; if(state.csvCache.has(key)) return state.csvCache.get(key); let all=state.csvCache.get(`${stk}::__ALL__`); if(!all){ all=await loadRowsForStorkreds(stk); } const rows=all.filter(r=>r.kreds===k); state.csvCache.set(key,rows); return rows; }
function afterDataLoaded(){ state.activeParty=""; renderPartyCombobox(); renderAll(); updateAddKredsUIState(); renderContextBar(); document.getElementById('candidateMenu')?.classList.add('hidden'); if(state.kreds && state.kreds!==KREDS_ALL_VALUE) populateValgstederFromRows(); }

/* Brev – resten af render/overview/party/tabel er identisk med din nuværende version … */
function detectPartyLetter(parti,rowsForParti){ for(const r of rowsForParti){ const L=(r.parti_letter||"").toUpperCase(); if(L && PARTY_COLORS[L]) return L; } const keyNorm=norm(parti), mapped=PARTY_LETTERS_BY_NAME_NORM[keyNorm]; if(mapped && PARTY_COLORS[mapped]) return mapped; if(keyNorm.includes("socialistisk folkeparti")||keyNorm==="sf") return "F"; if(keyNorm.includes("danmarksdemokraterne")) return "Æ"; if(keyNorm.includes("frie grønne")) return "Q"; return null; }
function getActiveRows(){ let rows; if(!state.selectedKredse||state.selectedKredse.size===0) rows=state.rows; else{ const combined=[...state.rows]; state.selectedKredse.forEach(k=>{ if(state.kreds && k===state.kreds) return; const extra=state.csvCache.get(`${state.storkreds}::${k}`)||[]; combined.push(...extra); }); rows=combined; } if(state.valgsted){ rows=rows.filter(r=>r.valgsted_id===state.valgsted); } return rows; }
function getAllowedStorkredseForSelection(){ const sel=Array.from(state.selected.values()); if(sel.length===0) return null; const scopes=getCandidateScopes(); let allowed=null; for(const c of sel){ const sc=scopes.get(c.kandidat_id); if(!sc) continue; allowed=(allowed===null)?new Set(sc.storkredse):new Set([...allowed].filter(x=>sc.storkredse.has(x))); } return allowed||null; }
function getCandidateScopes(){ const rows=getActiveRows(); const m=new Map(); for(const r of rows){ const id=r.kandidat_id; if(!m.has(id)) m.set(id,{storkredse:new Set(),kredse:new Set()}); if(r.storkreds) m.get(id).storkredse.add(r.storkreds); if(r.kreds) m.get(id).kredse.add(r.kreds); } return m; }
function canAddCandidate(candidateId){ const sel=Array.from(state.selected.values()); if(sel.length===0) return {ok:true}; const scopes=getCandidateScopes(); const newScope=scopes.get(candidateId); if(!newScope) return {ok:false,reason:"Ingen data fundet for kandidaten i nuværende visning."}; const matchesAll=sel.every(c=>{ const sc=scopes.get(c.kandidat_id); if(!sc) return false; return [...sc.storkredse].some(sk=>newScope.storkredse.has(sk)); }); if(!matchesAll) return {ok:false,reason:`Kandidater til sammenligning skal være fra samme storkreds`}; return {ok:true}; }
function showError(msg){ el("error").textContent=msg||""; if(msg){ setTimeout(()=>{ if(el("error").textContent===msg) el("error").textContent=""; },6000); } }

/* … Toplister, party-combobox, renderPartyDetail, renderAll, tabel mv. – uændret fra din version.
   (For pladsen: behold din nuværende implementering – ovenfor er alle ændringerne, der får søg-rute til at lande korrekt.) */

</script>

<footer class="mt-10 border-t bg-gray-100">
  <div class="mx-auto max-w-6xl px-4 py-6 md:py-8 flex flex-col md:flex-row items-center justify-between gap-3 md:gap-6 text-sm md:text-base text-gray-700">
    <a href="mailto:hej@valgbar.dk" class="font-medium hover:text-gray-900">hej@valgbar.dk</a>
    <p class="text-center">Data stammer fra KMDValg, Danmarks Statistik og valg.dk</p>
    <a href="/om-valgbar/" class="font-medium underline hover:text-gray-900">Om Valgbar</a>
  </div>
</footer>
</body>
</html>
