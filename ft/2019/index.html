<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Folketingsvalg 2019</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .vb-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(15,23,42,.04)}
    .vb-row{transition:background .15s ease}
    .vb-row:hover{background:#f8fafc}
    .vb-deeplink-highlight{outline:2px solid #0f766e;box-shadow:0 0 0 4px rgba(15,118,110,.15);border-radius:10px;transition:outline-color .25s ease,box-shadow .25s ease}
    .vb-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:999px;border:1px solid #d1d5db;background:#e5e7eb;color:#111827;font-weight:700}
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <a href="/" class="flex items-center gap-2">
      <img src="/Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
    </a>
    <div class="text-right">
      <div class="text-xs text-slate-600 font-semibold uppercase tracking-wide">Folketingsvalg</div>
      <div class="text-lg font-semibold">2019 – kandidater</div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
  <!-- FILTRE (valgfrit) -->
  <section class="vb-card p-4 md:p-5">
    <div class="flex flex-col md:flex-row items-start md:items-end gap-3">
      <div class="flex-1">
        <label class="text-xs font-medium text-slate-600">Søg kandidat</label>
        <input type="text" id="quickFilter" class="w-full border rounded-md px-3 py-2 text-sm" placeholder="Filtrér lokalt på denne side…" />
      </div>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-2 w-full md:w-auto">
        <select id="filterStorkreds" class="border rounded-md px-2 py-2 text-sm">
          <option value="">Alle storkredse</option>
        </select>
        <select id="filterParty" class="border rounded-md px-2 py-2 text-sm">
          <option value="">Alle partier</option>
          <option value="A">A – Socialdemokratiet</option>
          <option value="V">V – Venstre</option>
          <option value="Ø">Ø – Enhedslisten</option>
          <option value="C">C – Konservative</option>
          <option value="B">B – Radikale</option>
          <option value="F">F – SF</option>
          <option value="I">I – Liberal Alliance</option>
          <option value="O">O – Dansk Folkeparti</option>
          <option value="K">K – Kristendemokraterne</option>
          <option value="Å">Å – Alternativet</option>
        </select>
        <button id="btnClear" class="border rounded-md px-3 py-2 text-sm">Nulstil filtre</button>
      </div>
    </div>
  </section>

  <!-- KANDIDATLISTE -->
  <section class="vb-card p-0 overflow-hidden">
    <div class="border-b px-4 py-3 flex items-center justify-between">
      <h2 class="font-semibold">Kandidater</h2>
      <div id="count" class="text-sm text-slate-600"></div>
    </div>

    <table class="min-w-full">
      <thead class="bg-slate-100 text-slate-700 text-xs uppercase">
        <tr>
          <th class="text-left px-3 py-2">Parti</th>
          <th class="text-left px-3 py-2">Navn</th>
          <th class="text-left px-3 py-2">Storkreds</th>
          <th class="text-right px-3 py-2">Stemmer</th>
          <th class="px-3 py-2"></th>
        </tr>
      </thead>
      <tbody id="candRows" class="divide-y divide-slate-100 text-sm bg-white">
        <!-- EKSEMPEL-RÆKKER — erstats med din egen server-renderede liste -->
        <tr class="vb-row"
            data-candidate-id="A_Mette_Frederiksen"
            data-name="Mette Frederiksen"
            data-party-short="A"
            data-party="Socialdemokratiet"
            data-storkreds="Nordre Storkreds"
            data-kreds="Ballerupkredsen">
          <td class="px-3 py-2"><span class="vb-badge" style="background:#e03a3e;color:#fff;border-color:#e03a3e">A</span></td>
          <td class="px-3 py-2 font-medium">Mette Frederiksen</td>
          <td class="px-3 py-2">Nordre Storkreds</td>
          <td class="px-3 py-2 text-right">24.486</td>
          <td class="px-3 py-2"><button class="text-sky-700 hover:underline" data-action="open-candidate">Åbn</button></td>
        </tr>

        <tr class="vb-row"
            data-candidate-id="V_Eksempel_Person"
            data-name="Eksempel Person"
            data-party-short="V"
            data-party="Venstre, Danmarks Liberale Parti"
            data-storkreds="Københavns Omegns Storkreds"
            data-kreds="Brøndbykredsen">
          <td class="px-3 py-2"><span class="vb-badge" style="background:#1b5eaa;color:#fff;border-color:#1b5eaa">V</span></td>
          <td class="px-3 py-2 font-medium">Eksempel Person</td>
          <td class="px-3 py-2">Københavns Omegns Storkreds</td>
          <td class="px-3 py-2 text-right">5.432</td>
          <td class="px-3 py-2"><button class="text-sky-700 hover:underline" data-action="open-candidate">Åbn</button></td>
        </tr>
        <!-- /EKSEMPEL-RÆKKER -->
      </tbody>
    </table>

    <div id="candidateDetail" class="hidden border-t p-4"></div>
  </section>
</main>

<footer class="mt-10 border-t bg-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-6 text-xs text-slate-600 flex items-center justify-between">
    <span>Valgbar – FT 2019</span>
    <span>Data: KMDValg, Danmarks Statistik, valg.dk</span>
  </div>
</footer>

<script>
/* ===== Lokalt filter (valgfrit) ===== */
(function setupLocalFilter(){
  const input = document.getElementById('quickFilter');
  const rows  = () => Array.from(document.querySelectorAll('#candRows tr'));
  const count = document.getElementById('count');

  function apply(){
    const q = (input?.value || '').trim().toLowerCase();
    let visible = 0;
    rows().forEach(r=>{
      const txt = r.textContent.toLowerCase();
      const show = !q || txt.includes(q);
      r.classList.toggle('hidden', !show);
      if (show) visible++;
    });
    if (count) count.textContent = visible + ' kandidater vist';
  }

  input?.addEventListener('input', apply);
  document.getElementById('btnClear')?.addEventListener('click', ()=>{
    if (input) input.value = '';
    apply();
  });
  apply();
})();

/* ==============================
   Robust deep-link fra forsiden
   ============================== */
(function deepLink(){
  const TABLE_SELECTOR = '#candRows tr';
  const OPEN_SEL = '[data-action="open-candidate"], a, button';

  const qs = new URLSearchParams(location.search);
  let cid   = (qs.get('cid')   || '').trim();
  let cand  = (qs.get('cand')  || '').trim();   // A::Navn eller bare Navn
  let party = (qs.get('party') || '').trim();   // bogstav eller navn

  if (!cid && !cand) return; // intet at gøre

  function norm(s){
    return (s||'').toString().normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .toLowerCase().replace(/\s+/g,' ').trim();
  }

  function getRowMeta(row){
    // 1) data-attrs hvis de findes
    const meta = {
      id: row.getAttribute('data-candidate-id') || '',
      name: row.getAttribute('data-name') || '',
      partyShort: row.getAttribute('data-party-short') || '',
      party: row.getAttribute('data-party') || ''
    };

    // 2) fald tilbage: læs fra celler
    if (!meta.name) {
      // navn = første/anden tekstcelle
      const tds = row.querySelectorAll('td');
      if (tds[1]) meta.name = tds[1].textContent.trim();
      else meta.name = row.textContent.trim();
    }
    if (!meta.partyShort || !meta.party) {
      const badge = row.querySelector('.vb-badge');
      const firstCell = row.querySelector('td');
      const raw = (badge?.textContent || firstCell?.textContent || '').trim();
      const m = raw.match(/[A-ZÆØÅ]/);
      if (!meta.partyShort && m) meta.partyShort = m[0];
      if (!meta.party && firstCell) {
        // forsøg at finde partinavn i første celle
        const txt = firstCell.textContent.replace(meta.partyShort,'').trim();
        if (txt.length > 1) meta.party = txt;
      }
    }
    return meta;
  }

  function activateRow(row){
    row.scrollIntoView({ behavior:'smooth', block:'center' });
    row.classList.add('vb-deeplink-highlight');
    setTimeout(()=> row.classList.remove('vb-deeplink-highlight'), 2500);

    // klik på “Åbn” hvis muligt
    const open = row.querySelector(OPEN_SEL);
    if (open) { open.click(); return; }
    if (typeof row.click === 'function') row.click();
  }

  function tryFind(){
    const rows = Array.from(document.querySelectorAll(TABLE_SELECTOR));
    if (!rows.length) return null;

    // a) direkte id
    if (cid) {
      const hit = rows.find(r => (r.getAttribute('data-candidate-id') || '') === cid);
      if (hit) return hit;
    }

    // b) cand kan være "A::Navn"
    let wantParty = party;
    let wantName  = cand;
    if (wantName.includes('::')) {
      const parts = wantName.split('::');
      wantParty = wantParty || parts[0];
      wantName  = parts.slice(1).join('::');
    }

    const nName = norm(wantName);
    const nParty = norm(wantParty);

    // c) navn + (valgfri) parti
    if (nName) {
      for (const r of rows) {
        const meta = getRowMeta(r);
        if (norm(meta.name) !== nName) continue;
        if (!nParty) return r;

        const ps = norm(meta.partyShort);
        const pn = norm(meta.party);
        if (nParty === ps || nParty === pn) return r;
      }
    }

    return null;
  }

  function findAndActivate(withRetriesMs=2000){
    const start = performance.now();

    function tick(){
      const row = tryFind();
      if (row) { activateRow(row); return; }

      // hvis tabellen ikke er klar endnu, prøv igen lidt
      if (performance.now() - start < withRetriesMs) {
        requestAnimationFrame(tick);
      }
    }
    tick();

    // og lyt også på DOM-ændringer (hvis du hydrerer/render senere)
    const obs = new MutationObserver(()=>{
      const row = tryFind();
      if (row) { activateRow(row); obs.disconnect(); }
    });
    obs.observe(document.body, { childList:true, subtree:true });
    setTimeout(()=>obs.disconnect(), withRetriesMs);
  }

  document.addEventListener('DOMContentLoaded', ()=> findAndActivate(2500));
})();

/* Demo “Åbn” – vis detalje under tabel (tilpas til dit UI) */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-action="open-candidate"]');
  if(!btn) return;
  const row = btn.closest('tr');
  const detail = document.getElementById('candidateDetail');

  const name  = row.getAttribute('data-name') || row.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
  const cid   = row.getAttribute('data-candidate-id') || '';
  const party = row.getAttribute('data-party') || row.getAttribute('data-party-short') || '';
  const stork = row.getAttribute('data-storkreds') || row.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
  const kreds = row.getAttribute('data-kreds') || '';

  detail.classList.remove('hidden');
  detail.innerHTML = `
    <div class="text-sm">
      <div class="font-semibold text-slate-800 mb-1">${name}</div>
      <div class="text-slate-600">Parti: ${party || '—'} · ID: <code>${cid || '—'}</code></div>
      <div class="text-slate-600">Storkreds: ${stork || '—'} · Kreds: ${kreds || '—'}</div>
    </div>`;
  detail.scrollIntoView({ behavior:'smooth', block:'nearest' });
});
</script>
</body>
</html>
