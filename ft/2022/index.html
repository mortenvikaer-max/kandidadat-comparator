function renderPsTable(psList, sel){
  const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
  if(!sel.length){
    thead.innerHTML=`<tr><th class="text-left py-2 pr-3">Valgsted</th><th class="text-left py-2 pr-3">Kreds</th></tr>`;
    tbody.innerHTML="";
    tfoot.innerHTML="";
    return;
  }

  const allowedStk = getAllowedStorkredseForSelection();
  const filteredPs = allowedStk ? psList.filter(ps => allowedStk.has(ps.storkreds)) : psList;

  const scopes = getCandidateScopes();
  const rowsAll = getActiveRows();

  // Skal vi vise "Samlet – [kreds]" rækker?
  const showPerKredsTotals = !!state.storkreds && state.kreds === KREDS_ALL_VALUE;

  // Total gyldige stemmer i hele scope (til den nederste Samlet-række)
  const totalScopedValid = computeTotalValidVotesScoped();

  // Total gyldige stemmer pr. kreds (til procent i "Samlet – [kreds]")
  const totalValidByKreds = new Map();
  if (showPerKredsTotals) {
    for (const r of rowsAll) {
      if (allowedStk && !allowedStk.has(r.storkreds)) continue;
      const k = r.kreds || "";
      totalValidByKreds.set(k, (totalValidByKreds.get(k) || 0) + (r.stemmer || 0));
    }
  }

  // Header
  const header = sel.map(s=>{
    const stat = getPartyStats().find(x=>x.parti===s.parti);
    const bd = badge(stat?.letter || null);
    return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
      <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
      <span>${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</span></div></th>`;
  }).join("");
  thead.innerHTML=`<tr class="text-left border-b">
    <th class="py-2 pr-3">Valgsted</th>
    <th class="py-2 pr-3">Kreds</th>
    ${header}
  </tr>`;

  const colspan = 2 + sel.length;
  const rowsHtml = [];

  // Hjælper til at lave "Samlet – [kreds]" række
  function renderKredsSubtotalRow(kredsName, rowCount, candTotalsMap){
    const totalValidKreds = totalValidByKreds.get(kredsName) || 0;
    return `<tr class="border-t bg-gray-50">
      <td class="py-2 pr-3 font-medium">Samlet – ${escapeHtml(kredsName || "")}</td>
      <td class="py-2 pr-3 text-sm text-gray-500">(${fmt(rowCount)} valgsteder)</td>
      ${sel.map(s=>{
        const tot = candTotalsMap.get(s.kandidat_id) || 0;
        const share = totalValidKreds > 0 ? tot / totalValidKreds : null;
        return `<td class="py-2 pr-3 tabular-nums font-medium">
          ${fmt(tot)}
          ${share!==null ? `<div class="text-xs text-gray-500">${fmtPct(share)}</div>` : ""}
        </td>`;
      }).join("")}
    </tr>`;
  }

  let currentKreds = null;
  let kredRowCount = 0;
  let kredCandTotals = new Map();

  // Body-rows
  for(const ps of filteredPs){
    if(currentKreds !== null && ps.kreds !== currentKreds){
      // Luk den gamle kreds med en "Samlet – [kreds]" række (kun på storkreds-niveau)
      if(showPerKredsTotals){
        rowsHtml.push(renderKredsSubtotalRow(currentKreds, kredRowCount, kredCandTotals));
      }
      // Vis visuel separator mellem kredse
      rowsHtml.push(`<tr><td class="kreds-divider" colspan="${colspan}"></td></tr>`);
      kredRowCount = 0;
      kredCandTotals = new Map();
    }

    if(currentKreds === null || ps.kreds !== currentKreds){
      currentKreds = ps.kreds;
    }

    // Opdater totals for den aktuelle kreds
    kredRowCount++;
    sel.forEach(s=>{
      const sc = scopes.get(s.kandidat_id);
      const allowed = sc && ps.storkreds && sc.storkredse.has(ps.storkreds);
      const val = allowed ? (ps[s.kandidat_id] || 0) : 0;
      kredCandTotals.set(s.kandidat_id, (kredCandTotals.get(s.kandidat_id) || 0) + (val || 0));
    });

    // Selve valgsteds-rækken
    rowsHtml.push(
      `<tr class="border-b last:border-0">
        <td class="py-2 pr-3 font-medium">${escapeHtml(ps.navn)}</td>
        <td class="py-2 pr-3">${escapeHtml(ps.kreds || "")}</td>
        ${sel.map(s=>{
          const sc=scopes.get(s.kandidat_id);
          const allowed = sc && ps.storkreds && sc.storkredse.has(ps.storkreds);
          const val = allowed ? (ps[s.kandidat_id]||0) : null;
          return `<td class="py-2 pr-3 tabular-nums">${val===null ? '<span class="cell-na">—</span>' : fmt(val)}</td>`;
        }).join("")}
      </tr>`
    );
  }

  // Sidste kreds' "Samlet – [kreds]" række
  if(showPerKredsTotals && currentKreds !== null){
    rowsHtml.push(renderKredsSubtotalRow(currentKreds, kredRowCount, kredCandTotals));
  }

  tbody.innerHTML = rowsHtml.join("");

  // Nederste "Samlet" for hele scope (uændret)
  const totals=computeTotalsByCandidateScoped();

  tfoot.innerHTML=`<tr class="border-t">
    <th class="py-2 pr-3 text-left">Samlet</th>
    <th class="py-2 pr-3 text-left text-gray-500">(${fmt(filteredPs.length)} rækker)</th>
    ${sel.map(s=>{
      const total = totals.get(s.kandidat_id)||0;
      const share = totalScopedValid > 0 ? total / totalScopedValid : null;
      const shareLabel = share !== null ? fmtPct(share) : null;
      return `<td class="py-2 pr-3 tabular-nums font-medium">
        ${fmt(total)}
        ${shareLabel ? `<div class="text-xs text-gray-500">${shareLabel}</div>` : ""}
      </td>`;
    }).join("")}
  </tr>`;
}
