<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Valgbar – Folketingsvalg 2005</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{ --vb-navy:#234a5a; --vb-navy-2:#1b3d4d; }
.vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
.vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
.vb-btn:disabled{ opacity:.5; cursor:not-allowed; }

.vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
.vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }
.vb-tabbox.small{ flex:0 0 auto; padding:.4rem .8rem; font-size:.9rem; }

.vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff;
display:flex; align-items:center; justify-content:space-between; }
.vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
.vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
.vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center;
border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }
.vb-menu{ position:absolute; z-index:50; margin-top:.25rem; width:max-content; min-width:16rem;
max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb;
border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
.vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
.vb-option span{ white-space:normal; word-break:break-word; }
.vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }

.table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{ position:sticky; left:0; background:#fff; }

.vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }

.kreds-divider { padding:0; line-height:0; height:0; border-top:3px solid #111827; }

.rank-pill{ width:28px; height:28px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center;
font-weight:700; border:1px solid #e5e7eb; background:#f9fafb; }
.top10-item{ display:flex; align-items:center; gap:.75rem; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:12px; cursor:pointer; }
.top10-item:hover{ background:#f9fafb; }
.top10-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; }
@media (min-width:768px){ .top10-grid{ grid-template-columns:1fr 1fr; } }

.context-bar{ display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; }
.crumb{ color:#374151; text-decoration:underline; cursor:pointer; }
.crumb[aria-disabled="true"]{ color:#374151; text-decoration:none; cursor:default; }
.crumb-strong{ background:#111827; color:#fff; border-radius:9999px; padding:.15rem .6rem; font-weight:600; }
.sep{ color:#9ca3af; }

.cell-na{ color:#9ca3af; }

/* Loader */
.loader-wrap{ display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#6b7280; }
.progress{ position:relative; height:6px; background:#f3f4f6; border-radius:9999px; overflow:hidden; }
.progress::after{
  content:""; position:absolute; inset:0; transform:translateX(-100%);
  background:linear-gradient(90deg, rgba(0,0,0,0) 0%, #c7d2fe 50%, rgba(0,0,0,0) 100%);
  animation:loadbar 1.2s infinite;
}
@keyframes loadbar{
  0%{ transform:translateX(-100%); }
  50%{ transform:translateX(0%); }
  100%{ transform:translateX(100%); }
}
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="../../" class="flex items-center gap-3">
      <img src="../../Valgbar-transparent3.png" alt="Valgbar" class="h-32 w-auto" />
    </a>
  </div>
  <div class="mx-auto max-w-6xl px-4 pb-2">
    <div id="error" class="text-sm text-red-200"></div>
  </div>
</header>

<main class="mx-auto max-w-6xl p-4 space-y-6">

  <div id="contextBar" class="context-bar"></div>

  <!-- LANDING: søg + område/kreds -->
  <section class="vb-card p-4 space-y-3">
    <div class="mt-1 grid grid-cols-1 md:grid-cols-2 gap-3 md:items-end">

      <!-- Søg kandidat -->
      <div class="relative md:col-span-2">
        <label class="text-sm text-gray-600">Søg kandidat</label>
        <input id="candidateSearch" type="text"
               class="w-full mt-1 rounded-xl border p-2"
               placeholder="Skriv fx 'Anders Fogh' eller 'Helle Thorning'…"
               autocomplete="off" />
        <div id="candidateMenu" class="vb-menu hidden" role="listbox" tabindex="-1"
             aria-labelledby="candidateSearch" style="max-width:48rem"></div>
      </div>

      <!-- Amt/Storkreds -->
      <div>
        <label class="text-sm text-gray-600">Amt/Storkreds</label>
        <select id="areaSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
      </div>

      <!-- Kreds -->
      <div>
        <label class="text-sm text-gray-600">Kreds</label>
        <select id="kredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
      </div>
    </div>
  </section>

  <!-- Topliste -->
  <section id="overviewTop" class="vb-card p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 id="top10Title" class="font-semibold">Top 10 kandidater (personlige stemmer)</h2>
      <div class="flex items-center gap-3">
        <div id="top10Scope" class="text-sm text-gray-500"></div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnTop10" class="vb-tabbox small active" type="button">Top 10</button>
          <button id="btnAll" class="vb-tabbox small" type="button">Alle kandidater</button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader-wrap hidden" aria-live="polite">
      <div class="progress w-48 rounded-full"></div>
      <span id="loaderText">Indlæser…</span>
    </div>

    <div id="top10List" class="top10-grid">
      <ol id="top10ColLeft" class="space-y-2"></ol>
      <ol id="top10ColRight" class="space-y-2"></ol>
    </div>
  </section>

  <!-- Partier / kandidater -->
  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Partier og kandidater</h2>
      <div id="areatitel" class="text-gray-500"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <aside class="md:col-span-1 vb-card p-4 space-y-2">
        <label class="text-sm font-medium">Vælg parti</label>
        <div id="partyCombo" class="relative">
          <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
            <span id="partyButtonContent" class="vb-combo-label">
              <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
              <span class="truncate text-gray-500">Vælg kreds først…</span>
            </span>
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0l-4.24-4.43a.75.75 0 01.02-1.06z"/></svg>
          </button>
          <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
        </div>
      </aside>

      <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
        <div class="flex items-center justify-between gap-3">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg et parti i drop-down menuen.</div>
          <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
            <button id="btnSortAlpha" class="vb-tabbox small active" type="button" title="Alfabetisk">A–Å</button>
            <button id="btnSortVotes" class="vb-tabbox small" type="button" title="Flest stemmer">Flest stemmer</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div id="candidateColLeft" class="space-y-2"></div>
          <div id="candidateColRight" class="space-y-2"></div>
        </div>
      </section>
    </div>
  </section>

  <!-- Sammenligning -->
  <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenligning af kandidater</h2>
      <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      <div class="relative">
        <button id="btnAddKreds" class="vb-btn" aria-haspopup="listbox" aria-expanded="false">Tilføj kreds</button>
        <div id="addKredsMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="btnAddKreds"></div>
      </div>
      <div id="extraKredsChips" class="flex flex-wrap gap-2"></div>
    </div>
    <div id="selectedList" class="space-y-2"></div>
  </section>

  <!-- Tabel -->
  <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
    <div class="text-sm text-gray-600">Tabel pr. valgsted</div>
    <div class="overflow-auto">
      <table class="table-sticky w-full text-sm min-w-[720px]" id="psTable">
        <thead id="psThead"></thead>
        <tbody id="psTbody"></tbody>
        <tfoot id="psTFoot"></tfoot>
      </table>
    </div>
  </section>
</main>

<script>
/* ====== DATA-STI (FT 2005 – FLAD STRUKTUR) ====== */
const BASE_PATH = '/data/ft/2005/';             /* alle CSV-filer ligger direkte her */
const KREDS_ALL_VALUE = "__ALL__";
const DK_VALUE = "__DK__";

/* Områder (amter + storkredse i 2005) */
const AREAS = [
  "Bornholms Statsamt","Frederiksborg Statsamt","Fyns Statsamt","Københavns Statsamt",
  "Nordjyllands Statsamt","Ribe Statsamt","Ringkjøbing Statsamt","Roskilde Statsamt",
  "Storstrøms Statsamt","Sønderjyllands Statsamt","Søndre Storkreds","Vejle Statsamt",
  "Vestre Storkreds","Vestsjællands Statsamt","Viborg Statsamt","Østre Storkreds","Århus Statsamt"
];

/* ---------- PARTIER / FARVER / ALIAS ---------- */
const norm = s => (s||"").toLowerCase().replace(/[–—-]/g," ").replace(/[().]/g," ").replace(/\s+/g," ").trim();
const PARTY_COLORS = {"A":"#e03a3e","B":"#712082","C":"#2e7d32","D":"#0f766e","F":"#e5003d","I":"#00a0e3","O":"#0044aa","V":"#1b5eaa","Ø":"#c8102e","Å":"#3aaa35","Q":"#ff4fa3","K":"#ff9800","Æ":"#666666","M":"#6f42c1"};
const PARTY_LETTERS_BY_NAME = {
  "socialdemokratiet":"A","radikale venstre":"B","det radikale venstre":"B",
  "konservative folkeparti":"C","det konservative folkeparti":"C",
  "socialistisk folkeparti":"F","sf":"F","sf - socialistisk folkeparti":"F","sf socialistisk folkeparti":"F",
  "liberal alliance":"I","venstre, danmarks liberale parti":"V","venstre":"V",
  "dansk folkeparti":"O",
  "enhedslisten":"Ø","enhedslisten - de rød-grønne":"Ø","enhedslisten de rød grønne":"Ø",
  "kristendemokraterne":"K","kd - kristendemokraterne":"K","kd kristendemokraterne":"K",
  "alternativet":"Å","moderaterne":"M","danmarksdemokraterne":"Æ","frie grønne":"Q","nye borgerlige":"D"
};
const PARTY_LETTERS_BY_NAME_NORM = Object.fromEntries(Object.entries(PARTY_LETTERS_BY_NAME).map(([k,v])=>[norm(k),v]));
const DEFAULT_BADGE_BG="#e5e7eb", DEFAULT_BADGE_FG="#111827";

/* Helpers & state */
const state = {
  rows:[],                        // aktuelt viste rækker (DK, område eller kreds)
  area:"", kreds:"",
  activeParty:"", selected:new Map(),
  selectedKredse:new Set(),       // ekstra kredse i samme område (hentes fra cache)
  csvCache:new Map(),             // cache: `${område}::__ALL__` -> alle rækker i området
  kredsListCache:new Map(),       // cache: `${område}::KREDSLISTER` -> liste over kredse i området
  topListMode:"top10",
  candidateSortMode:"alpha"
};
const el = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("da-DK").format(n);
const canon = s => (s||"").toString().trim();
const escapeHtml = s => (s||"").replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const isListestemmer = name => { const t = canon(name).toLowerCase(); return t==="partiliste" || t==="listestemmer" || t==="liste"; };
const cleanPollingPlaceName = (name) => canon(name).replace(/^\s*\d+\.\s*/,'').trim();
const sortKandidaterAlpha = (a,b)=>{ const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn); if(al&&!bl) return 1; if(!al&&bl) return -1; return a.kandidat_navn.localeCompare(b.kandidat_navn,"da"); };
const sortKandidaterVotes = (a,b)=>{ const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn); if(al&&!bl) return 1; if(!al&&bl) return -1; const dv=(b.total||0)-(a.total||0); if(dv!==0) return dv; return a.kandidat_navn.localeCompare(b.kandidat_navn,"da"); };

function badge(letter){ const bg=letter && PARTY_COLORS[letter] ? PARTY_COLORS[letter] : DEFAULT_BADGE_BG; const fg=letter && PARTY_COLORS[letter] ? "#fff" : DEFAULT_BADGE_FG; return { style:`background-color:${bg};color:${fg};border-color:${bg}`, text:(letter||" ") }; }

/* Loader */
function showLoading(msg = "Indlæser…") {
  el('loader')?.classList.remove('hidden');
  const txt = el('loaderText'); if(txt) txt.textContent = msg || "Indlæser…";
  el('overviewTop')?.setAttribute('aria-busy','true');
  el('areaSelect')?.setAttribute('disabled','');
  el('kredsSelect')?.setAttribute('disabled','');
}
function hideLoading() {
  el('loader')?.classList.add('hidden');
  el('overviewTop')?.removeAttribute('aria-busy');
  el('areaSelect')?.removeAttribute('disabled');
  if (state.area) el('kredsSelect')?.removeAttribute('disabled');
}

/* Filnavn + sti (FLAD STRUKTUR) */
const areaSlug = (name) => (name||"").toString().replace(/\s+/g,"_");
const areaFileURL = (areaName) => {
  const file = encodeURIComponent(`${areaSlug(areaName)}_allepartier.csv`);
  return `${BASE_PATH}${file}`;
};
const DK_COMBINED_CACHE_KEY = "__DK_ALL__";

/* DK->område hop (primær area for kandidat) */
function primaryAreaForCandidate(candId, rows){
  const count=new Map();
  for(const r of rows){ if(r.kandidat_id===candId && r.area){ count.set(r.area, (count.get(r.area)||0)+1); } }
  if(count.size===0) return "";
  return Array.from(count.entries()).sort((a,b)=>b[1]-a[1])[0][0];
}
function selectCandidateById(candId){
  const sample = state.rows.find(r=>r.kandidat_id===candId);
  if(!sample) return;
  if(!state.selected.has(candId)){
    state.selected.set(candId,{ kandidat_id:candId, kandidat_navn:sample.kandidat_navn, parti:sample.parti });
  }
  renderAll();
  el('compareSection')?.scrollIntoView({behavior:'smooth', block:'start'});
}
async function gotoArea(areaName, candidateId=null){
  if(!areaName) return;
  const u=new URL(location.href);
  u.searchParams.set("area", areaName);
  u.searchParams.set("kreds", KREDS_ALL_VALUE);
  if(candidateId) u.searchParams.set("kandidat", candidateId); else u.searchParams.delete("kandidat");
  history.replaceState({}, "", u);
  el("areaSelect").value = areaName;
  await awaitPopulateKredse(areaName);
  state.area = areaName; state.kreds = KREDS_ALL_VALUE;
  await loadAreaData(areaName);
  if(candidateId) selectCandidateById(candidateId);
  else { renderAll(); renderContextBar(); }
}

/* Søgning */
const fold = (s) => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
function buildCandidateList(rows){
  const m = new Map();
  for(const r of rows){
    if(isListestemmer(r.kandidat_navn)) continue;
    if(!m.has(r.kandidat_id)){
      m.set(r.kandidat_id, { kandidat_id:r.kandidat_id, kandidat_navn:r.kandidat_navn, parti:r.parti });
    }
  }
  return Array.from(m.values());
}
function rankCandidates(cands, q){
  const Q = fold(q);
  if(!Q) return [];
  return cands.map(c=>{
    const f = fold(c.kandidat_navn);
    let score = -Infinity;
    if(f.startsWith(Q)) score = 300 - (f.length - Q.length);
    else{
      const hasWordStart = f.split(/\s+/).some(w=>w.startsWith(Q));
      if(hasWordStart) score = 200 - f.indexOf(Q);
      else if(f.includes(Q)) score = 100 - f.indexOf(Q);
    }
    const pf = fold(c.parti);
    if(pf.startsWith(Q) || pf.includes("("+Q+")")) score += 20;
    return { ...c, _score: score, _name: c.kandidat_navn };
  })
  .filter(x=>x._score>-Infinity)
  .sort((a,b)=> b._score - a._score || a._name.localeCompare(b._name, "da"))
  .slice(0, 15);
}

/* Init */
window.addEventListener("DOMContentLoaded", async ()=>{
  initAreaDropdown();
  initCandidateSearch();

  el("btnTop10").addEventListener("click", ()=>{ state.topListMode="top10"; updateTopButtonsForScope(); updateTopToggleUI(); renderOverview(); });
  el("btnAll").addEventListener("click", ()=>{ state.topListMode="all"; updateTopButtonsForScope(); updateTopToggleUI(); renderOverview(); });

  el("btnSortAlpha").addEventListener("click", ()=>{ state.candidateSortMode="alpha"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); });
  el("btnSortVotes").addEventListener("click", ()=>{ state.candidateSortMode="votes"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); });

  const p=new URLSearchParams(location.search), a=p.get("area"), k=p.get("kreds"), cand=p.get("kandidat");
  if(a && AREAS.includes(a)){
    el("areaSelect").value=a;
    state.area = a;
    await awaitPopulateKredse(a);
    await loadAreaData(a);                 // henter hele områdefilen (flad struktur)
    if(k===KREDS_ALL_VALUE){
      el("kredsSelect").value=KREDS_ALL_VALUE; state.kreds=KREDS_ALL_VALUE;
    }else if(k && (state.kredsListCache.get(`${a}::KREDSLISTER`)||[]).includes(k)){
      el("kredsSelect").value=k; state.kreds=k; await loadKredsData(a,k);   // filtrér fra cachede områdedata
    }
    if(cand) selectCandidateById(cand);
  }else{
    el("areaSelect").value = DK_VALUE;
    state.area = "";
    state.kreds = "";
    await loadNationalData();                   // saml alle områdefiler til Danmark
    renderContextBar();
  }

  el("btnClearAll")?.addEventListener('click', ()=>{ state.selected.clear(); renderAll(); });
  document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });
  setupAddKredsUI();
  renderContextBar();
  updateTopButtonsForScope();
  updateTopToggleUI();
  updateCandSortToggleUI();
});

/* Toggles */
function updateTopButtonsForScope(){
  const isDK = !state.area;
  const btnAll = el("btnAll");
  if(btnAll) btnAll.textContent = isDK ? "Top 50" : "Alle kandidater";
}
function updateTopToggleUI(){
  const a=el("btnTop10"), b=el("btnAll");
  if(state.topListMode==="top10"){ a.classList.add("active"); b.classList.remove("active"); }
  else { b.classList.add("active"); a.classList.remove("active"); }
}
function updateCandSortToggleUI(){
  const a=el("btnSortAlpha"), b=el("btnSortVotes");
  if(state.candidateSortMode==="alpha"){ a.classList.add("active"); b.classList.remove("active"); }
  else { b.classList.add("active"); a.classList.remove("active"); }
}

/* Dropdowns */
function initAreaDropdown(){
  const ssel=el("areaSelect");
  ssel.innerHTML =
    `<option value="">Vælg amt/storkreds…</option>` +
    `<option value="${DK_VALUE}">Hele Danmark</option>` +
    AREAS.map(s=>`<option value="${s}">${s}</option>`).join("");
  ssel.onchange = async ()=>{
    const v=ssel.value;
    state.activeParty=""; state.kreds=""; state.selectedKredse.clear(); clearAll(); renderExtraKredsChips(); updateAddKredsUIState();
    const u=new URL(location.href);
    if(v===DK_VALUE || !v){
      u.searchParams.delete("area"); u.searchParams.delete("kreds"); u.searchParams.delete("kandidat");
      history.replaceState({}, "", u);
      el("kredsSelect").disabled=true; el("kredsSelect").innerHTML=`<option value="">(Vælg amt/storkreds for at vælge kreds)</option>`;
      state.area=""; await loadNationalData();
    }else{
      state.area=v; await awaitPopulateKredse(v);
      u.searchParams.set("area",v); u.searchParams.delete("kreds"); u.searchParams.delete("kandidat");
      history.replaceState({}, "", u);
      await loadAreaData(v);          // henter kun én fil pr. område
    }
    renderContextBar();
    updateTopButtonsForScope();
    renderOverview();
  };
  el("kredsSelect").disabled=true;
}
async function awaitPopulateKredse(area){
  const ksel = el("kredsSelect");
  const kredse = await getKredseForArea(area);
  if(kredse.length){
    ksel.disabled=false;
    const allOpt = `<option value="${KREDS_ALL_VALUE}">Alle kredse i området</option>`;
    ksel.innerHTML = `<option value="">Vælg kreds…</option>${allOpt}` + kredse.map(k=>`<option value="${k}">${k}</option>`).join("");
    ksel.onchange = async ()=>{
      const v=ksel.value;
      state.activeParty=""; clearAll(); state.selectedKredse.clear(); renderExtraKredsChips();
      const u=new URL(location.href); u.searchParams.set("area",area); u.searchParams.delete("parti"); u.searchParams.delete("kandidat");
      if(v===KREDS_ALL_VALUE){
        state.kreds=KREDS_ALL_VALUE; u.searchParams.set("kreds",KREDS_ALL_VALUE); history.replaceState({}, "", u);
        await loadAreaData(area);   // viser hele området (fra cache/fil)
      }else if(v){
        state.kreds=v; u.searchParams.set("kreds",v); history.replaceState({}, "", u);
        await loadKredsData(area,v);     // filtrerer rækker fra område-cache
      }
      updateAddKredsUIState(); renderContextBar();
    };
  }else{
    ksel.disabled=true; ksel.innerHTML=`<option value="">(Ingen kredsvalg – viser hele området)</option>`;
  }
}
function updateAddKredsUIState(){
  const btn = el("btnAddKreds");
  const disable = !state.area || state.kreds===KREDS_ALL_VALUE || !state.kreds;
  if(btn){ btn.disabled = disable; btn.title = disable ? "Tilføjelse af kredse er ikke tilgængelig, når alle kredse er valgt." : ""; }
}
function clearAll(){
  state.rows=[]; state.selected.clear();
  const btn=el("partyButton"), btnc=el("partyButtonContent"); btn.disabled=true; btn.setAttribute('aria-expanded','false');
  btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg kreds først…</span>`;
  el("partyMenu").innerHTML=""; el("partyDetailHeader").textContent="Vælg et parti i drop-down menuen.";
  el("candidateColLeft").innerHTML=""; el("candidateColRight").innerHTML="";
  el("areatitel").textContent="";
  renderAll();
}

/* ================= DATA-LOAD ================= */

/* Parser – robust i forhold til kolonnenavne */
function parseCsvTextToRows(text, areaNameOverride=null){
  const res = Papa.parse(text,{header:true,skipEmptyLines:true,transformHeader:h=>canon(h.toLowerCase())});
  return res.data.map(r=>{
    let kandidatNavn = canon(r.kandidat_navn);
    const navnLower = (kandidatNavn||"").toLowerCase();
    if (["partiliste","listestemmer","liste"].includes(navnLower)) kandidatNavn = "Partiliste";
    const parti = canon(r.parti);
    const rawLetter = r.parti_bogstav || r.bogstav || r.parti_kode || r['parti (bogstav)'] || r.listebogstav;
    const L = canon(rawLetter).toUpperCase();
    const parti_letter = /^[A-ZÆØÅ]$/.test(L) ? L : "";

    const kredsNavn = canon(r.kredsnavn || r.kreds || "");
    const areaNavn = areaNameOverride || canon(r.amt || r.statsamt || r.storkreds || r.omraade || "") || ""; // 2005: amter/storkredse

    const kandidat_id = `${parti.toLowerCase()}::${kandidatNavn.toLowerCase()}`;
    return {
      area: areaNavn,
      kreds: kredsNavn,
      valgsted_id: canon(r.valgsted_id || r.afstemningssted_id || r.sted_id || `${cleanPollingPlaceName(r.valgsted_navn||r.afstemningssted||r.sted_navn)}`),
      valgsted_navn: cleanPollingPlaceName(r.valgsted_navn || r.afstemningssted || r.sted_navn),
      kandidat_id,
      kandidat_navn: kandidatNavn,
      parti,
      parti_letter,
      stemmer: Number(r.stemmer||0)||0
    };
  });
}

async function fetchCsv(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.text();
}

/* Hele Danmark = saml alle områdefiler */
async function loadNationalData(){
  showLoading("Indlæser Danmark…");
  try{
    el("error").textContent=""; el("areatitel").textContent=`(Danmark)`;

    // Brug cache hvis allerede samlet
    if(state.csvCache.has(DK_COMBINED_CACHE_KEY)){
      state.rows = state.csvCache.get(DK_COMBINED_CACHE_KEY).slice();
      afterDataLoaded();
      return;
    }

    const allRows = [];
    const tasks = AREAS.map(async (ar)=>{
      try{
        const txt = await fetchCsv(areaFileURL(ar));
        const rows = parseCsvTextToRows(txt, ar);
        // cache hele området til senere brug
        state.csvCache.set(`${ar}::__ALL__`, rows.slice());
        state.kredsListCache.set(`${ar}::KREDSLISTER`, Array.from(new Set(rows.map(r=>canon(r.kreds))).values()).filter(Boolean).sort((a,b)=>a.localeCompare(b,"da")));
        allRows.push(...rows);
      }catch(e){
        console.warn("Kunne ikke indlæse", ar, e);
      }
    });

    // Kør i batches
    const BATCH_SIZE = 5;
    for(let i=0;i<tasks.length;i+=BATCH_SIZE){
      await Promise.allSettled(tasks.slice(i,i+BATCH_SIZE));
    }

    state.rows = allRows;
    state.csvCache.set(DK_COMBINED_CACHE_KEY, allRows.slice());
    afterDataLoaded();
    if(!allRows.length){ el("error").textContent=`Kunne ikke indlæse landsdata (ingen filer fundet).`; }
  } finally { hideLoading(); }
}

/* Hele området (én fil) */
async function loadAreaData(area){
  showLoading("Indlæser amt/storkreds…");
  try{
    el("error").textContent=""; el("areatitel").textContent=`(${area})`;

    // Brug cache hvis muligt
    const cacheKey = `${area}::__ALL__`;
    if(state.csvCache.has(cacheKey)){
      state.rows = state.csvCache.get(cacheKey).slice();
      // sikr kredslisten er cachet
      if(!state.kredsListCache.has(`${area}::KREDSLISTER`)){
        const ks = Array.from(new Set(state.rows.map(r=>canon(r.kreds))).values()).filter(Boolean).sort((a,b)=>a.localeCompare(b,"da"));
        state.kredsListCache.set(`${area}::KREDSLISTER`, ks);
      }
      afterDataLoaded();
      return;
    }

    const txt = await fetchCsv(areaFileURL(area));
    const rows = parseCsvTextToRows(txt, area);
    state.csvCache.set(cacheKey, rows.slice());
    state.kredsListCache.set(`${area}::KREDSLISTER`, Array.from(new Set(rows.map(r=>canon(r.kreds))).values()).filter(Boolean).sort((a,b)=>a.localeCompare(b,"da")));
    state.rows = rows;
    afterDataLoaded();
  } catch(e){
    console.error(e);
    el("error").textContent=`Kunne ikke finde data for ${area}.`;
  } finally { hideLoading(); }
}

/* Enkel kreds = filtrer cachede områdedata */
async function loadKredsData(area, kreds){
  showLoading("Indlæser kreds…");
  try{
    el("error").textContent="";
    el("areatitel").textContent = kreds ? `(${area} – ${kreds})` : `(${area})`;

    const cacheKey = `${area}::__ALL__`;
    if(!state.csvCache.has(cacheKey)){
      // sikr at hele området er i cache
      await loadAreaData(area);
    }
    const all = state.csvCache.get(cacheKey) || [];
    state.rows = all.filter(r => canon(r.kreds) === canon(kreds));
    afterDataLoaded();
    if(!state.rows.length){
      el("error").textContent=`Ingen rækker fundet for ${area} / ${kreds}.`;
    }
  } finally { hideLoading(); }
}

/* Hjælpere til kredslister */
async function getKredseForArea(area){
  // Hvis områdets rækker allerede er i cache, brug dem for at bygge kredslisten
  const cacheKey = `${area}::KREDSLISTER`;
  if(state.kredsListCache.has(cacheKey)) return state.kredsListCache.get(cacheKey);
  try{
    const txt = await fetchCsv(areaFileURL(area));
    const rows = parseCsvTextToRows(txt, area);
    state.csvCache.set(`${area}::__ALL__`, rows.slice());
    const ks = Array.from(new Set(rows.map(r=>canon(r.kreds))).values()).filter(Boolean).sort((a,b)=>a.localeCompare(b,"da"));
    state.kredsListCache.set(cacheKey, ks);
    return ks;
  }catch(e){
    console.warn("Kunne ikke bygge kredsliste for", area, e);
    return [];
  }
}

/* Efter data indlæst */
function afterDataLoaded(){
  state.activeParty=""; renderPartyCombobox(); renderAll(); updateAddKredsUIState(); renderContextBar();
  el('candidateMenu')?.classList.add('hidden');
}

/* Parti-stats */
function detectPartyLetter(parti, rowsForParti){
  for(const r of rowsForParti){ const L=(r.parti_letter||"").toUpperCase(); if(L && PARTY_COLORS[L]) return L; }
  const keyNorm = norm(parti), mapped = PARTY_LETTERS_BY_NAME_NORM[keyNorm];
  if(mapped && PARTY_COLORS[mapped]) return mapped;
  if(keyNorm.includes("socialistisk folkeparti") || keyNorm==="sf") return "F";
  return null;
}
function getActiveRows(){
  // Start med de rækker, der svarer til den aktuelle visning (DK, område eller kreds)
  const base = state.rows.slice();

  // Hvis brugeren har tilføjet ekstra kredse (kun inden for samme område):
  if(state.area && state.selectedKredse.size){
    const cacheKey = `${state.area}::__ALL__`;
    const all = state.csvCache.get(cacheKey) || [];
    // medtag rækker fra ekstra kredse, men undgå dubletter
    const already = new Set(base.map(r=>`${r.kreds}::${r.valgsted_id}::${r.kandidat_id}`));
    for(const k of state.selectedKredse){
      for(const r of all){
        if(canon(r.kreds)!==canon(k)) continue;
        const key = `${r.kreds}::${r.valgsted_id}::${r.kandidat_id}`;
        if(!already.has(key)){ base.push(r); already.add(key); }
      }
    }
  }
  return base;
}
function getAllowedAreasForSelection(){
  const sel = getSelected();
  if(sel.length===0) return null;
  const scopes = getCandidateScopes();
  let allowed = null;
  for(const c of sel){
    const sc = scopes.get(c.kandidat_id);
    if(!sc) continue;
    allowed = (allowed===null)
      ? new Set(sc.areas)
      : new Set([...allowed].filter(x => sc.areas.has(x)));
  }
  return allowed || null;
}

/* Områder & validering */
function getCandidateScopes(){
  const rows = getActiveRows();
  const m = new Map();
  for(const r of rows){
    const id=r.kandidat_id;
    if(!m.has(id)) m.set(id, { areas:new Set(), kredse:new Set() });
    if(r.area) m.get(id).areas.add(r.area);
    if(r.kreds) m.get(id).kredse.add(r.kreds);
  }
  return m;
}
function canAddCandidate(candidateId){
  const sel = Array.from(state.selected.values());
  if(sel.length===0) return { ok:true };
  const scopes = getCandidateScopes();
  const newScope = scopes.get(candidateId);
  if(!newScope) return { ok:false, reason:"Ingen data fundet for kandidaten i nuværende visning." };

  const matchesAll = sel.every(c=>{
    const sc = scopes.get(c.kandidat_id);
    if(!sc) return false;
    return [...sc.areas].some(ar => newScope.areas.has(ar));
  });

  if(!matchesAll){
    return { ok:false, reason:`Kandidater til sammenligning skal være fra samme amt/storkreds` };
  }
  return { ok:true };
}
function showError(msg){
  el("error").textContent = msg || "";
  if(msg){ setTimeout(()=>{ if(el("error").textContent===msg) el("error").textContent=""; }, 6000); }
}

/* Top 10 / Alle */
function totalsByCandidate(rows){
  const m=new Map();
  for(const r of rows){
    if(!m.has(r.kandidat_id)){
      m.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
    }
    m.get(r.kandidat_id).total += r.stemmer;
  }
  return Array.from(m.values()).filter(k=>!isListestemmer(k.kandidat_navn)).sort((a,b)=>b.total-a.total);
}
function getOverviewRows(){
  if(!state.area) return state.rows;
  if(state.kreds && state.kreds !== KREDS_ALL_VALUE) return state.rows;
  const cached = state.csvCache.get(`${state.area}::__ALL__`);
  return cached && cached.length ? cached : state.rows;
}
function renderOverview(){
  const rows = getOverviewRows();
  const isDK = !state.area;
  const atScope = isDK ? "Danmark" : (state.kreds && state.kreds !== KREDS_ALL_VALUE ? `${state.area} / ${state.kreds}` : `${state.area} / Alle kredse i området`);
  el("top10Scope").textContent = rows.length ? atScope : "";
  const ranked = totalsByCandidate(rows);

  let list;
  if(state.topListMode==="top10"){
    list = ranked.slice(0,10);
    el("top10Title").textContent = "Top 10 kandidater (personlige stemmer)";
  }else{
    if(isDK){
      list = ranked.slice(0,50);
      el("top10Title").textContent = "Top 50 kandidater (personlige stemmer)";
    }else{
      list = ranked;
      el("top10Title").textContent = "Alle kandidater (personlige stemmer)";
    }
  }

  function itemHTML(k, idx){
    const letter = detectPartyLetter(k.parti, rows.filter(r=>r.parti===k.parti));
    const bd = badge(letter);
    const meta = `${escapeHtml(k.parti)} · ${fmt(k.total)} stemmer`;
    return `<li class="top10-item" data-cand="${escapeHtml(k.kandidat_id)}" role="button" tabindex="0" title="Klik for at ${state.area ? 'tilføje til sammenligning' : 'se i amt/storkreds'}">
      <span class="rank-pill">${idx}</span>
      <div class="min-w-0 flex-1">
        <div class="font-medium truncate">${escapeHtml(k.kandidat_navn)}</div>
        <div class="text-xs text-gray-500 truncate">${meta}</div>
      </div>
      <span class="vb-badge" style="${bd.style}">${bd.text}</span>
    </li>`;
  }

  const half = Math.ceil(list.length/2);
  const left = list.slice(0,half);
  const right = list.slice(half);
  el("top10ColLeft").innerHTML = left.map((k,i)=>itemHTML(k, i+1)).join("") || `<div class="text-sm text-gray-500">Ingen data at vise.</div>`;
  el("top10ColRight").innerHTML = right.map((k,i)=>itemHTML(k, i+1+half)).join("");

  const bind = (rootId)=> {
    document.getElementById(rootId).querySelectorAll('.top10-item').forEach(item=>{
      const candId=item.getAttribute('data-cand');
      item.addEventListener('click', ()=>toggleCandidateFromTop(candId, rows));
      item.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleCandidateFromTop(candId, rows); }});
    });
  };
  bind('top10ColLeft'); bind('top10ColRight');
}
async function toggleCandidateFromTop(candId, rows){
  if(!state.area){
    const ar = primaryAreaForCandidate(candId, rows);
    if(ar){ await gotoArea(ar, candId); }
    return;
  }
  const sample = rows.find(r=>r.kandidat_id===candId);
  if(!sample) return;
  if(state.selected.has(candId)){
    state.selected.delete(candId); renderAll(); return;
  }
  const check = canAddCandidate(candId);
  if(!check.ok){ showError(check.reason); return; }
  state.selected.set(candId, { kandidat_id: candId, kandidat_navn: sample.kandidat_navn, parti: sample.parti });
  renderAll();
  if(state.selected.size>0){
    el('compareSection').scrollIntoView({behavior:'smooth', block:'start'});
  }
}

/* Parti-combobox */
function getPartyStats(){
  const rows = getActiveRows();
  const byParti=new Map();
  for(const r of rows){ if(!byParti.has(r.parti)) byParti.set(r.parti,[]); byParti.get(r.parti).push(r); }
  const res=[];
  for(const [parti,rowsP] of byParti.entries()){
    const map=new Map();
    for(const r of rowsP){
      if(!map.has(r.kandidat_id)) map.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
      map.get(r.kandidat_id).total+=r.stemmer;
    }
    const kandidater=Array.from(map.values());
    const letter = detectPartyLetter(parti, rowsP);
    res.push({ parti, letter, hasLetter: !!letter, kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length, kandidater });
  }
  res.sort((a,b)=>{ if(a.hasLetter!==b.hasLetter) return a.hasLetter?-1:1; if(a.hasLetter&&b.hasLetter) return a.letter.localeCompare(b.letter,"da"); return a.parti.localeCompare(b.parti,"da"); });
  return res;
}
function renderPartyCombobox(){
  const stats=getPartyStats(), btn=el("partyButton"), btnc=el("partyButtonContent"), menu=el("partyMenu");
  if(!stats.length){ btn.disabled=true; btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Ingen partier fundet</span>`; menu.innerHTML=""; return; }
  btn.disabled=false;
  function renderButton(){
    if(!state.activeParty){ btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`; return; }
    const cur=stats.find(s=>s.parti===state.activeParty);
    const {style,text}=badge(cur?.letter||null);
    btnc.innerHTML=`<span class="vb-badge" style="${style}">${text}</span><span class="truncate">${escapeHtml(state.activeParty)}</span>`;
  }
  function renderMenu(){
    menu.innerHTML=stats.map(s=>{
      const {style,text}=badge(s.letter); const sel=s.parti===state.activeParty;
      return `<div class="vb-option" role="option" data-parti="${escapeHtml(s.parti)}" aria-selected="${sel}">
        <span class="vb-badge" style="${style}">${text}</span>
        <span class="flex-1">${escapeHtml(s.parti)}</span>
        <span class="text-xs text-gray-500">${s.kandidatAntal} kandidater</span>
      </div>`;
    }).join("");
    menu.querySelectorAll('.vb-option').forEach((opt,i)=>{
      opt.onclick=()=>{
        state.activeParty=opt.getAttribute('data-parti'); renderButton(); closePartyMenu(); renderPartyDetail(state.activeParty);
        menu.querySelectorAll('.vb-option').forEach((x,j)=>x.setAttribute('aria-selected', j===i));
        const u=new URL(location.href); u.searchParams.set("parti", state.activeParty); u.searchParams.delete("kandidat"); history.replaceState({}, "", u);
      };
    });
  }
  btn.onclick=()=>{ const open=btn.getAttribute('aria-expanded')==='true'; if(open) closePartyMenu(); else { renderMenu(); openPartyMenu(); } };
  function openPartyMenu(){ btn.setAttribute('aria-expanded','true'); menu.classList.remove('hidden'); menu.focus(); }
  function closePartyMenu(){ btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
  window.closePartyMenu=closePartyMenu;
  renderButton();
  el("partyDetailHeader").textContent = "Vælg et parti i drop-down menuen.";
  el("candidateColLeft").innerHTML = ""; el("candidateColRight").innerHTML = "";
}

/* Kandidatliste */
function renderPartyDetail(parti){
  const header=el("partyDetailHeader"), left=el("candidateColLeft"), right=el("candidateColRight");
  left.innerHTML=""; right.innerHTML="";
  if(!parti){ header.textContent="Vælg et parti i drop-down menuen."; return; }
  header.textContent=parti;

  const kandidaterAll=getPartyStats().find(x=>x.parti===parti)?.kandidater||[];
  const sorted = kandidaterAll.slice().sort(state.candidateSortMode==='alpha' ? sortKandidaterAlpha : sortKandidaterVotes);

  const mid = Math.ceil(sorted.length/2);
  const leftArr = sorted.slice(0, mid);
  const rightArr = sorted.slice( mid);

  async function addCandidate(k){
    if(!state.area){
      const ar = primaryAreaForCandidate(k.kandidat_id, getOverviewRows());
      if(ar){ await gotoArea(ar, k.kandidat_id); }
      return;
    }
    const check = canAddCandidate(k.kandidat_id);
    if(!check.ok){ showError(check.reason); return; }
    state.selected.set(k.kandidat_id,{kandidat_id:k.kandidat_id,kandidat_navn:k.kandidat_navn,parti:k.parti});
    renderAll();
  }

  function card(k){
    const listestemmer = isListestemmer(k.kandidat_navn);
    const subtitle = listestemmer ? `${fmt(k.total)} listestemmer` : `${fmt(k.total)} stemmer i alt`;
    const meta = `${escapeHtml(k.parti)} · ${subtitle}`;
    const div=document.createElement("div");
    div.className="rounded-xl border px-3 py-2";
    div.setAttribute("data-cand-id", k.kandidat_id);
    div.innerHTML=`<div class="flex items-center justify-between">
      <div>
        <div class="font-medium">${escapeHtml(k.kandidat_navn)}</div>
        <div class="text-xs text-gray-500">${meta}</div>
      </div>
      ${state.area ? `<button class="vb-btn" data-add="${k.kandidat_id}">Tilføj</button>` : `<button class="vb-btn" data-see="${k.kandidat_id}">Se i amt/storkreds</button>`}
    </div>`;
    const add = div.querySelector("button[data-add]");
    if(add) add.onclick=()=>addCandidate(k);
    const see = div.querySelector("button[data-see]");
    if(see) see.onclick=()=>addCandidate(k);
    return div;
  }

  leftArr.forEach(k=>left.appendChild(card(k)));
  rightArr.forEach(k=>right.appendChild(card(k)));
}

/* Samlet render / tabel */
function renderAll(){
  const isDK = !state.area;
  renderSelected();
  renderPsTable(getPollingStations(), getSelectedOrdered());
  const showCompare = !isDK && getSelected().length>0;
  el("compareSection").classList.toggle("hidden", !showCompare);
  el("tabsCard").classList.toggle("hidden", !showCompare);
  updateTopButtonsForScope();
  renderOverview();
  renderContextBar();
}
function stemmerLabel(n){ return n===1 ? "stemme" : "stemmer"; }
function computeTotalsByCandidateScoped(){
  const rows = getActiveRows();
  const scopes = getCandidateScopes();
  const totals = new Map();
  for(const r of rows){
    const sc = scopes.get(r.kandidat_id);
    if(!sc) continue;
    if(r.area && sc.areas.has(r.area)){
      totals.set(r.kandidat_id, (totals.get(r.kandidat_id)||0) + r.stemmer);
    }
  }
  return totals;
}
function renderSelected(){
  const root=el("selectedList"), totals=computeTotalsByCandidateScoped(), sel=getSelectedOrdered();
  function letterForParti(parti){ const stat=getPartyStats().find(s=>s.parti===parti); return stat?.letter||null; }
  root.innerHTML = sel.map(k=>{
    const letter=letterForParti(k.parti), bd=badge(letter);
    const total = totals.get(k.kandidat_id)||0;
    const listestemmer = isListestemmer(k.kandidat_navn);
    const totalTekst = listestemmer ? `${fmt(total)} ${total===1 ? 'listestemme' : 'listestemmer'}` : `${fmt(total)} personlige ${stemmerLabel(total)} i alt`;
    return `<div class="rounded-xl border p-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="vb-badge" style="${bd.style}">${bd.text}</span>
        <div class="font-medium">
          ${escapeHtml(k.kandidat_navn)} <span class="text-gray-500">(${escapeHtml(k.parti)})</span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="tabular-nums font-medium">${totalTekst}</div>
        <button class="vb-btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
      </div>
    </div>`;
  }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;
  el("btnClearAll").disabled = sel.length===0;
}
window.removeCandidate = id => { state.selected.delete(id); renderAll(); };
const getSelected = () => Array.from(state.selected.values());
const getSelectedOrdered = () => { const s=getSelected().slice(); s.sort(sortKandidaterAlpha); return s; };

/* Valgsteder */
function getPollingStations(){
  const rows = getActiveRows();
  const m=new Map();
  for(const r of rows){
    const key = `${r.kreds||""}::${r.valgsted_id}`;
    if(!m.has(key)) m.set(key,{id:key,navn:cleanPollingPlaceName(r.valgsted_navn),kreds:r.kreds||"",area:r.area||""});
    const ps=m.get(key);
    ps[r.kandidat_id]=(ps[r.kandidat_id]||0)+r.stemmer;
  }
  return Array.from(m.values()).sort((a,b)=>{ if(a.kreds!==b.kreds) return a.kreds.localeCompare(b.kreds,"da"); return a.navn.localeCompare(b.navn,"da"); });
}

/* Tabel */
function renderPsTable(psList, sel){
  const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
  if(!sel.length){ thead.innerHTML=`<tr><th class="text-left py-2 pr-3">Valgsted</th><th class="text-left py-2 pr-3">Kreds</th></tr>`; tbody.innerHTML=""; tfoot.innerHTML=""; return; }
  const allowedAreas = getAllowedAreasForSelection();
  const filteredPs = allowedAreas ? psList.filter(ps => allowedAreas.has(ps.area)) : psList;

  const scopes = getCandidateScopes();
  const header = sel.map(s=>{
    const stat = getPartyStats().find(x=>x.parti===s.parti);
    const bd = badge(stat?.letter || null);
    return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
      <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
      <span>${escapeHtml(s.kandidat_navn)} (${escapeHtml(s.parti)})</span></div></th>`;
  }).join("");
  thead.innerHTML=`<tr class="text-left border-b">
    <th class="py-2 pr-3">Valgsted</th>
    <th class="py-2 pr-3">Kreds</th>
    ${header}
  </tr>`;
  const colspan = 2 + sel.length;
  let prevKreds = null;
  const rowsHtml = [];
  for(const ps of filteredPs){
    if(prevKreds !== null && ps.kreds !== prevKreds){
      rowsHtml.push(`<tr><td class="kreds-divider" colspan="${colspan}"></td></tr>`);
    }
    rowsHtml.push(
      `<tr class="border-b last:border-0">
        <td class="py-2 pr-3 font-medium">${escapeHtml(ps.navn)}</td>
        <td class="py-2 pr-3">${escapeHtml(ps.kreds || "")}</td>
        ${sel.map(s=>{
          const sc=scopes.get(s.kandidat_id);
          const allowed = sc && ps.area && sc.areas.has(ps.area);
          const val = allowed ? (ps[s.kandidat_id]||0) : null;
          return `<td class="py-2 pr-3 tabular-nums">${val===null ? '<span class="cell-na">—</span>' : fmt(val)}</td>`;
        }).join("")}
      </tr>`
    );
    prevKreds = ps.kreds;
  }
  tbody.innerHTML = rowsHtml.join("");
  const totals=computeTotalsByCandidateScoped();
  tfoot.innerHTML=`<tr class="border-t">
    <th class="py-2 pr-3 text-left">Samlet</th>
    <th class="py-2 pr-3 text-left text-gray-500">(${fmt(filteredPs.length)} rækker)</th>
    ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("")}
  </tr>`;
}

/* “Tilføj kreds” UI – dynamisk ud fra områdets cachede rækker */
function setupAddKredsUI(){
  const btnAddKreds = document.getElementById('btnAddKreds');
  const addKredsMenu = document.getElementById('addKredsMenu');
  btnAddKreds?.addEventListener('click', async ()=>{
    if(!state.area) return;
    await renderAddKredsMenu();
    const isHidden = addKredsMenu.classList.contains('hidden');
    addKredsMenu.classList.toggle('hidden', !isHidden ? true : false);
    btnAddKreds.setAttribute('aria-expanded', (!isHidden).toString());
  });
  document.addEventListener('click',(e)=>{
    if(!addKredsMenu.contains(e.target) && e.target!==btnAddKreds){
      addKredsMenu.classList.add('hidden');
      btnAddKreds.setAttribute('aria-expanded','false');
    }
  });
  async function renderAddKredsMenu(){
    const all = await getKredseForArea(state.area);
    const already = new Set([ ...state.selectedKredse ]);
    const options = all.filter(k=>k && !already.has(k));
    const selectAll = options.length || all.length
      ? `<div class="vb-option" role="option" data-kreds="__ALL__"><strong>Vælg alle kredse</strong></div><hr class="my-1 border-gray-200">`
      : '';
    addKredsMenu.innerHTML = selectAll + (
      options.map(k=>`<div class="vb-option" role="option" data-kreds="${escapeHtml(k)}"><span class="flex-1">${k}</span></div>`).join('') ||
      `<div class="p-2 text-sm text-gray-500">Ingen ekstra kredse</div>`
    );
    addKredsMenu.querySelectorAll('.vb-option').forEach(opt=>{
      opt.onclick = async ()=>{
        const v = opt.getAttribute('data-kreds');
        try{
          if(v === '__ALL__'){
            const toAdd = (await getKredseForArea(state.area)).slice();
            toAdd.forEach(k=>state.selectedKredse.add(k));
          }else{
            state.selectedKredse.add(v);
          }
          renderExtraKredsChips(); renderAll();
        }catch(e){
          el("error").textContent = `Kunne ikke indlæse data.`;
        }finally{
          addKredsMenu.classList.add('hidden');
          btnAddKreds.setAttribute('aria-expanded','false');
        }
      };
    });
  }
}
function renderExtraKredsChips(){
  const root = document.getElementById('extraKredsChips');
  const items = Array.from(state.selectedKredse);
  root.innerHTML = items.map(k=>`<button class="vb-btn" data-delk="${escapeHtml(k)}">${k} &times;</button>`).join('');
  root.querySelectorAll('button[data-delk]').forEach(b=>{
    b.onclick = ()=>{
      const k = b.getAttribute('data-delk');
      state.selectedKredse.delete(k);
      renderExtraKredsChips(); renderAll();
    };
  });
}

/* “Hvor er jeg?” bar */
function renderContextBar(){
  const bar = document.getElementById('contextBar');
  const parts = [];
  parts.push(state.area ? `<span class="crumb" data-nav="dk">Hele Danmark</span>` : `<span class="crumb-strong">Hele Danmark</span>`);
  if(state.area){
    parts.push(`<span class="sep">/</span>`);
    const isAreaAll = !state.kreds || state.kreds===KREDS_ALL_VALUE;
    parts.push(isAreaAll ? `<span class="crumb-strong">${escapeHtml(state.area)}</span>` : `<span class="crumb" data-nav="area">${escapeHtml(state.area)}</span>`);
    if(state.kreds && state.kreds!==KREDS_ALL_VALUE){
      parts.push(`<span class="sep">/</span>`);
      parts.push(`<span class="crumb-strong">${escapeHtml(state.kreds)}</span>`);
    }
  }
  bar.innerHTML = parts.join("");

  // DK
  bar.querySelector('[data-nav="dk"]')?.addEventListener('click', async ()=>{
    state.selected.clear(); state.activeParty = ""; state.selectedKredse.clear();
    try { closePartyMenu(); } catch(_) {}
    el("areaSelect").value = DK_VALUE; state.area = ""; state.kreds = "";
    const u = new URL(location.href);
    u.searchParams.delete("area"); u.searchParams.delete("kreds"); u.searchParams.delete("kandidat"); u.searchParams.delete("parti");
    history.replaceState({}, "", u);
    await loadNationalData(); renderAll();
  });

  // Område breadcrumb -> alle kredse
  bar.querySelector('[data-nav="area"]')?.addEventListener('click', async ()=>{
    const a = state.area;
    try { closePartyMenu(); } catch(_) {}
    el("kredsSelect").value = KREDS_ALL_VALUE;
    state.kreds = KREDS_ALL_VALUE;
    const u = new URL(location.href);
    u.searchParams.set("area", a);
    u.searchParams.set("kreds", KREDS_ALL_VALUE);
    u.searchParams.delete("kandidat");
    history.replaceState({}, "", u);
    await loadAreaData(a); renderAll();
  });
}

/* Kandidat-søg UI */
function initCandidateSearch(){
  const input = el('candidateSearch');
  const menu  = el('candidateMenu');
  let activeIndex = -1;

  function closeMenu(){ menu.classList.add('hidden'); activeIndex = -1; }
  function openMenu(){ menu.classList.remove('hidden'); }

  function renderMenuFor(query){
    const scopeRows = getOverviewRows();
    const cands = buildCandidateList(scopeRows);
    const results = rankCandidates(cands, query);
    if(!results.length){ closeMenu(); menu.innerHTML=""; return; }

    menu.innerHTML = results.map((c,i)=>{
      const letter = detectPartyLetter(c.parti, scopeRows.filter(r=>r.parti===c.parti));
      const bd = badge(letter);
      return `<div class="vb-option" role="option" data-idx="${i}" data-cand="${escapeHtml(c.kandidat_id)}" aria-selected="${i===activeIndex}">
        <span class="vb-badge" style="${bd.style}">${bd.text}</span>
        <span class="flex-1">
          <span class="font-medium">${escapeHtml(c.kandidat_navn)}</span><br/>
          <span class="text-xs text-gray-500">${escapeHtml(c.parti)}</span>
        </span>
      </div>`;
    }).join("");

    menu.querySelectorAll('.vb-option').forEach(opt=>{
      opt.onclick = ()=> selectByIndex(parseInt(opt.getAttribute('data-idx'),10));
    });

    openMenu();
  }

  function selectByIndex(i){
    const scopeRows = getOverviewRows();
    const cands = buildCandidateList(scopeRows);
    const results = rankCandidates(cands, input.value);
    const sel = results[i];
    if(!sel) return;
    toggleCandidateFromTop(sel.kandidat_id, scopeRows); // DK -> hop til område; ellers tilføj
    closeMenu();
    input.value = "";
  }

  let t=null;
  input?.addEventListener('input', ()=>{
    const q = input.value.trim();
    if(t) clearTimeout(t);
    if(!q){ closeMenu(); return; }
    t = setTimeout(()=>renderMenuFor(q), 120);
  });

  input?.addEventListener('keydown', (e)=>{
    const results = rankCandidates(buildCandidateList(getOverviewRows()), input.value);
    if(e.key==='ArrowDown'){
      e.preventDefault(); if(!results.length) return;
      activeIndex = (activeIndex+1) % results.length; renderMenuFor(input.value);
      const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
      if(opt){ menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); opt.scrollIntoView({block:'nearest'}); }
    }else if(e.key==='ArrowUp'){
      e.preventDefault(); if(!results.length) return;
      activeIndex = (activeIndex<=0 ? results.length-1 : activeIndex-1); renderMenuFor(input.value);
      const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
      if(opt){ menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); opt.scrollIntoView({block:'nearest'}); }
    }else if(e.key==='Enter'){
      if(!menu.classList.contains('hidden')){ e.preventDefault(); selectByIndex(activeIndex>=0 ? activeIndex : 0); }
    }else if(e.key==='Escape'){
      closeMenu();
    }
  });

  document.addEventListener('click',(e)=>{
    const box = el('candidateSearch')?.parentElement;
    if(box && !box.contains(e.target)) closeMenu();
  });
}

function closePartyMenu(){ const btn=el('partyButton'), menu=el('partyMenu'); btn?.setAttribute('aria-expanded','false'); menu?.classList.add('hidden'); }
</script>
</body>
</html>
