<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Valgbar – Europa-Parlamentsvalg 2019</title>

<!-- Tailwind CSS (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{ --vb-navy:#234a5a; --vb-navy-2:#1b3d4d; }
.vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
.vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
.vb-btn:disabled{ opacity:.5; cursor:not-allowed; }

.vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
.vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }
.vb-tabbox.small{ flex:0 0 auto; padding:.4rem .8rem; font-size:.9rem; }

.vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff;
  display:flex; align-items:center; justify-content:space-between; }
.vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
.vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
.vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center;
  border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }
.vb-menu{ position:absolute; z-index:50; margin-top:.25rem; width:max-content; min-width:16rem;
  max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb;
  border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
.vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
.vb-option span{ white-space:normal; word-break:break-word; }
.vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }

.table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{ position:sticky; left:0; background:#fff; }

.vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }

.rank-pill{ width:28px; height:28px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center;
  font-weight:700; border:1px solid #e5e7eb; background:#f9fafb; }
.top10-item{ display:flex; align-items:center; gap:.75rem; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:12px; cursor:pointer; }
.top10-item:hover{ background:#f9fafb; }
.top10-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; }
@media (min-width:768px){ .top10-grid{ grid-template-columns:1fr 1fr; } }

.context-bar{ display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; }
.crumb{ color:#374151; text-decoration:underline; cursor:pointer; }
.crumb-strong{ background:#111827; color:#fff; border-radius:9999px; padding:.15rem .6rem; font-weight:600; }
.sep{ color:#9ca3af; }

.cell-na{ color:#9ca3af; }

/* Loader */
.loader-wrap{ display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#6b7280; }
.progress{ position:relative; height:6px; background:#f3f4f6; border-radius:9999px; overflow:hidden; }
.progress::after{
  content:""; position:absolute; inset:0; transform:translateX(-100%);
  background:linear-gradient(90deg, rgba(0,0,0,0) 0%, #c7d2fe 50%, rgba(0,0,0,0) 100%);
  animation:loadbar 1.2s infinite;
}
@keyframes loadbar{
  0%{ transform:translateX(-100%); }
  50%{ transform:translateX(0%); }
  100%{ transform:translateX(100%); }
}

/* Modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:100; }
.modal-backdrop.open{ display:flex; }
.modal-card{ background:#fff; border-radius:16px; border:1px solid #e5e7eb; max-width:48rem; width:92vw; max-height:80vh; overflow:auto; box-shadow:0 24px 48px rgba(0,0,0,.18); }
.modal-head{ padding:1rem 1.25rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
.modal-body{ padding:1rem 1.25rem; }
.details-row{ border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
.details-summary{ cursor:pointer; list-style:none; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; }
.details-summary::-webkit-details-marker{ display:none; }
.kreds-list{ padding:.5rem 1rem 1rem; }
.total-row{ display:flex; align-items:center; justify-content:space-between; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; margin-bottom:.5rem; }
</style>
</head>

<body class="bg-gray-50 text-gray-900">
<!-- HEADER -->
<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="../../" class="flex items-center gap-3">
      <img src="../../Valgbar-transparent3.png" alt="Valgbar" class="h-32 w-auto" />
    </a>
  </div>

  <!-- Årstalsvælger + titel -->
  <nav aria-label="Brødkrumme" class="mx-auto max-w-6xl px-4 pb-2">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <ol class="flex items-center gap-2 text-lg font-semibold">
        <li><a href="../../" class="underline text-white">Forside</a></li>
        <li class="opacity-70 text-white">/</li>
        <li><span aria-current="page" class="text-white">Europa-Parlamentsvalg 2019</span></li>
      </ol>

      <div class="flex items-center gap-3 text-lg font-semibold">
        <label for="epYearSelect" class="text-white whitespace-nowrap">
          Skift år:
        </label>
        <select id="epYearSelect"
                class="rounded-lg bg-white text-gray-900 text-sm md:text-base px-2 py-1">
          <option value="../2024/">Europa-Parlamentsvalg 2024</option>
          <option value="../2019/" selected>Europa-Parlamentsvalg 2019</option>
          <option value="../2014/">Europa-Parlamentsvalg 2014</option>
          <option value="../2009/">Europa-Parlamentsvalg 2009</option>
          <option value="../2004/">Europa-Parlamentsvalg 2004</option>
        </select>
      </div>
    </div>
  </nav>

  <div class="mx-auto max-w-6xl px-4 pb-2">
    <div id="error" class="text-sm text-red-200"></div>
  </div>
</header>

<main class="mx-auto max-w-6xl p-4 space-y-6">

  <!-- BRODKRUMMER -->
  <div id="contextBar" class="context-bar"></div>

  <!-- VALG + SØG -->
  <section class="vb-card p-4 space-y-3">
    <div class="mt-1 grid grid-cols-1 md:grid-cols-2 gap-3 md:items-end">

      <!-- Række 1: Søg kandidat (fuld bredde) -->
      <div class="relative md:col-span-2">
        <label class="text-sm text-gray-600">Søg kandidat</label>
        <input id="candidateSearch" type="text"
               class="w-full mt-1 rounded-xl border p-2"
               placeholder="Indtast navn på kandidat…"
               autocomplete="off" />
        <div id="candidateMenu" class="vb-menu hidden" role="listbox" tabindex="-1"
             aria-labelledby="candidateSearch" style="max-width:48rem"></div>
      </div>

      <!-- Række 2: Storkreds (venstre) -->
      <div>
        <label class="text-sm text-gray-600">Storkreds</label>
        <select id="storkredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
      </div>

      <!-- Række 2: Kreds (højre) -->
      <div>
        <label class="text-sm text-gray-600">Kreds</label>
        <select id="kredsSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
      </div>

    </div>
  </section>

  <!-- TOP 10 / ALLE + PARTITOTAL -->
  <section id="overviewTop" class="vb-card p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 id="topTitle" class="font-semibold">Top 10 kandidater (personlige stemmer)</h2>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div id="topScope" class="text-sm text-gray-500"></div>
          <div id="modeInfo" class="text-xs text-gray-500 mt-0.5 hidden"></div>
        </div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnModeCand" class="vb-tabbox small active" type="button">Kandidater</button>
          <button id="btnModeParty" class="vb-tabbox small" type="button">Partitotal</button>
        </div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnTop10" class="vb-tabbox small active" type="button">Top 10</button>
          <button id="btnAll" class="vb-tabbox small" type="button">Alle kandidater</button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader-wrap hidden" aria-live="polite">
      <div class="progress w-48 rounded-full"></div>
      <span id="loaderText">Indlæser…</span>
    </div>

    <div id="topList" class="top10-grid">
      <ol id="topColLeft" class="space-y-2"></ol>
      <ol id="topColRight" class="space-y-2"></ol>
    </div>
  </section>

  <!-- PARTIER OG KANDIDATER -->
  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Partier og kandidater</h2>
      <div id="areatitle" class="text-gray-500"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <aside class="md:col-span-1 vb-card p-4 space-y-2">
        <label class="text-sm font-medium">Vælg parti</label>
        <div id="partyCombo" class="relative">
          <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
            <span id="partyButtonContent" class="vb-combo-label">
              <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
              <span class="truncate text-gray-500">Vælg storkreds først…</span>
            </span>
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0l-4.24-4.43a.75.75 0 01.02-1.06z"/></svg>
          </button>
          <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
        </div>
      </aside>

      <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
        <div class="flex items-center justify-between gap-3">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg en storkreds for at se partier.</div>
          <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
            <button id="btnSortAlpha" class="vb-tabbox small active" type="button" title="Alfabetisk">A–Å</button>
            <button id="btnSortVotes" class="vb-tabbox small" type="button" title="Flest stemmer">Flest stemmer</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div id="candidateColLeft" class="space-y-2"></div>
          <div id="candidateColRight" class="space-y-2"></div>
        </div>
      </section>
    </div>
  </section>

  <!-- SAMMENLIGNING -->
  <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenligning af kandidater</h2>
      <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
    </div>
    <div id="selectedList" class="space-y-2"></div>
  </section>

  <!-- TABEL -->
  <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
    <div class="text-sm text-gray-600">Tabel pr. valgsted</div>
    <div class="overflow-auto">
      <table class="table-sticky w-full text-sm min-w-[880px]" id="psTable">
        <thead id="psThead"></thead>
        <tbody id="psTbody"></tbody>
        <tfoot id="psTFoot"></tfoot>
      </table>
    </div>
  </section>
</main>

<!-- Kandidat-modal -->
<div id="candidateModal" class="modal-backdrop" aria-modal="true" role="dialog" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div class="min-w-0">
        <div id="candTitle" class="font-semibold truncate"></div>
        <div id="candSub" class="text-sm text-gray-500 truncate"></div>
      </div>
      <button id="candClose" class="vb-btn" type="button">Luk</button>
    </div>
    <div class="modal-body">
      <div id="candTotal" class="total-row" aria-live="polite">
        <span class="text-sm text-gray-600">Stemmer i alt</span>
        <span class="tabular-nums font-semibold" id="candTotalVal">0</span>
      </div>
      <div class="text-sm text-gray-600 mb-2">Stemmetal pr. storkreds (klik for at folde kredse ud)</div>
      <div id="candBreakdown" class="space-y-2"></div>
    </div>
  </div>
</div>

<script>
/* ====== DATA-STI (EP 2019) ====== */
const BASE_PATH = '/data/ep/2019/';

/* Storkredse (matcher dine filnavne) */
const STORKREDSE = [
  "Bornholms Storkreds","Fyns Storkreds","Københavns Omegns Storkreds","Københavns Storkreds",
  "Nordjyllands Storkreds","Nordsjællands Storkreds","Sjællands Storkreds","Sydjyllands Storkreds",
  "Vestjyllands Storkreds","Østjyllands Storkreds"
];

/* PARTIFARVER (inkl. N for 2019) */
const PARTY_COLORS = {
  "A":"#e03a3e","B":"#712082","C":"#2e7d32","D":"#0f766e","F":"#e5003d","I":"#00a0e3",
  "O":"#0044aa","V":"#1b5eaa","Ø":"#c8102e","Å":"#3aaa35","Q":"#ff4fa3","K":"#ff9800",
  "Æ":"#666666","M":"#6f42c1","N":"#009688"
};
const DEFAULT_BADGE_BG="#e5e7eb", DEFAULT_BADGE_FG="#111827";

/* Partinavn → bogstav fallback (inkl. 2019-specifikke) */
const norm = s => (s||"").toLowerCase().replace(/[–—-]/g," ").replace(/[().]/g," ").replace(/\s+/g," ").trim();
const PARTY_LETTERS_BY_NAME = {
  "socialdemokratiet":"A",
  "radikale venstre":"B","det radikale venstre":"B",
  "konservative folkeparti":"C","det konservative folkeparti":"C",
  "nye borgerlige":"D",
  "socialistisk folkeparti":"F","sf":"F","sf socialistisk folkeparti":"F","sf - socialistisk folkeparti":"F",
  "liberal alliance":"I",
  "venstre":"V","venstre, danmarks liberale parti":"V",
  "dansk folkeparti":"O",
  "enhedslisten":"Ø","enhedslisten - de rød-grønne":"Ø","enhedslisten de rød grønne":"Ø",
  "alternativet":"Å",
  "kristendemokraterne":"K","kd - kristendemokraterne":"K","kd kristendemokraterne":"K",
  "moderaterne":"M",
  "danmarksdemokraterne":"Æ",
  "frie grønne":"Q",
  "folkebevægelsen mod eu":"N","folkebevaegelsen mod eu":"N"
};
const PARTY_LETTERS_BY_NAME_NORM = Object.fromEntries(Object.entries(PARTY_LETTERS_BY_NAME).map(([k,v])=>[norm(k),v]));

/* Helpers & state */
const state = {
  rows:[], storkreds:"", kreds:"",
  activeParty:"",
  selected:new Map(),
  csvCache:new Map(),
  topListMode:"top10",
  candidateSortMode:"alpha",
  overviewMode:"cand"   // "cand" = kandidater, "party" = partitotal
};
const el = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("da-DK").format(n);
const canon = s => (s||"").toString().trim();
const escapeHtml = s => (s||"").replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const isListestemmer = name => {
  const t = canon(name).toLowerCase();
  return t==="partiliste" || t==="listestemmer" || t==="liste";
};
const cleanPollingPlaceName = (name) => canon(name).replace(/^\s*\d+\.\s*/,'').trim();
const sortKandidaterAlpha = (a,b)=>{ const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn); if(al&&!bl) return 1; if(!al&&bl) return -1; return a.kandidat_navn.localeCompare(b.kandidat_navn,"da"); };
const sortKandidaterVotes = (a,b)=>{ const al=isListestemmer(a.kandidat_navn), bl=isListestemmer(b.kandidat_navn); if(al&&!bl) return 1; if(!al&&bl) return -1; const dv=(b.total||0)-(a.total||0); if(dv!==0) return dv; return a.kandidat_navn.localeCompare(b.kandidat_navn,"da"); };
function badge(letter){ const bg=letter && PARTY_COLORS[letter] ? PARTY_COLORS[letter] : DEFAULT_BADGE_BG; const fg=letter && PARTY_COLORS[letter] ? "#fff" : DEFAULT_BADGE_FG; return { style:`background-color:${bg};color:${fg};border-color:${bg}`, text:(letter||" ") }; }

/* Partibogstav fra rækker → fallback */
function partyLetterFrom(parti, rows){
  for(const r of rows){ if(r.parti===parti){ const L=(r.parti_letter||"").toUpperCase(); if(L && PARTY_COLORS[L]) return L; } }
  const mapped = PARTY_LETTERS_BY_NAME_NORM[norm(parti)];
  if(mapped && PARTY_COLORS[mapped]) return mapped;
  return null;
}

/* Loader */
function showLoading(msg="Indlæser…"){ el('loader')?.classList.remove('hidden'); const txt = el('loaderText'); if(txt) txt.textContent = msg; el('overviewTop')?.setAttribute('aria-busy','true'); el('storkredsSelect')?.setAttribute('disabled',''); el('kredsSelect')?.setAttribute('disabled',''); }
function hideLoading(){ el('loader')?.classList.add('hidden'); el('overviewTop')?.removeAttribute('aria-busy'); el('storkredsSelect')?.removeAttribute('disabled'); if(state.storkreds) el('kredsSelect')?.removeAttribute('disabled'); }

/* ===== Kandidat-søgning (fold + rank) ===== */
const fold = (s) => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();

function buildCandidateList(rows){
  const m = new Map();
  for(const r of rows){
    if(isListestemmer(r.kandidat_navn)) continue;
    if(!m.has(r.kandidat_id)){
      m.set(r.kandidat_id, { kandidat_id:r.kandidat_id, kandidat_navn:r.kandidat_navn, parti:r.parti });
    }
  }
  return Array.from(m.values());
}

function rankCandidates(cands, q){
  const Q = fold(q);
  if(!Q) return [];
  return cands.map(c=>{
    const f = fold(c.kandidat_navn);
    let score = -Infinity;
    if(f.startsWith(Q)) score = 300 - (f.length - Q.length);
    else{
      const hasWordStart = f.split(/\s+/).some(w=>w.startsWith(Q));
      if(hasWordStart) score = 200 - f.indexOf(Q);
      else if(f.includes(Q)) score = 100 - f.indexOf(Q);
    }
    const pf = fold(c.parti);
    if(pf.startsWith(Q) || pf.includes("("+Q+")")) score += 20;
    return { ...c, _score: score };
  })
  .filter(x=>x._score>-Infinity)
  .sort((a,b)=> b._score - a._score || a.kandidat_navn.localeCompare(b.kandidat_navn, "da"))
  .slice(0, 15);
}

function initCandidateSearch(){
  const input = document.getElementById('candidateSearch');
  const menu  = document.getElementById('candidateMenu');
  if(!input || !menu) return;

  let activeIndex = -1;
  const openMenu  = ()=> menu.classList.remove('hidden');
  const closeMenu = ()=> { menu.classList.add('hidden'); activeIndex = -1; };

  function renderMenuFor(query){
    const scopeRows = getActiveRows();
    const cands = buildCandidateList(scopeRows);
    const results = rankCandidates(cands, query);
    if(!results.length){ closeMenu(); menu.innerHTML=""; return; }

    menu.innerHTML = results.map((c,i)=>{
      const L   = partyLetterFrom(c.parti, scopeRows);
      const bd  = badge(L);
      const navn= `${escapeHtml(c.kandidat_navn)}`; /* ← INGEN (bogstav) efter navnet */
      return `<div class="vb-option" role="option" data-idx="${i}" data-cand="${escapeHtml(c.kandidat_id)}" aria-selected="${i===activeIndex}">
        <span class="vb-badge" style="${bd.style}">${bd.text}</span>
        <span class="flex-1">
          <span class="font-medium">${navn}</span><br/>
          <span class="text-xs text-gray-500">${escapeHtml(c.parti)}</span>
        </span>
      </div>`;
    }).join("");

    menu.querySelectorAll('.vb-option').forEach(opt=>{ opt.onclick = ()=> selectByIndex(parseInt(opt.getAttribute('data-idx'),10)); });
    openMenu();
  }

  function selectByIndex(i){
    const scopeRows = getActiveRows();
    const cands = buildCandidateList(scopeRows);
    const results = rankCandidates(cands, input.value);
    const sel = results[i];
    if(!sel) return;
    // DK → modal; storkreds/kreds → tilføj til sammenligning
    toggleCandidateFromTop(sel.kandidat_id, scopeRows);
    closeMenu();
    input.value = "";
  }

  // Debounce input
  let t=null;
  input.addEventListener('input', ()=>{
    const q = input.value.trim();
    if(t) clearTimeout(t);
    if(!q){ closeMenu(); return; }
    t = setTimeout(()=>renderMenuFor(q), 120);
  });

  // Tastatur-navigation
  input.addEventListener('keydown', (e)=>{
    const results = rankCandidates(buildCandidateList(getActiveRows()), input.value);
    if(e.key==='ArrowDown'){
      e.preventDefault();
      if(!results.length) return;
      activeIndex = (activeIndex+1) % results.length;
      renderMenuFor(input.value);
      const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
      if(opt){ menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); opt.scrollIntoView({block:'nearest'}); }
    }else if(e.key==='ArrowUp'){
      e.preventDefault();
      if(!results.length) return;
      activeIndex = (activeIndex<=0 ? results.length-1 : activeIndex-1);
      renderMenuFor(input.value);
      const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
      if(opt){ menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); opt.scrollIntoView({block:'nearest'}); }
    }else if(e.key==='Enter'){
      if(!menu.classList.contains('hidden')){ e.preventDefault(); selectByIndex(activeIndex>=0 ? activeIndex : 0); }
    }else if(e.key==='Escape'){
      closeMenu();
    }
  });

  // Luk dropdown ved klik udenfor
  document.addEventListener('click',(e)=>{
    const box = input.parentElement;
    if(box && !box.contains(e.target)) closeMenu();
  });

  // Eksponér lukke-fn så vi kan kalde den ved scope-/data-skift
  window.__closeCandidateMenu = closeMenu;
}

/* INIT */
window.addEventListener("DOMContentLoaded", async ()=>{

  initStorkredsDropdown();
  initCandidateSearch(); // ← Søgning aktiveres

  // Årstalsvælger
  const yearSel = el("epYearSelect");
  if(yearSel){
    yearSel.addEventListener("change", ()=>{
      const url = yearSel.value;
      if(url) window.location.href = url;
    });
  }

  // Mode-knapper: kandidater / partitotal
  el("btnModeCand")?.addEventListener("click", ()=>{
    if(state.overviewMode!=="cand"){
      state.overviewMode="cand";
      updateModeToggleUI();
      updateTopToggleUI();
      renderOverview();
    }
  });
  el("btnModeParty")?.addEventListener("click", ()=>{
    if(state.overviewMode!=="party"){
      state.overviewMode="party";
      updateModeToggleUI();
      updateTopToggleUI();
      renderOverview();
    }
  });

  el("btnTop10")?.addEventListener("click", ()=>{ state.topListMode="top10"; updateTopToggleUI(); renderOverview(); });
  el("btnAll")?.addEventListener("click", ()=>{ state.topListMode="all"; updateTopToggleUI(); renderOverview(); });

  el("btnSortAlpha")?.addEventListener("click", ()=>{ state.candidateSortMode="alpha"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); });
  el("btnSortVotes")?.addEventListener("click", ()=>{ state.candidateSortMode="votes"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); });

  // URL params
  const p=new URLSearchParams(location.search), s=p.get("storkreds"), k=p.get("kreds"), cand=p.get("kandidat");
  if(s && STORKREDSE.includes(s)){
    el("storkredsSelect").value = s;
    state.storkreds = s;
    await loadStorkredsData(s);
    populateKredsDropdown(); // efter load
    if(k && k!=="__ALL__"){ el("kredsSelect").value = k; state.kreds = k; setAreaTitle(); }
    else{ el("kredsSelect").value = "__ALL__"; state.kreds = ""; setAreaTitle(); }
    if(cand) selectCandidateById(cand);
  }else{
    el("storkredsSelect").value = "";
    state.storkreds = ""; state.kreds = "";
    await loadNationalData();
  }

  el("btnClearAll")?.addEventListener('click', ()=>{ state.selected.clear(); renderAll(); });
  document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });

  renderContextBar();
  updateModeToggleUI();
  updateTopToggleUI();
  updateCandSortToggleUI();

  // Modal bindings
  (function bindCandidateModal(){
    const modal = document.getElementById('candidateModal');
    document.getElementById('candClose')?.addEventListener('click', closeCandidateModal);
    modal?.addEventListener('click', (e)=>{ if(e.target===modal) closeCandidateModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCandidateModal(); });
  })();
});

/* UI toggles */
function updateTopToggleUI(){
  const isDK = !state.storkreds;
  const isParty = state.overviewMode==="party";
  const a=el("btnTop10"), b=el("btnAll");
  if(b){
    if(isParty){
      b.textContent = "Alle partier";
    }else{
      b.textContent = isDK ? "Top 50" : "Alle kandidater";
    }
  }
  if(state.topListMode==="top10"){ a?.classList.add("active"); b?.classList.remove("active"); }
  else { b?.classList.add("active"); a?.classList.remove("active"); }
}
function updateCandSortToggleUI(){
  const a=el("btnSortAlpha"), b=el("btnSortVotes");
  if(state.candidateSortMode==="alpha"){ a?.classList.add("active"); b?.classList.remove("active"); }
  else { b?.classList.add("active"); a?.classList.remove("active"); }
}
function updateModeToggleUI(){
  const a = el("btnModeCand"),
        b = el("btnModeParty"),
        info = el("modeInfo");
  const isParty = state.overviewMode==="party";
  if(a && b){
    a.classList.toggle("active", !isParty);
    b.classList.toggle("active", isParty);
  }
  if(info){
    info.classList.toggle("hidden", !isParty);
    if(isParty){
      info.textContent = "Partitotal viser personlige stemmer + listestemmer pr. parti.";
    }
  }
}

/* Dropdowns */
function initStorkredsDropdown(){
  const ssel=el("storkredsSelect");
  ssel.innerHTML = `<option value="">Hele Danmark</option>` + STORKREDSE.map(s=>`<option value="${s}">${s}</option>`).join("");
  ssel.onchange = async ()=>{
    state.activeParty=""; state.selected.clear(); state.kreds=""; el("kredsSelect").disabled=true;
    const v=ssel.value;
    if(!v){
      const u=new URL(location.href); u.searchParams.delete("storkreds"); u.searchParams.delete("kreds"); u.searchParams.delete("kandidat"); history.replaceState({}, "", u);
      state.storkreds=""; await loadNationalData();
    }else{
      const u=new URL(location.href); u.searchParams.set("storkreds",v); u.searchParams.delete("kreds"); u.searchParams.delete("kandidat"); history.replaceState({}, "", u);
      state.storkreds=v; await loadStorkredsData(v); populateKredsDropdown();
    }
    setAreaTitle(); renderAll();
  };
  el("kredsSelect").disabled = true;
}
function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function populateKredsDropdown(){
  const ksel = el("kredsSelect");
  const kredse = unique((state.rows||[]).map(r=>r.kreds)).sort((a,b)=>a.localeCompare(b,"da"));
  const hasKreds = kredse.length>0;
  if(hasKreds){
    ksel.disabled=false;
    ksel.innerHTML = `<option value="__ALL__">Alle kredse i storkredsen</option>` + kredse.map(k=>`<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");
    ksel.onchange = ()=>{
      const v=ksel.value;
      const u=new URL(location.href);
      u.searchParams.set("storkreds", state.storkreds);
      if(v==="__ALL__"){ state.kreds=""; u.searchParams.set("kreds","__ALL__"); }
      else { state.kreds=v; u.searchParams.set("kreds", v); }
      u.searchParams.delete("kandidat");
      history.replaceState({}, "", u);
      setAreaTitle(); renderAll();
    };
  }else{
    ksel.disabled=true;
    ksel.innerHTML = `<option value="">(Ingen kredse i data)</option>`;
  }
}

/* Area title helper */
function setAreaTitle(){
  if(!state.storkreds){ el("areatitle").textContent="(Danmark)"; return; }
  if(!state.kreds){ el("areatitle").textContent=`(${state.storkreds})`; return; }
  el("areatitle").textContent=`(${state.storkreds} – ${state.kreds})`;
}

/* ======= DATA-INDLÆSNING ======= */
async function fetchCsvText(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("404"); return await r.text(); }

function parseCsvTextToRows(text, storkredsOverride=null){
  const res=Papa.parse(text,{header:true,skipEmptyLines:true,transformHeader:h=>canon(h.toLowerCase())});
  return res.data.map(r=>{
    let kandidatNavn = canon(r.kandidat_navn);
    const navnLower = kandidatNavn.toLowerCase();
    if(["partiliste","listestemmer","liste"].includes(navnLower)) kandidatNavn = "Partiliste";

    const parti = canon(r.parti);
    const rawLetter = r.parti_bogstav || r.bogstav || r.parti_kode || r['parti (bogstav)'] || r.listebogstav;
    const L = canon(rawLetter).toUpperCase();
    const parti_letter = /^[A-ZÆØÅ]$/.test(L) ? L : "";

    const storkredsNavn = storkredsOverride || canon(r.storkreds || "");
    const kredsNavn = canon(r.kreds || r.kredsnavn || "");
    const kandidat_id = `${parti.toLowerCase()}::${kandidatNavn.toLowerCase()}`;

    return {
      storkreds: storkredsNavn,
      kreds: kredsNavn,
      valgsted_id: canon(r.valgsted_id || r.afstemningssted_id || r.sted_id || `${cleanPollingPlaceName(r.valgsted_navn||r.afstemningssted||r.sted_navn)}`),
      valgsted_navn: cleanPollingPlaceName(r.valgsted_navn || r.afstemningssted || r.sted_navn),
      kandidat_id,
      kandidat_navn: kandidatNavn,
      parti,
      parti_letter,
      stemmer: Number(r.stemmer||0)||0
    };
  });
}

async function loadNationalData(){
  showLoading("Indlæser Danmark…");
  try{
    el("error").textContent=""; el("areatitle").textContent="(Danmark)";
    const all = [];
    const tasks = STORKREDSE.map(async (sk)=>{
      const s = encodeURIComponent(sk.replace(/\s+/g,'_'));
      const candidates = [`${BASE_PATH}${s}_allepartier.csv`, `${BASE_PATH}${s}.csv`];
      for(const url of candidates){
        try{
          const text = await fetchCsvText(url);
          const rows = parseCsvTextToRows(text, sk);
          state.csvCache.set(sk, rows);
          return rows;
        }catch(_){}
      }
      return [];
    });
    const settled = await Promise.allSettled(tasks);
    for(const res of settled){ if(res.status==="fulfilled" && Array.isArray(res.value)) all.push(...res.value); }
    state.rows = all;
    afterDataLoaded();
    if(!all.length){ el("error").textContent = "Kunne ikke indlæse landsdata (ingen filer fundet)."; }
  } finally { hideLoading(); }
}

async function loadStorkredsData(storkreds){
  showLoading("Indlæser…");
  try{
    el("error").textContent="";
    if(state.csvCache.has(storkreds)){ state.rows = state.csvCache.get(storkreds).slice(); afterDataLoaded(); return; }
    const s = encodeURIComponent(storkreds.replace(/\s+/g,'_'));
    const candidates = [`${BASE_PATH}${s}_allepartier.csv`, `${BASE_PATH}${s}.csv`];
    for(const url of candidates){
      try{
        const text = await fetchCsvText(url);
        const rows = parseCsvTextToRows(text, storkreds);
        state.csvCache.set(storkreds, rows);
        state.rows = rows.slice();
        afterDataLoaded();
        return;
      }catch(_){}
    }
    el("error").textContent = `Kunne ikke finde data for ${storkreds}.`;
  } finally { hideLoading(); }
}

/* Efter data indlæst */
function afterDataLoaded(){
  state.activeParty="";
  renderPartyCombobox();
  renderAll();
  renderContextBar();
  // Luk søge-dropdown hvis åben, så den ikke hænger ved scope-skift
  try{ window.__closeCandidateMenu && window.__closeCandidateMenu(); }catch(_){}
}

/* Filterede “aktive” rækker ift. kreds */
function getActiveRows(){
  if(!state.storkreds) return state.rows;
  if(!state.kreds) return state.rows.filter(r=>r.storkreds===state.storkreds);
  return state.rows.filter(r=>r.storkreds===state.storkreds && r.kreds===state.kreds);
}

/* ======= OVERVIEW (Top 10 / Alle / Top 50 + PARTITOTAL) ======= */
function totalsByCandidate(rows){
  const m=new Map();
  for(const r of rows){
    if(!m.has(r.kandidat_id)){
      m.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
    }
    m.get(r.kandidat_id).total += r.stemmer;
  }
  return Array.from(m.values())
    .filter(k=>!isListestemmer(k.kandidat_navn))
    .sort((a,b)=>b.total-a.total);
}

// Partitotal: personlige + listestemmer pr. parti
function totalsByPartyAllVotes(rows){
  const m = new Map();
  for(const r of rows){
    const parti = r.parti || "(ukendt parti)";
    m.set(parti, (m.get(parti)||0) + (r.stemmer || 0));
  }
  const entries = Array.from(m.entries()).map(([parti,total])=>{
    const rowsForParti = rows.filter(x=>x.parti===parti);
    const letter = partyLetterFrom(parti, rowsForParti);
    return { parti, total, letter };
  });
  entries.sort((a,b)=>(b.total-a.total) || a.parti.localeCompare(b.parti,"da"));
  return entries;
}

function renderOverview(){
  const rowsRaw = getActiveRows();
  const isDK = !state.storkreds;
  const scopeText = isDK ? "Danmark" : (state.kreds ? `${state.storkreds} / ${state.kreds}` : `${state.storkreds} / Alle kredse i storkredsen`);
  el("topScope").textContent = rowsRaw.length ? scopeText : "";

  // PARTITOTAL MODE
  if(state.overviewMode==="party"){
    const ranked = totalsByPartyAllVotes(rowsRaw);
    const isTop10 = state.topListMode==="top10";
    const list = isTop10 ? ranked.slice(0,10) : ranked;

    el("topTitle").textContent = isTop10
      ? "Top 10 partier (personlige + listestemmer)"
      : "Alle partier (personlige + listestemmer)";

    function partyItemHTML(p, idx){
      const bd = badge(p.letter);
      const meta = `${fmt(p.total)} stemmer i alt (personlige + liste)`;
      return `<li class="top10-item" data-parti="${escapeHtml(p.parti)}" role="button" tabindex="0">
        <span class="rank-pill">${idx}</span>
        <div class="min-w-0 flex-1">
          <div class="font-medium truncate">${escapeHtml(p.parti)}</div>
          <div class="text-xs text-gray-500 truncate">${meta}</div>
        </div>
        <span class="vb-badge" style="${bd.style}">${bd.text}</span>
      </li>`;
    }

    const half = Math.ceil(list.length/2);
    const left = list.slice(0,half);
    const right = list.slice(half);

    el("topColLeft").innerHTML =
      left.map((p,i)=>partyItemHTML(p,i+1)).join("") ||
      `<div class="text-sm text-gray-500">Ingen data at vise.</div>`;
    el("topColRight").innerHTML =
      right.map((p,i)=>partyItemHTML(p,i+1+half)).join("");

    // Klik på parti → vælg i combobox (kun når vi er i en storkredsvisning)
    if(state.storkreds){
      ['topColLeft','topColRight'].forEach(rootId=>{
        document.getElementById(rootId).querySelectorAll('.top10-item').forEach(item=>{
          const parti=item.getAttribute('data-parti');
          const activate = ()=>{
            state.activeParty = parti;
            renderPartyCombobox();
            renderPartyDetail(parti);
            const u=new URL(location.href);
            u.searchParams.set("storkreds", state.storkreds);
            u.searchParams.set("kreds", state.kreds || "__ALL__");
            history.replaceState({}, "", u);
            document.getElementById('partyDetail')?.scrollIntoView({behavior:'smooth'});
          };
          item.addEventListener('click', activate);
          item.addEventListener('keydown',(e)=>{
            if(e.key==='Enter'||e.key===' '){
              e.preventDefault();
              activate();
            }
          });
        });
      });
    }

    return;
  }

  // KANDIDAT-MODE (som før)
  const ranked = totalsByCandidate(rowsRaw);
  let list;
  if(state.topListMode==="top10"){
    list = ranked.slice(0,10);
    el("topTitle").textContent = "Top 10 kandidater (personlige stemmer)";
  }else{
    if(isDK){
      list = ranked.slice(0,50);
      el("topTitle").textContent = "Top 50 kandidater (personlige stemmer)";
    }else{
      list = ranked;
      el("topTitle").textContent = "Alle kandidater (personlige stemmer)";
    }
  }

  function itemHTML(k, idx){
    const letter = partyLetterFrom(k.parti, rowsRaw);
    const bd = badge(letter);
    const meta = `${escapeHtml(k.parti)} · ${fmt(k.total)} stemmer`;
    const title = isDK ? 'Klik for at se fordeling' : 'Klik for at tilføje til sammenligning';
    const navn = `${escapeHtml(k.kandidat_navn)}`; /* ← INGEN (bogstav) */
    return `<li class="top10-item" data-cand="${escapeHtml(k.kandidat_id)}" role="button" tabindex="0" title="${title}">
      <span class="rank-pill">${idx}</span>
      <div class="min-w-0 flex-1">
        <div class="font-medium truncate">${navn}</div>
        <div class="text-xs text-gray-500 truncate">${meta}</div>
      </div>
      <span class="vb-badge" style="${bd.style}">${bd.text}</span>
    </li>`;
  }

  const half=Math.ceil(list.length/2), left=list.slice(0,half), right=list.slice(half);
  el("topColLeft").innerHTML = left.map((k,i)=>itemHTML(k,i+1)).join("") || `<div class="text-sm text-gray-500">Ingen data at vise.</div>`;
  el("topColRight").innerHTML = right.map((k,i)=>itemHTML(k,i+1+half)).join("");

  const bind=(rootId)=>{
    document.getElementById(rootId).querySelectorAll('.top10-item').forEach(item=>{
      const candId=item.getAttribute('data-cand');
      item.addEventListener('click', ()=>toggleCandidateFromTop(candId, rowsRaw));
      item.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleCandidateFromTop(candId, rowsRaw); } });
    });
  };
  bind('topColLeft'); bind('topColRight');
}

/* ==== Modal: nationalt overblik for kandidat ==== */
function aggregateCandidateEverywhere(candidateId){
  const allRows = [];
  for(const sk of STORKREDSE){
    const cached = state.csvCache.get(sk);
    if(cached && cached.length) allRows.push(...cached);
  }
  if(!allRows.length) allRows.push(...state.rows);

  const perSK = new Map();
  let sampleRow = null;
  for(const r of allRows){
    if(r.kandidat_id !== candidateId) continue;
    if(!sampleRow) sampleRow = r;
    const sk = r.storkreds || '(Ukendt storkreds)';
    const kr = r.kreds || '(Ukendt kreds)';
    if(!perSK.has(sk)) perSK.set(sk, { total:0, kredse:new Map() });
    const bucket = perSK.get(sk);
    bucket.total += r.stemmer||0;
    bucket.kredse.set(kr, (bucket.kredse.get(kr)||0) + (r.stemmer||0));
  }

  const items = Array.from(perSK.entries()).map(([storkreds, data])=>{
    const kredse = Array.from(data.kredse.entries()).sort((a,b)=>b[1]-a[1]);
    return { storkreds, total:data.total, kredse };
  }).sort((a,b)=>b.total-a.total);

  return { items, sampleRow };
}
function openCandidateModal(candidateId){
  const { items, sampleRow } = aggregateCandidateEverywhere(candidateId);
  const modal = document.getElementById('candidateModal');
  const title = document.getElementById('candTitle');
  const sub = document.getElementById('candSub');
  const body = document.getElementById('candBreakdown');
  const totalBox = document.getElementById('candTotalVal');

  if(!sampleRow){ return; }
  const rowsForLetter = state.rows.length ? state.rows : (state.csvCache.get(sampleRow.storkreds)||[]);
  /* vi viser IKKE (bogstav) efter navnet i modalens titel */
  const nameOnly = sampleRow.kandidat_navn;

  title.textContent = nameOnly;
  sub.textContent = sampleRow.parti;

  const grandTotal = items.reduce((acc,it)=>acc+it.total,0);
  totalBox.textContent = fmt(grandTotal);

  body.innerHTML = items.length
    ? items.map(item=>{
        const sk = item.storkreds;
        const total = fmt(item.total);
        const kredsList = item.kredse.map(([k, sum])=>`
          <div class="flex items-center justify-between py-1">
            <div class="text-sm">${escapeHtml(k)}</div>
            <div class="tabular-nums font-medium">${fmt(sum)}</div>
          </div>
        `).join('');
        return `
          <details class="details-row">
            <summary class="details-summary">
              <span class="font-medium">${escapeHtml(sk)}</span>
              <span class="tabular-nums font-semibold">${total}</span>
            </summary>
            <div class="kreds-list">
              <div class="text-xs text-gray-500 mb-1">Stemmer pr. kreds</div>
              ${kredsList || `<div class="text-sm text-gray-500">Ingen kredsdata</div>`}
              <div class="mt-2">
                <button class="vb-btn" data-goto-stk="${escapeHtml(sk)}">Se i storkreds</button>
              </div>
            </div>
          </details>
        `;
      }).join('')
    : `<div class="text-sm text-gray-500">Ingen data fundet for kandidaten.</div>`;

  body.querySelectorAll('button[data-goto-stk]').forEach(btn=>{
    btn.onclick = ()=>{
      const sk = btn.getAttribute('data-goto-stk');
      closeCandidateModal();
      gotoScope(sk, null, candidateId);
    };
  });

  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}
function closeCandidateModal(){
  const modal = document.getElementById('candidateModal');
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
}

/* Klik-adfærd fra top-listen */
function toggleCandidateFromTop(candId, rows){
  if(!state.storkreds){
    openCandidateModal(candId); // DK: vis modal i stedet for at hoppe
    return;
  }
  const sample = rows.find(r=>r.kandidat_id===candId);
  if(!sample) return;
  if(state.selected.has(candId)){ state.selected.delete(candId); renderAll(); return; }
  state.selected.set(candId,{ kandidat_id:candId, kandidat_navn: sample.kandidat_navn, parti: sample.parti });
  renderAll();
  document.getElementById('compareSection')?.scrollIntoView({behavior:'smooth', block:'start'});
}

function selectCandidateById(candId){
  const sample = getActiveRows().find(r=>r.kandidat_id===candId) || state.rows.find(r=>r.kandidat_id===candId);
  if(!sample) return;
  if(!state.selected.has(candId)){
    state.selected.set(candId, { kandidat_id:candId, kandidat_navn: sample.kandidat_navn, parti: sample.parti });
  }
  renderAll();
  document.getElementById('compareSection')?.scrollIntoView({behavior:'smooth', block:'start'});
}

function gotoScope(storkredsName, kredsName=null, candidateId=null){
  const u=new URL(location.href);
  u.searchParams.set("storkreds", storkredsName);
  if(kredsName) u.searchParams.set("kreds", kredsName); else u.searchParams.set("kreds","__ALL__");
  if(candidateId) u.searchParams.set("kandidat", candidateId); else u.searchParams.delete("kandidat");
  history.replaceState({}, "", u);

  el("storkredsSelect").value = storkredsName;
  state.storkreds = storkredsName;

  loadStorkredsData(storkredsName).then(()=>{
    populateKredsDropdown();
    if(kredsName){ el("kredsSelect").value = kredsName; state.kreds = kredsName; }
    else { el("kredsSelect").value = "__ALL__"; state.kreds = ""; }
    setAreaTitle();
    if(candidateId) selectCandidateById(candidateId);
    else { renderAll(); renderContextBar(); }
  });
}

/* ======= PARTI-COMBOBOX ======= */
function getPartyStats(){
  const rows = getActiveRows();
  const byParti=new Map();
  for(const r of rows){ if(!byParti.has(r.parti)) byParti.set(r.parti,[]); byParti.get(r.parti).push(r); }
  const res=[];
  for(const [parti,rowsP] of byParti.entries()){
    const map=new Map();
    for(const r of rowsP){
      if(!map.has(r.kandidat_id)) map.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
      map.get(r.kandidat_id).total+=r.stemmer;
    }
    const kandidater=Array.from(map.values());
    const letter = partyLetterFrom(parti, rowsP);
    res.push({ parti, letter, hasLetter: !!letter, kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length, kandidater });
  }
  res.sort((a,b)=>{ if(a.hasLetter!==b.hasLetter) return a.hasLetter?-1:1; if(a.hasLetter&&b.hasLetter) return a.letter.localeCompare(b.letter,"da"); return a.parti.localeCompare(b.parti,"da"); });
  return res;
}

function renderPartyCombobox(){
  const stats=getPartyStats(), btn=el("partyButton"), btnc=el("partyButtonContent"), menu=el("partyMenu");
  if(!state.storkreds){
    btn.disabled=true;
    btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg storkreds først…</span>`;
    menu.innerHTML="";
    el("partyDetailHeader").textContent="Vælg en storkreds for at se partier.";
    el("candidateColLeft").innerHTML=""; el("candidateColRight").innerHTML="";
    return;
  }
  if(!stats.length){
    btn.disabled=true;
    btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Ingen partier fundet</span>`;
    menu.innerHTML="";
    return;
  }
  btn.disabled=false;
  function renderButton(){
    if(!state.activeParty){
      btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`;
      return;
    }
    const cur=stats.find(s=>s.parti===state.activeParty);
    const {style,text}=badge(cur?.letter||null);
    btnc.innerHTML=`<span class="vb-badge" style="${style}">${text}</span><span class="truncate">${escapeHtml(state.activeParty)}</span>`;
  }
  function renderMenu(){
    menu.innerHTML=stats.map(s=>{
      const {style,text}=badge(s.letter);
      const sel=s.parti===state.activeParty;
      return `<div class="vb-option" role="option" data-parti="${escapeHtml(s.parti)}" aria-selected="${sel}">
        <span class="vb-badge" style="${style}">${text}</span>
        <span class="flex-1">${escapeHtml(s.parti)}</span>
        <span class="text-xs text-gray-500">${s.kandidatAntal} kandidater</span>
      </div>`;
    }).join("");
    menu.querySelectorAll('.vb-option').forEach((opt)=>{
      opt.onclick=()=>{
        state.activeParty=opt.getAttribute('data-parti'); renderButton(); closePartyMenu(); renderPartyDetail(state.activeParty);
      };
    });
  }
  btn.onclick=()=>{ const open=btn.getAttribute('aria-expanded')==='true'; if(open) closePartyMenu(); else { renderMenu(); openPartyMenu(); } };
  function openPartyMenu(){ btn.setAttribute('aria-expanded','true'); menu.classList.remove('hidden'); menu.focus(); }
  function closePartyMenu(){ btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
  window.closePartyMenu=closePartyMenu;

  renderButton();
  el("partyDetailHeader").textContent = "Vælg et parti i drop-down menuen.";
  el("candidateColLeft").innerHTML = ""; el("candidateColRight").innerHTML = "";
}

function renderPartyDetail(parti){
  const header=el("partyDetailHeader"), left=el("candidateColLeft"), right=el("candidateColRight");
  left.innerHTML=""; right.innerHTML="";
  if(!parti){ header.textContent="Vælg et parti i drop-down menuen."; return; }
  header.textContent=parti;

  const kandidaterAll=getPartyStats().find(x=>x.parti===parti)?.kandidater||[];
  const sorted = kandidaterAll.slice().sort(state.candidateSortMode==='alpha' ? sortKandidaterAlpha : sortKandidaterVotes);

  const mid=Math.ceil(sorted.length/2), leftArr=sorted.slice(0,mid), rightArr=sorted.slice(mid);

  function addCandidate(k){
    if(!state.storkreds){
      // På DK-niveau bruger vi modal-flow (via top-listen), så ingen navigation her.
      return;
    }
    state.selected.set(k.kandidat_id,{kandidat_id:k.kandidat_id,kandidat_navn:k.kandidat_navn,parti:k.parti});
    renderAll();
  }

  function card(k){
    const listestemmer=isListestemmer(k.kandidat_navn);
    const subtitle = listestemmer ? `${fmt(k.total)} listestemmer` : `${fmt(k.total)} stemmer i alt`;
    const meta = `${escapeHtml(k.parti)} · ${subtitle}`;
    const letterHere = partyLetterFrom(k.parti, getActiveRows());
    const navn = `${escapeHtml(k.kandidat_navn)}`; /* ← INGEN (bogstav) */

    const div=document.createElement('div');
    div.className='rounded-xl border px-3 py-2';
    div.innerHTML=`<div class="flex items-center justify-between">
      <div>
        <div class="font-medium">${navn}</div>
        <div class="text-xs text-gray-500">${meta}</div>
      </div>
      <button class="vb-btn" data-add="${k.kandidat_id}">${state.storkreds?'Tilføj':'Se i storkreds'}</button>
    </div>`;
    div.querySelector('button[data-add]').onclick=()=>addCandidate(k);
    return div;
  }
  leftArr.forEach(k=>left.appendChild(card(k)));
  rightArr.forEach(k=>right.appendChild(card(k)));
}

/* ======= SAMLET RENDER ======= */
function renderAll(){
  renderSelected();
  renderPsTable(getPollingStations(), getSelectedOrdered());

  const showCompare = state.storkreds && getSelected().length>0;
  el("compareSection").classList.toggle("hidden", !showCompare);
  el("tabsCard").classList.toggle("hidden", !showCompare);

  renderOverview();
  renderContextBar();
}

function computeTotalsByCandidate(){
  const m=new Map();
  for(const r of getActiveRows()) m.set(r.kandidat_id,(m.get(r.kandidat_id)||0)+r.stemmer);
  return m;
}
function stemmerLabel(n){ return n===1 ? 'stemme' : 'stemmer'; }

function renderSelected(){
  const root=el("selectedList"), totals=computeTotalsByCandidate(), sel=getSelectedOrdered();
  function letterForParti(parti){ return partyLetterFrom(parti, getActiveRows()); }
  root.innerHTML = sel.map(k=>{
    const L = letterForParti(k.parti);
    const bd=badge(L), total=totals.get(k.kandidat_id)||0;
    const listestemmer=isListestemmer(k.kandidat_navn);
    const totalTekst=listestemmer?`${fmt(total)} ${total===1?'listestemme':'listestemmer'}`:`${fmt(total)} personlige ${stemmerLabel(total)} i alt`;
    const navn = `${escapeHtml(k.kandidat_navn)}`; /* ← INGEN (bogstav) */
    return `<div class="rounded-xl border p-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="vb-badge" style="${bd.style}">${bd.text}</span>
        <div class="font-medium">${navn} <span class="text-gray-500">(${escapeHtml(k.parti)})</span></div>
      </div>
      <div class="flex items-center gap-3">
        <div class="tabular-nums font-medium">${totalTekst}</div>
        <button class="vb-btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
      </div>
    </div>`;
  }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;
  el("btnClearAll").disabled = sel.length===0;
}
window.removeCandidate = id => { state.selected.delete(id); renderAll(); };
const getSelected = () => Array.from(state.selected.values());
const getSelectedOrdered = () => { const s=getSelected().slice(); s.sort(sortKandidaterAlpha); return s; };

/* ======= VALGSTEDER & TABEL ======= */
function getPollingStations(){
  const rows = getActiveRows();
  const m=new Map();
  for(const r of rows){
    const key = `${r.storkreds||""}::${r.kreds||""}::${r.valgsted_id}`;
    if(!m.has(key)) m.set(key,{
      id:key,
      navn:cleanPollingPlaceName(r.valgsted_navn),
      storkreds:r.storkreds||"",
      kreds:r.kreds||""
    });
    const ps=m.get(key);
    ps[r.kandidat_id]=(ps[r.kandidat_id]||0)+r.stemmer;
  }
  return Array.from(m.values()).sort((a,b)=>{
    if(a.storkreds!==b.storkreds) return a.storkreds.localeCompare(b.storkreds,"da");
    if(a.kreds!==b.kreds) return a.kreds.localeCompare(b.kreds,"da");
    return a.navn.localeCompare(b.navn,"da");
  });
}

function renderPsTable(psList, sel){
  const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
  const isDK = !state.storkreds;
  const baseCols = ['Valgsted', ...(isDK?['Storkreds']:[]), 'Kreds'];

  if(!sel.length){
    thead.innerHTML=`<tr class="text-left">${baseCols.map(c=>`<th class="py-2 pr-3">${c}</th>`).join('')}</tr>`;
    tbody.innerHTML=""; tfoot.innerHTML="";
    return;
  }

  const header = sel.map(s=>{
    const L = partyLetterFrom(s.parti, getActiveRows());
    const bd = badge(L);
    const navn = `${escapeHtml(s.kandidat_navn)}`; /* ← INGEN (bogstav) */
    return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
      <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
      <span>${navn} (${escapeHtml(s.parti)})</span></div></th>`;
  }).join("");
  thead.innerHTML=`<tr class="text-left border-b">
    ${baseCols.map(c=>`<th class="py-2 pr-3">${c}</th>`).join('')}
    ${header}
  </tr>`;

  const rowsHtml = [];
  for(const ps of psList){
    if(state.storkreds && ps.storkreds && ps.storkreds!==state.storkreds) continue;
    if(state.kreds && ps.kreds!==state.kreds) continue;
    rowsHtml.push(
      `<tr class="border-b last:border-0">
        <td class="py-2 pr-3 font-medium">${escapeHtml(ps.navn)}</td>
        ${isDK?`<td class="py-2 pr-3">${escapeHtml(ps.storkreds||"")}</td>`:""}
        <td class="py-2 pr-3">${escapeHtml(ps.kreds||"")}</td>
        ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums">${fmt(ps[s.kandidat_id]||0)}</td>`).join("")}
      </tr>`
    );
  }
  tbody.innerHTML = rowsHtml.join("");

  const totals=computeTotalsByCandidate();
  const extra = isDK ? `(${fmt(psList.length)} rækker)` : "";
  tfoot.innerHTML=`<tr class="border-t">
    <th class="py-2 pr-3 text-left">Samlet</th>
    ${isDK?`<th class="py-2 pr-3 text-left text-gray-500">${extra}</th>`:""}
    <th class="py-2 pr-3"></th>
    ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("")}
  </tr>`;
}

/* ======= BRODKRUMMER ======= */
function renderContextBar(){
  const bar = document.getElementById('contextBar');
  const parts = [];
  // DK
  parts.push(!state.storkreds ? `<span class="crumb-strong">Hele Danmark</span>` : `<span class="crumb" data-nav="dk">Hele Danmark</span>`);
  // Storkreds
  if(state.storkreds){
    parts.push(`<span class="sep">/</span>`);
    parts.push(!state.kreds ? `<span class="crumb-strong">${escapeHtml(state.storkreds)}</span>` : `<span class="crumb" data-nav="storkreds">${escapeHtml(state.storkreds)}</span>`);
  }
  // Kreds
  if(state.storkreds && state.kreds){
    parts.push(`<span class="sep">/</span>`);
    parts.push(`<span class="crumb-strong">${escapeHtml(state.kreds)}</span>`);
  }
  bar.innerHTML = parts.join("");

  // Klik: Hele Danmark
  bar.querySelector('[data-nav="dk"]')?.addEventListener('click', async ()=>{
    state.selected.clear(); state.activeParty="";
    try{ closePartyMenu(); }catch(_){}
    el("storkredsSelect").value=""; el("kredsSelect").innerHTML=`<option value="">(Vælg storkreds for at vælge kreds)</option>`; el("kredsSelect").disabled=true;
    const u=new URL(location.href); u.searchParams.delete("storkreds"); u.searchParams.delete("kreds"); u.searchParams.delete("kandidat"); history.replaceState({}, "", u);
    state.storkreds=""; state.kreds=""; await loadNationalData(); setAreaTitle(); renderAll();
  });

  // Klik: tilbage til storkreds (fra kreds)
  bar.querySelector('[data-nav="storkreds"]')?.addEventListener('click', ()=>{
    el("kredsSelect").value="__ALL__";
    const u=new URL(location.href);
    u.searchParams.set("storkreds", state.storkreds);
    u.searchParams.set("kreds","__ALL__");
    u.searchParams.delete("kandidat");
    history.replaceState({}, "", u);
    state.kreds=""; setAreaTitle(); renderAll();
  });
}

/* Utils */
function closePartyMenu(){ const btn=el('partyButton'), menu=el('partyMenu'); btn?.setAttribute('aria-expanded','false'); menu?.classList.add('hidden'); }
</script>
</body>
</html>
