<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Vælg valg</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --vb-navy:#234a5a; --vb-navy-2:#1f4352; }
    .vb-hero{
      background: linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%);
      color:#fff;
    }
    .vb-row{
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(16,24,40,.04);
    }
    .vb-row:hover{ box-shadow:0 4px 14px rgba(0,0,0,.06); }
    .vb-chevron{ transition: transform .2s ease; }
    .vb-open .vb-chevron{ transform: rotate(180deg); }
    .vb-body{
      overflow:hidden;
      transition:grid-template-rows .25s ease, padding .2s ease;
      display:grid;
      grid-template-rows:0fr;
    }
    .vb-open .vb-body{ grid-template-rows:1fr; }
    .vb-body > div{ min-height:0; }
    .vb-yearbtn{
      display:flex; align-items:center; justify-content:center;
      padding:.8rem 1rem; border:1px solid #e5e7eb; border-radius:10px; background:#fff; font-weight:600;
    }
    .vb-yearbtn:hover{ background:#f3f4f6; }
    .vb-yearbtn[aria-disabled="true"]{ opacity:.6; cursor:not-allowed; }

    /* Kandidatsøgning – input i samme stil som årsknapperne */
    .vb-search-input{
      width:100%;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:.8rem 1rem;
      background:#fff;
      font-weight:500;
      font-size:0.95rem;
    }
    .vb-search-input::placeholder{
      color:#9ca3af;
      font-weight:400;
    }

    .vb-search-panel{
      background: linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 1px 2px rgba(16,24,40,.04);
    }

    .vb-search-results{
      position:absolute;
      z-index:30;
      margin-top:.25rem;
      width:100%;
      max-height:18rem;
      overflow:auto;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(15,23,42,.15);
    }
    .vb-search-item{
      padding:.5rem .75rem;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:0.1rem;
    }
    .vb-search-item:hover,
    .vb-search-item[aria-selected="true"]{
      background:#f3f4f6;
    }
    .vb-search-item-title{
      font-size:0.9rem;
      font-weight:600;
      color:#111827;
    }
    .vb-search-item-meta{
      font-size:0.8rem;
      color:#6b7280;
    }
    .vb-search-status{
      font-size:0.8rem;
      color:#6b7280;
      padding:.5rem .75rem;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- HEADER -->
  <header class="vb-hero">
    <div class="mx-auto max-w-6xl px-4 pt-8 pb-3">
      <a href="./" aria-label="Valgbar" class="inline-block">
        <img src="Valgbar-transparent3.png" alt="Valgbar" class="h-28 md:h-32 w-auto" />
      </a>
    </div>

    <div class="border-t border-white/20"></div>
  </header>

  <!-- INDHOLD -->
  <main class="mx-auto max-w-5xl p-4 md:p-6 space-y-4">

    <!-- KANDIDATSØGNING -->
    <section class="space-y-2">
      <div class="vb-search-panel px-4 md:px-5 py-4">
        <label for="candidateSearchInput" class="block text-sm font-medium text-slate-800 mb-2">
          Søg efter en kandidat
        </label>
        <div class="relative">
          <input
            id="candidateSearchInput"
            type="text"
            class="vb-search-input"
            placeholder="Søg efter en kandidat..."
            autocomplete="off"
          />
          <div id="candidateSearchResults" class="vb-search-results hidden" role="listbox" aria-label="Kandidater"></div>
        </div>
        <p class="mt-2 text-xs text-slate-500">
          Tip: Skriv fx <strong>Line</strong>, og få vist alle kandidater med navnet Line på tværs af valg.
        </p>
      </div>
    </section>

    <!-- LISTE OVER VALG -->
    <section id="list" class="space-y-3">
      <!-- Rækker indsprøjtes af JS -->
    </section>
  </main>

  <footer class="mt-10 border-t bg-gray-100">
    <div class="mx-auto max-w-6xl px-4 py-6 md:py-8
                flex flex-col md:flex-row items-center justify-between
                gap-3 md:gap-6 text-sm md:text-base text-gray-700">
      
      <a href="mailto:hej@valgbar.dk" class="font-medium hover:text-gray-900">
        hej@valgbar.dk
      </a>

      <p class="text-center">
        Data stammer fra KMDValg, Danmarks Statistik og valg.dk
      </p>

      <a href="/om-valgbar/" class="font-medium underline hover:text-gray-900">
        Om Valgbar
      </a>
    </div>
  </footer>

  <script>
    /* ====== KONFIG FOR VALGLISTE ====== */
    const YEARS = {
      // FT: 2007, 2011, 2015, 2019, 2022 (2005 fjernet)
      ft: [2022, 2019, 2015, 2011, 2007],
      // KV: 2021, 2017, 2013, 2009, 2005 (2001 fjernet)
      kv: [2021, 2017, 2013, 2009, 2005],
      // RV: 2021, 2017 (2013 fjernet)
      rv: [2021, 2017],
      // EP: 2009, 2014, 2019, 2024 (2004 fjernet)
      ep: [2024, 2019, 2014, 2009],
      // FA: Folkeafstemning
      fa: [2022, 2015, 2014]
    };

    // Ingen år er pt. deaktiveret
    const DISABLED = {
      // tom
    };

    // Brug relative stier så de virker i undermapper
    const DEST = {
      kv: { perYear: {
        2021: 'kv/2021/',
        2017: 'kv/2017/',
        2013: 'kv/2013/',
        2009: 'kv/2009/',
        2005: 'kv/2005/',
        2001: 'kv/2001/'   // må gerne blive, selv om 2001 ikke vises i YEARS
      }},
      ft: { perYear: {
        2022: 'ft/2022/',
        2019: 'ft/2019/',
        2015: 'ft/2015/',
        2011: 'ft/2011/',
        2007: 'ft/2007/',
        2005: 'ft/2005/'
      }},
      rv: { perYear: {
        2021: 'rv/2021/',
        2017: 'rv/2017/',
        2013: 'rv/2013/'
      }},
      ep: { perYear: {
        2024: 'ep/2024/',
        2019: 'ep/2019/',
        2014: 'ep/2014/',
        2009: 'ep/2009/',
        2004: 'ep/2004/'
      }},
      // Folkeafstemning – aktiveret med dine stier
      fa: { perYear: {
        2022: 'fa/2022/',
        2015: 'fa/2015/',
        2014: 'fa/2014/'
      }}
    };

    const TITLES = {
      ft:'Folketingsvalg',
      kv:'Kommunalvalg',
      rv:'Regionsrådsvalg',
      ep:'Europa-Parlamentsvalg',
      fa:'Folkeafstemning'
    };

    // rækkefølge på forsiden
    const ORDER = ['ft','kv','rv','ep','fa'];

    /* ====== RENDER VALGLISTE ====== */
    const root = document.getElementById('list');

    ORDER.forEach(type=>{
      const years = YEARS[type] || [];
      const article = document.createElement('article');
      article.className = 'vb-row';

      article.innerHTML = `
        <button type="button"
                class="w-full flex items-center gap-3 px-4 md:px-5 py-4 text-left"
                aria-expanded="false"
                data-acc="${type}">
          <h2 class="text-base md:text-lg font-semibold text-slate-800 flex-1">${TITLES[type]}</h2>
          <svg class="vb-chevron h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path d="M5.23 7.21a.75.75 0 011.06.02L10 11.1l3.71-3.87a.75.75 0 111.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0L5.27 8.27a.75.75 0 01-.04-1.06z"/>
          </svg>
        </button>

        <div class="vb-body">
          <div>
            <div class="px-4 md:px-5 pt-0 pb-4">
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                ${years.map(y=>{
                  const isDisabled = DISABLED[type]?.includes(y);
                  const hasUrl = !!DEST[type]?.perYear?.[y];
                  const active = hasUrl && !isDisabled;
                  const url = active ? DEST[type].perYear[y] : '#';
                  return `<a class="vb-yearbtn"
                               href="${url}"
                               data-type="${type}" data-year="${y}"
                               aria-disabled="${active ? 'false':'true'}">${y}</a>`;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      root.appendChild(article);
    });

    /* ====== INTERAKTION FOR VALGLISTE ====== */
    root.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-acc]');
      if(btn){
        const article = btn.closest('article');
        const open = article.classList.toggle('vb-open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
        if(open){
          document.querySelectorAll('#list article.vb-open').forEach(el=>{
            if(el!==article){
              el.classList.remove('vb-open');
              el.querySelector('[data-acc]').setAttribute('aria-expanded','false');
            }
          });
        }
      }
    });

    root.addEventListener('keydown', (e)=>{
      const btn = e.target.closest('[data-acc]');
      if(btn && (e.key==='Enter' || e.key===' ')){
        e.preventDefault(); btn.click();
      }
    });

    root.addEventListener('click', (e)=>{
      const link = e.target.closest('.vb-yearbtn');
      if(!link) return;
      const active = link.getAttribute('aria-disabled') === 'false';
      if(!active){
        e.preventDefault();
        const type = link.getAttribute('data-type');
        const year = link.getAttribute('data-year');
        alert(`${TITLES[type]} ${year} er ikke aktiveret endnu.`);
      }
    });

    /* ==========================================================
       KANDIDATSØGNING (bruger /data/candidate-index.json)
       ========================================================== */

    // Simple helper til at fjerne æøå-variationer osv.
    function foldStr(s){
      return (s || "")
        .toString()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu,"")
        .toLowerCase()
        .trim();
    }

    const candidateInput   = document.getElementById('candidateSearchInput');
    const candidateResults = document.getElementById('candidateSearchResults');

    let candidateIndexData = null;      // rå JSON fra /data/candidate-index.json
    let candidateFlatList  = [];        // fladet liste (kandidat + valg)
    let activeSuggestion   = -1;
    let lastQuery          = "";

    function fmtNumber(n){
      return new Intl.NumberFormat('da-DK').format(n);
    }

    function stemmerLabel(n){
      return n === 1 ? 'stemme' : 'stemmer';
    }

    async function loadCandidateIndexOnce(){
      if(candidateIndexData || candidateIndexData === false) return;
      try{
        const res = await fetch('/data/candidate-index.json',{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        candidateIndexData = json;

        const flat = [];
        (json.elections || []).forEach(e=>{
          const candidates = e.candidates || [];
          candidates.forEach(c=>{
            flat.push({
              electionKey: e.key,
              electionType: e.type,
              electionYear: e.year,
              electionLabel: e.typeLabel || e.label || '',
              electionDetailUrl: e.detailUrl || '#',
              record: c
            });
          });
        });
        candidateFlatList = flat;
      }catch(err){
        console.error('Kunne ikke hente kandidatindeks', err);
        candidateIndexData = false; // marker fejl
      }
    }

    function buildSearchText(rec){
      const r = rec || {};
      const name = r.displayName || r.name || r.canonicalName || r.rawName || r.kandidat_navn || "";
      const alias = Array.isArray(r.aliases) ? r.aliases.join(" ") : (r.rawName || "");
      const party = r.party || r.parti || r.partyName || r.party_label || "";
      const extra = r.searchText || "";
      return [name, alias, party, extra].join(" ");
    }

    function searchCandidates(query){
      const q = foldStr(query);
      if(!q) return [];

      const scored = candidateFlatList.map(item=>{
        const r = item.record || {};
        const name = r.displayName || r.name || r.canonicalName || r.rawName || r.kandidat_navn || "";
        const foldedName = foldStr(name);
        const fullSearch = foldStr(buildSearchText(r));

        let score = -Infinity;
        if(foldedName.startsWith(q)) score = 300 - (foldedName.length - q.length);
        else{
          const parts = foldedName.split(/\s+/).filter(Boolean);
          if(parts.some(p=>p.startsWith(q))) score = 220 - fullSearch.indexOf(q);
          else if(fullSearch.includes(q)) score = 140 - fullSearch.indexOf(q);
        }

        // let "partinavn" give lidt ekstra hvis man skriver fx "enhedslisten"
        const partyFold = foldStr(r.party || r.parti || "");
        if(partyFold && (partyFold.startsWith(q) || partyFold.includes(q))){
          score += 20;
        }

        return { item, score, sortName: name };
      })
      .filter(x=>x.score > -Infinity)
      .sort((a,b)=> b.score - a.score || a.sortName.localeCompare(b.sortName,'da'))
      .slice(0,20);

      return scored.map(x=>x.item);
    }

    function renderSearchResults(list, query){
      candidateResults.innerHTML = "";
      activeSuggestion = -1;

      if(candidateIndexData === false){
        candidateResults.innerHTML =
          `<div class="vb-search-status">Kunne ikke hente kandidatindekset. Tjek at <code>/data/candidate-index.json</code> findes.</div>`;
        candidateResults.classList.remove('hidden');
        return;
      }

      if(!query){
        candidateResults.classList.add('hidden');
        return;
      }

      if(!candidateIndexData){
        candidateResults.innerHTML =
          `<div class="vb-search-status">Indlæser kandidatindeks…</div>`;
        candidateResults.classList.remove('hidden');
        return;
      }

      if(!list.length){
        candidateResults.innerHTML =
          `<div class="vb-search-status">Ingen kandidater matchede "<strong>${query}</strong>".</div>`;
        candidateResults.classList.remove('hidden');
        return;
      }

      const html = list.map((item, idx)=>{
        const r = item.record || {};
        const name = r.displayName || r.name || r.canonicalName || r.rawName || r.kandidat_navn || "Ukendt navn";
        const party = r.party || r.parti || r.partyName || "";
        const votes = (typeof r.votes === "number" ? r.votes : (typeof r.stemmer === "number" ? r.stemmer : null));

        const electionText = `${item.electionLabel || 'Valg'} ${item.electionYear || ''}`.trim();
        const votesText = votes != null ? `${fmtNumber(votes)} ${stemmerLabel(votes)}` : "";
        const metaParts = [electionText, party, votesText].filter(Boolean);
        const meta = metaParts.join(" · ");

        return `
          <div class="vb-search-item"
               role="option"
               data-index="${idx}"
               aria-selected="false">
            <div class="vb-search-item-title">${name}</div>
            <div class="vb-search-item-meta">${meta}</div>
          </div>
        `;
      }).join("");

      candidateResults.innerHTML = html;
      candidateResults.classList.remove('hidden');

      candidateResults.querySelectorAll('.vb-search-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const idx = Number(el.getAttribute('data-index') || 0);
          const chosen = list[idx];
          if(chosen) goToCandidate(chosen);
        });
      });
    }

    function goToCandidate(item){
      const r = item.record || {};
      const base = item.electionDetailUrl || '#';

      // prøv at finde et kandidat-id, vi kan sende videre som ?cand=
      const candId = r.candidateId || r.kandidat_id || r.id || null;
      let url = base;
      if(candId){
        const hasQuery = base.includes('?');
        const sep = hasQuery ? '&' : '?';
        url = `${base}${sep}cand=${encodeURIComponent(candId)}`;
      }

      window.location.href = url;
    }

    let searchDebounce = null;

    function handleSearchInput(){
      const q = candidateInput.value || "";
      lastQuery = q;
      if(searchDebounce) clearTimeout(searchDebounce);

      searchDebounce = setTimeout(async ()=>{
        await loadCandidateIndexOnce();
        const matches = candidateIndexData ? searchCandidates(q) : [];
        renderSearchResults(matches, q);
      }, 120);
    }

    candidateInput?.addEventListener('input', handleSearchInput);
    candidateInput?.addEventListener('focus', handleSearchInput);

    candidateInput?.addEventListener('keydown', (e)=>{
      const items = candidateResults.querySelectorAll('.vb-search-item');
      const max = items.length;

      if(e.key === 'ArrowDown' && max){
        e.preventDefault();
        activeSuggestion = (activeSuggestion + 1) % max;
        updateActiveSuggestion(items);
      }else if(e.key === 'ArrowUp' && max){
        e.preventDefault();
        activeSuggestion = (activeSuggestion <= 0 ? max-1 : activeSuggestion-1);
        updateActiveSuggestion(items);
      }else if(e.key === 'Enter'){
        if(!candidateResults.classList.contains('hidden') && activeSuggestion >= 0 && activeSuggestion < max){
          e.preventDefault();
          const idx = activeSuggestion;
          const q = lastQuery;
          const matches = candidateIndexData ? searchCandidates(q) : [];
          const chosen = matches[idx];
          if(chosen) goToCandidate(chosen);
        }
      }else if(e.key === 'Escape'){
        candidateResults.classList.add('hidden');
        activeSuggestion = -1;
      }
    });

    function updateActiveSuggestion(items){
      items.forEach((el,i)=>{
        const active = i === activeSuggestion;
        el.setAttribute('aria-selected', active ? 'true' : 'false');
        if(active){
          const rect = el.getBoundingClientRect();
          const parentRect = candidateResults.getBoundingClientRect();
          if(rect.top < parentRect.top){
            el.scrollIntoView({block:'nearest'});
          }else if(rect.bottom > parentRect.bottom){
            el.scrollIntoView({block:'nearest'});
          }
        }
      });
    }

    // Klik udenfor lukker listen
    document.addEventListener('click',(e)=>{
      if(!candidateResults.contains(e.target) && e.target !== candidateInput){
        candidateResults.classList.add('hidden');
        activeSuggestion = -1;
      }
    });
  </script>
</body>
</html>
