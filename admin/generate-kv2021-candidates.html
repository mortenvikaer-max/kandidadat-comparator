<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – Generér KV2021 kandidater</title>

  <!-- Tailwind CSS (CDN, kun til styling) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse til CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .vb-card{
      background:#fff;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 1px 2px rgba(15,23,42,0.05);
    }
    .vb-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.5rem;
      padding:0.6rem 1rem;
      border-radius:999px;
      border:1px solid #0f172a;
      background:#0f172a;
      color:#f9fafb;
      font-weight:500;
      cursor:pointer;
    }
    .vb-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .vb-log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:0.8rem;
      line-height:1.4;
      max-height:200px;
      overflow:auto;
    }
    code{
      background:#f3f4f6;
      border-radius:4px;
      padding:0.1rem 0.3rem;
      font-size:0.85em;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="/Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
          Admin
        </span>
        <span class="text-lg font-semibold text-slate-900">
          Generér kandidat-kilde – Kommunalvalg 2021
        </span>
      </div>
    </div>
    <span class="text-xs text-slate-500">
      Intern side – ingen login, gem blot URL'en.
    </span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <!-- Intro -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl md:text-2xl font-semibold">
      Byg <code>kv2021.json</code> automatisk
    </h1>
    <p class="text-sm md:text-base text-slate-700">
      Denne side læser alle dine CSV-filer for kommunalvalg 2021
      (under <code>/data/kv/2021/</code>) og genererer en samlet liste
      over kandidater, som kan bruges til kandidat-søgningen på forsiden.
    </p>
    <ol class="list-decimal list-inside text-sm md:text-base text-slate-800 space-y-1">
      <li>Vi loader CSV for alle kommuner i Danmark.</li>
      <li>Vi summerer personlige stemmer pr. kandidat.</li>
      <li>Vi gætter kandidat-id ud fra <code>kandidat_id</code> eller <code>kandidat_navn</code> (samme logik som KV2021-siden).</li>
      <li>Vi finder kandidatens kommune og region.</li>
      <li>Vi spytter et JSON-array ud, som du kan gemme som <code>/data/candidate-sources/kv2021.json</code>.</li>
    </ol>
    <p class="text-xs text-slate-500">
      <strong>Vigtigt:</strong> Der skrives ikke automatisk filer på serveren.
      Du kopierer selv JSON-outputtet til den rigtige fil via FTP/CMS.
    </p>
  </section>

  <!-- Kontrol / log / output -->
  <section class="vb-card p-4 md:p-5 space-y-4">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Kør generatoren</h2>
        <p class="text-xs text-slate-600">
          Tryk på knappen – der kan gå lidt tid, mens alle kommuner læses.
        </p>
      </div>
      <button id="btnBuildKV2021" class="vb-btn text-sm">
        Byg kv2021.json
      </button>
    </div>

    <div>
      <h3 class="text-sm font-semibold text-slate-800 mb-1">Log</h3>
      <div id="log" class="vb-log border border-slate-200 rounded-lg bg-slate-50 p-2"></div>
    </div>

    <div>
      <div class="flex items-center justify-between mb-1">
        <h3 class="text-sm font-semibold text-slate-800">
          Output (gem som <code>/data/candidate-sources/kv2021.json</code>)
        </h3>
        <span id="summary" class="text-xs text-slate-500"></span>
      </div>
      <textarea id="outputJson"
                class="w-full h-72 border border-slate-200 rounded-lg text-xs font-mono p-2 bg-slate-50"
                placeholder="Tryk på 'Byg kv2021.json' for at generere JSON..."
                spellcheck="false"></textarea>
    </div>
  </section>
</main>

<footer class="border-t bg-slate-100 mt-8">
  <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>Valgbar · Admin-værktøj (kv2021-kandidater)</span>
    <span>Alt kører i browseren – ingen server-side ændringer</span>
  </div>
</footer>

<script>
  // ============================================
  // KONFIGURATION
  // ============================================

  // Hvor ligger CSV-filerne i forhold til /admin/ ?
  // Din struktur er: /admin/ og /data/ som søskende -> derfor ../data/...
  const BASE_PATH = "../data/kv/2021/";

  // Alle kommuner fra KV2021-siden
  const REGIONS = {
    "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Helsingør","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
    "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
    "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
    "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
    "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
  };

  // Samlet liste over kommuner
  const ALL_KOMMUNER = Object.values(REGIONS).flat();

  // ============================================
  // HELPERS
  // ============================================

  const logEl = document.getElementById("log");
  const outputEl = document.getElementById("outputJson");
  const btn = document.getElementById("btnBuildKV2021");
  const summaryEl = document.getElementById("summary");

  function logLine(msg){
    const time = new Date().toLocaleTimeString("da-DK");
    const div = document.createElement("div");
    div.textContent = `[${time}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  const canon = (s) => (s || "").toString().trim();

  // Samme normalisering som på KV2021-siden: ",By" -> ", By"
  const normalizeCandidateName = (name) => (name || "").replace(/,(\S)/g, ", $1");

  // Vi vil ikke have "Partiliste", "Listestemmer" som kandidater
  const isListestemmer = (name) => {
    const t = canon(name).toLowerCase();
    return t === "partiliste" || t === "listestemmer" || t === "liste";
  };

  // Find region for kommune (fallback, hvis CSV ikke har kolonnen)
  function findRegionForKommune(kommune){
    for(const [reg, kommuner] of Object.entries(REGIONS)){
      if(kommuner.includes(kommune)) return reg;
    }
    return "";
  }

  async function fetchCsvText(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }

  function parseCsvTextToRows(text){
    const res = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => canon(h.toLowerCase())
    });
    return res.data.map(r => {
      const region   = canon(r.region || "");
      const kommune  = canon(r.kommune || "");
      const navnRaw  = canon(r.kandidat_navn || "");
      const navnNorm = normalizeCandidateName(navnRaw);

      // kandidat_id som i KV2021-koden
      const kandidat_id = canon(r.kandidat_id || navnRaw);

      return {
        region,
        kommune,
        kandidat_id,
        kandidat_navn: navnNorm,
        parti: canon(r.parti || ""),
        parti_bogstav: canon(r.parti_bogstav || r.listebogstav || ""),
        stemmer: Number(r.stemmer || 0) || 0
      };
    });
  }

  async function loadRowsForKommune(kommune){
    const safe = encodeURIComponent(kommune);
    const candidates = [
      `${BASE_PATH}${safe}_allepartier.csv`,
      `${BASE_PATH}${safe}.csv`
    ];
    for(const url of candidates){
      try{
        const text = await fetchCsvText(url);
        const rows = parseCsvTextToRows(text);
        logLine(`✔ Indlæste ${rows.length} rækker for ${kommune} fra ${url}`);
        return rows;
      }catch(err){
        logLine(`… Kunne ikke læse ${url} (${err.message || err}) – prøver næste mulighed`);
      }
    }
    logLine(`⚠ Fandt ingen CSV for ${kommune}`);
    return [];
  }

  // ============================================
  // HOVEDLOGIK: BYG KV2021-KANDIDATER
  // ============================================

  async function buildKv2021Candidates(){
    btn.disabled = true;
    logEl.innerHTML = "";
    outputEl.value = "";
    summaryEl.textContent = "";

    logLine("Starter – læser CSV for alle kommuner i KV2021…");

    const allRows = [];
    let kommuneCount = 0;

    for(const kommune of ALL_KOMMUNER){
      const rows = await loadRowsForKommune(kommune);
      if(rows.length) kommuneCount++;
      allRows.push(...rows);
    }

    logLine(`Færdig med at læse CSV – i alt ${kommuneCount} kommuner med data, ${allRows.length} rækker.`);

    // Aggregér kandidater
    const candMap = new Map();
    for(const r of allRows){
      if(isListestemmer(r.kandidat_navn)) continue; // spring listestemmer over

      const id = r.kandidat_id;
      if(!id) continue;

      if(!candMap.has(id)){
        candMap.set(id, {
          candidateId: id,
          name: r.kandidat_navn,
          party: r.parti,
          partyShort: r.parti_bogstav,
          totalVotes: 0,
          region: r.region || findRegionForKommune(r.kommune),
          kommune: r.kommune,
          area: r.kommune    // area bruges i søgevisning – vi sætter den = kommune
        });
      }
      const c = candMap.get(id);
      c.totalVotes += r.stemmer;
      // Hvis region/kommune mangler første gang, kan vi evt. opdatere:
      if(!c.region && r.region)  c.region  = r.region;
      if(!c.kommune && r.kommune) c.kommune = r.kommune;
    }

    const candidates = Array.from(candMap.values())
      .sort((a,b) => (a.name || "").localeCompare(b.name || "", "da"));

    logLine(`Byggede kandidat-liste: ${candidates.length} kandidater.`);

    const jsonText = JSON.stringify(candidates, null, 2);
    outputEl.value = jsonText;
    summaryEl.textContent = `${candidates.length} kandidater – klar til at gemme som kv2021.json`;

    logLine("FÆRDIG. Kopiér tekstområdet ovenfor og gem som /data/candidate-sources/kv2021.json");
    btn.disabled = false;
  }

  document.getElementById("btnBuildKV2021").addEventListener("click", () => {
    buildKv2021Candidates().catch(err => {
      console.error(err);
      logLine("FEJL: " + (err.message || err));
      btn.disabled = false;
    });
  });
</script>
</body>
</html>
