<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – Kandidatkilde KV2017</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    .vb-card{
      background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 1px 2px rgba(15,23,42,0.05);
    }
    .vb-btn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:.5rem;padding:.6rem 1rem;border-radius:999px;
      border:1px solid #0f172a;background:#0f172a;color:#f9fafb;
      font-weight:500;cursor:pointer;
    }
    .vb-btn:disabled{opacity:.6;cursor:not-allowed;}
    .vb-log{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    textarea{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="../Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div>
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-600">Admin</div>
        <div class="text-lg font-semibold">Kandidatkilde – Kommunalvalg 2017</div>
      </div>
    </div>
    <div class="text-xs text-slate-500 max-w-xs">
      Læser CSV-data fra <code>/data/kv/2017/&lt;Region&gt;/&lt;Kommune&gt;.csv</code> og
      laver én samlet <code>kv2017.json</code> til kandidatindekset.
    </div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl font-semibold">Byg kandidatliste for Kommunalvalg 2017</h1>
    <p class="text-sm text-slate-700">
      Denne side læser alle kommunale CSV-filer for KV2017 og summerer personlige stemmer pr. kandidat
      (ingen listestemmer). Resultatet er en JSON-liste, som skal gemmes som
      <code>/data/candidate-sources/kv2017.json</code>.
    </p>
    <ol class="list-decimal list-inside text-sm text-slate-700 space-y-1">
      <li>Tryk på <strong>Byg kandidater</strong>.</li>
      <li>Vent til loggen siger <em>FÆRDIG</em>.</li>
      <li>Kopiér JSON-output til <code>/data/candidate-sources/kv2017.json</code>.</li>
      <li>Gå til <code>admin/byg-kandidatindeks.html</code> og byg hele kandidatindekset igen.</li>
    </ol>
  </section>

  <section class="vb-card p-4 md:p-5 space-y-4">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Kør generator</h2>
        <p class="text-xs text-slate-600">
          CSV-format forventes som <code>Afstemningsområde;Bogstavbetegnelse;Listenavn;Navn;Stemmetal</code>.
        </p>
      </div>
      <button id="btnBuild" class="vb-btn text-sm">Byg kandidater (KV2017)</button>
    </div>

    <div id="log" class="vb-log text-xs text-slate-700 space-y-0.5"></div>

    <div>
      <label for="output" class="block text-sm font-medium mb-1">
        Output JSON til <code>/data/candidate-sources/kv2017.json</code>
      </label>
      <textarea id="output" rows="18"
                class="w-full border border-slate-200 rounded-lg p-2 text-xs bg-slate-50"
                spellcheck="false"></textarea>
    </div>
  </section>
</main>

<script>
  // Samme regions-setup som på kommunesiderne
  const REGIONS = {
    "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Helsingør","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
    "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
    "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
    "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
    "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
  };

  const DATA_ROOT = "../data/kv/2017/";
  const logEl = document.getElementById('log');
  const outEl = document.getElementById('output');
  const btn = document.getElementById('btnBuild');

  function log(msg){
    const t = new Date().toLocaleTimeString("da-DK");
    const div = document.createElement("div");
    div.textContent = `[${t}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function fetchCsvFor(kommune, region){
    const safeRegion = encodeURIComponent(region);
    const safeK     = encodeURIComponent(kommune);
    const url = `${DATA_ROOT}${safeRegion}/${safeK}.csv`;
    log(`… læser ${url}`);
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  }

  function parseKv2017Csv(text, kommune, region){
    const results = Papa.parse(text, {
      header: true,
      delimiter: ";",
      skipEmptyLines: true,
      transformHeader: h => (h || "").toString().trim()
    });
    const rows = results.data || [];

    const map = new Map(); // key: kommune||navn
    for(const row of rows){
      const name = (row["Navn"] || "").toString().trim();
      if(!name) continue;
      if(name.toLowerCase() === "listestemmer") continue; // vi vil kun have kandidater

      const party = (row["Listenavn"] || "").toString().trim();          // fuldt partinavn
      const letter = (row["Bogstavbetegnelse"] || "").toString().trim(); // partibogstav
      const rawVotes = (row["Stemmetal"] || "").toString().trim();
      const votes = Number(rawVotes.replace(/\./g,"").replace(",", ".")) || 0;

      const key = `${kommune}||${name}`;
      if(!map.has(key)){
        map.set(key, {
          candidateId: name,   // KV2017 bruger navn som kandidat-id
          name,
          party,
          partyShort: letter,
          totalVotes: 0,
          area: kommune,
          region,
          kommune
        });
      }
      const rec = map.get(key);
      rec.totalVotes += votes;
    }
    return Array.from(map.values());
  }

  async function buildKv2017(){
    if(!btn) return;
    btn.disabled = true;
    logEl.innerHTML = "";
    outEl.value = "";
    log("Starter generering for Kommunalvalg 2017 …");
    log(`Data-mappe: ${DATA_ROOT}`);

    const allCandidates = [];
    let totalRows = 0;

    for(const [region, kommuner] of Object.entries(REGIONS)){
      for(const k of kommuner){
        try{
          const txt = await fetchCsvFor(k, region);
          const candList = parseKv2017Csv(txt, k, region);
          allCandidates.push(...candList);
          totalRows += candList.length;
          log(`OK: ${region} / ${k} – ${candList.length} kandidater`);
        }catch(err){
          log(`⚠ Kunne ikke læse data for ${region} / ${k}: ${err.message || err}`);
        }
      }
    }

    // sortér alfabetisk
    allCandidates.sort((a,b)=> a.name.localeCompare(b.name,"da"));

    outEl.value = JSON.stringify(allCandidates, null, 2);
    log(`FÆRDIG: ${allCandidates.length} kandidater i alt (KV2017).`);
    btn.disabled = false;
  }

  btn.addEventListener('click', ()=>{ buildKv2017(); });
</script>
</body>
</html>
