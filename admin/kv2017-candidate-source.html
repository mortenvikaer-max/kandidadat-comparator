<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – Kandidatkilde KV2017</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .vb-card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .vb-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #f9fafb;
      font-weight: 500;
      cursor: pointer;
    }
    .vb-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .vb-log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="../forside-test.html" class="flex items-center gap-2">
        <img src="../Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
          Admin
        </span>
        <span class="text-lg font-semibold text-slate-900">
          Kandidatkilde – Kommunalvalg 2017
        </span>
      </div>
    </div>
    <span class="text-xs text-slate-500">
      Bygger <code>kv2017.json</code> ud fra CSV-data.
    </span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <!-- Intro -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl md:text-2xl font-semibold">
      Byg kandidat-kildefil for Kommunalvalg 2017
    </h1>
    <p class="text-sm md:text-base text-slate-700">
      Denne side læser alle kommuners CSV-filer for KV2017 og laver én samlet liste
      over kandidater, som kan bruges til kandidatindekset
      (<code>/data/candidate-sources/kv2017.json</code>).
    </p>
    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
      <li>CSV-struktur (2017) antages at være: <code>Afstemningsområde;Bogstavbetegnelse;Listenavn;Navn;Stemmetal</code></li>
      <li>Vi ignorerer rækken <code>Navn = "Listestemmer"</code>.</li>
      <li><strong>TotalVotes</strong> er summen af <code>Stemmetal</code> for kandidaten på tværs af alle afstemningsområder i kommunen.</li>
    </ul>
    <p class="text-xs text-slate-500">
      Efter generering: Kopiér JSON-outputtet nedenfor til
      <code>/data/candidate-sources/kv2017.json</code> på serveren.
    </p>
  </section>

  <!-- Konfiguration/oversigt -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h2 class="text-lg font-semibold">Konfiguration for KV2017</h2>
    <p class="text-sm text-slate-700">
      Vi antager, at data ligger her:
      <code>../data/kv/2017/&lt;region&gt;/&lt;kommune&gt;.csv</code>,
      fx <code>../data/kv/2017/Region Hovedstaden/København.csv</code>.
    </p>

    <div class="text-xs text-slate-600">
      <p class="font-semibold mb-1">Regioner og kommuner:</p>
      <pre id="regionOverview"></pre>
    </div>
  </section>

  <!-- Byg knap + log + output -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Generér kv2017.json</h2>
        <p class="text-xs text-slate-600">
          Kører i din browser. Ingen filer skrives automatisk – du kopierer selv JSON-outputtet.
        </p>
      </div>
      <button id="btnBuild" class="vb-btn text-sm">
        Byg kandidat-kilde (KV2017)
      </button>
    </div>

    <div id="log" class="vb-log bg-slate-900 text-slate-100 rounded-lg p-2"></div>

    <div class="space-y-2">
      <label for="outputJson" class="text-sm font-medium text-slate-800">
        Output – JSON til <code>/data/candidate-sources/kv2017.json</code>
      </label>
      <textarea id="outputJson"
                class="w-full h-72 border border-slate-200 rounded-lg text-xs font-mono p-2 bg-slate-50"
                placeholder="Tryk på &quot;Byg kandidat-kilde (KV2017)&quot; for at generere JSON..."
                spellcheck="false"></textarea>
    </div>
  </section>
</main>

<footer class="border-t bg-slate-100 mt-8">
  <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>Valgbar · Admin-værktøj (kandidatkilde KV2017)</span>
    <span>Side genereres statisk – ingen server-side ændringer</span>
  </div>
</footer>

<script>
  // ==============================
  // KONFIG: Regioner & kommuner
  // ==============================

  const KV2017_DATA_ROOT = "../data/kv/2017/"; // relativt til /admin/

  const REGIONS_2017 = {
    "Region Hovedstaden": [
      "Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg",
      "Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs",
      "Helsingør","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København",
      "Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"
    ],
    "Region Sjælland": [
      "Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved",
      "Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"
    ],
    "Region Syddanmark": [
      "Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde",
      "Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde",
      "Vejen","Vejle","Ærø","Aabenraa","Sønderborg"
    ],
    "Region Midtjylland": [
      "Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs",
      "Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer",
      "Syddjurs","Viborg","Aarhus"
    ],
    "Region Nordjylland": [
      "Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild",
      "Thisted","Vesthimmerlands","Aalborg"
    ]
  };

  // simple helpers
  const el = id => document.getElementById(id);
  const canon = s => (s || "").toString().trim();
  const escapeHtml = (s) => (s || "").replace(/[&<>"]/g, c => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;"
  }[c] || c));

  function log(msg) {
    const logEl = el("log");
    if (!logEl) return;
    const time = new Date().toLocaleTimeString("da-DK");
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Vis et lille overblik over regioner
  (function renderRegionOverview() {
    const out = [];
    for (const [region, kommuner] of Object.entries(REGIONS_2017)) {
      out.push(`${region}: ${kommuner.length} kommuner`);
    }
    el("regionOverview").textContent = out.join("\n");
  })();

  async function fetchCsvText(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) {
      throw new Error("HTTP " + res.status);
    }
    return await res.text();
  }

  function parseCsv(text) {
    // Semikolon-separeret, med danske kolonnenavne
    const res = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      delimiter: ";",
      transformHeader: (h) => canon(h.toLowerCase())
    });
    return res.data;
  }

  async function buildKv2017CandidateSource() {
    el("log").textContent = "";
    el("outputJson").value = "";

    log("Starter generering for Kommunalvalg 2017 (kv2017)...");
    log("Data-mappe: " + KV2017_DATA_ROOT);

    const candidateMap = new Map(); // key: kommune|name|letter

    let kommunerTalt = 0;
    let rækkertalt = 0;

    for (const [regionName, kommuner] of Object.entries(REGIONS_2017)) {
      for (const kommune of kommuner) {
        const csvPath = KV2017_DATA_ROOT + encodeURIComponent(regionName) + "/" + encodeURIComponent(kommune) + ".csv";
        log(`Læs ${csvPath} ...`);

        let text;
        try {
          text = await fetchCsvText(csvPath);
        } catch (err) {
          log(`⚠ Kunne ikke læse ${csvPath} (${err.message || err}). Springer kommunen over.`);
          continue;
        }

        const rows = parseCsv(text);
        log(`… Indlæste ${rows.length} rækker fra ${kommune} (${regionName}).`);
        kommunerTalt++;
        rækkertalt += rows.length;

        for (const r of rows) {
          const name = canon(r["navn"]);
          const partijbrev = canon(r["bogstavbetegnelse"]);
          const listenavn = canon(r["listenavn"]);
          const stemmer = Number((r["stemmetal"] || "").toString().replace(",", ".")) || 0;

          // Skip listestemmer-række
          if (!name || name.toLowerCase() === "listestemmer") continue;

          // Byg nøgle per kommune + kandidat + bogstav, så samme person i to kommuner behandles separat
          const key = `${kommune}|${name}|${partijbrev}`;

          if (!candidateMap.has(key)) {
            candidateMap.set(key, {
              candidateId: name,      // vi bruger navn som id for 2017
              name: name,
              party: listenavn,
              partyShort: partijbrev,
              totalVotes: 0,
              area: kommune,
              region: regionName,
              kommune: kommune
            });
          }
          candidateMap.get(key).totalVotes += stemmer;
        }
      }
    }

    const candidates = Array.from(candidateMap.values())
      .sort((a, b) => a.name.localeCompare(b.name, "da"));

    log("");
    log(`FÆRDIG: Læste ${kommunerTalt} kommuner og ${rækkertalt} rå rækker.`);
    log(`Fandt i alt ${candidates.length} unikke kandidater i KV2017.`);
    log(`Kopiér JSON nedenfor til /data/candidate-sources/kv2017.json`);

    el("outputJson").value = JSON.stringify(candidates, null, 2);
  }

  el("btnBuild")?.addEventListener("click", () => {
    buildKv2017CandidateSource();
  });
</script>
</body>
</html>
