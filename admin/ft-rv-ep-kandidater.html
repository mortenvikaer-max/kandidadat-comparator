<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – FT/RV/EP kandidater</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse til CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .vb-card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .vb-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #f9fafb;
      font-weight: 500;
      cursor: pointer;
    }
    .vb-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    code {
      background: #f3f4f6;
      border-radius: 4px;
      padding: 0.1rem 0.3rem;
      font-size: 0.85em;
    }
    .vb-log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      line-height: 1.4;
      max-height: 260px;
      overflow-y: auto;
      background: #f9fafb;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="/Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
          Admin
        </span>
        <span class="text-lg font-semibold text-slate-900">
          FT / RV / EP – generér kandidat-kildefil (fra eksisterende CSV)
        </span>
      </div>
    </div>
    <span class="text-xs text-slate-500">
      Denne side er kun til internt brug (ingen login – gem URL'en).
    </span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <!-- Intro -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl md:text-2xl font-semibold">
      Generér kandidat-kildefil til FT, RV og EP
    </h1>
    <p class="text-sm md:text-base text-slate-700">
      Denne side læser de CSV-filer for folketingsvalg, regionsrådsvalg og Europa-Parlamentsvalg,
      som allerede ligger på serveren, og laver JSON-filer til
      <code>/data/candidate-sources/&lt;key&gt;.json</code>.
    </p>
    <ol class="list-decimal list-inside text-sm md:text-base text-slate-800 space-y-1">
      <li>Vælg valg i dropdown.</li>
      <li>Tjek at CSV-stien ser rigtig ud.</li>
      <li>Tryk på <em>Generér kandidat-fil</em>.</li>
      <li>Kopiér JSON-outputtet til <code>/data/candidate-sources/&lt;key&gt;.json</code>, fx <code>ft2022.json</code>.</li>
    </ol>
    <p class="text-xs text-slate-500">
      <strong>Vigtigt:</strong> Denne side skriver ikke på serveren – du kopierer selv JSON’en op.
    </p>
  </section>

  <!-- Valg / konfiguration -->
  <section class="vb-card p-4 md:p-5 space-y-4">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-lg font-semibold">Vælg valg</h2>
      <div class="flex items-center gap-2">
        <label for="electionSelect" class="text-xs text-slate-600">
          Valg:
        </label>
        <select id="electionSelect"
                class="rounded-md border border-slate-300 text-sm px-2 py-1 bg-white">
          <!-- udfyldes via JS -->
        </select>
      </div>
    </div>

    <p class="text-sm text-slate-700">
      Konfiguration for det valgte valg (du kan rette CSV-stien direkte i koden, hvis dine filer hedder noget andet):
    </p>

    <table class="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
      <tbody id="configTableBody" class="bg-white divide-y divide-slate-100">
      <!-- udfyldes via JS -->
      </tbody>
    </table>

    <p class="text-xs text-slate-500">
      CSV-stien skal pege på den fil, du allerede har uploadet (fx fra KMDValg/DS).
      Hvis du flytter CSV’en eller giver den nyt navn, så ret <code>csvUrl</code> i konfigurationen i denne fil.
    </p>
  </section>

  <!-- Generér kandidat-fil -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Generér kandidat-kildefil</h2>
        <p class="text-xs text-slate-600">
          Resultatet er en JSON-fil med <code>candidates</code>-liste og valg-metadata,
          som svarer til det dine <code>/data/candidate-sources/*.json</code>-filer skal have.
        </p>
      </div>
      <button id="btnGenerate" class="vb-btn text-sm">
        Generér kandidat-fil
      </button>
    </div>

    <div>
      <h3 class="text-sm font-semibold mb-1">Log</h3>
      <div id="log" class="vb-log" aria-live="polite"></div>
    </div>

    <div class="space-y-2">
      <label for="outputJson" class="text-sm font-medium text-slate-800">
        Output (JSON – gem som <code>/data/candidate-sources/&lt;key&gt;.json</code>)
      </label>
      <textarea id="outputJson"
                class="w-full h-72 border border-slate-200 rounded-lg text-xs font-mono p-2 bg-slate-50"
                placeholder='Tryk på "Generér kandidat-fil" for at se JSON…'
                spellcheck="false"></textarea>
      <p id="outputHint" class="text-xs text-slate-500"></p>
    </div>
  </section>
</main>

<footer class="mt-8 border-t bg-slate-100">
  <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>Valgbar · Admin-værktøj (FT/RV/EP kandidater)</span>
    <span>Side genereres statisk – ingen server-side ændringer</span>
  </div>
</footer>

<script>
  // ============================================================
  // KONFIG: hvilke valg findes, og hvor ligger CSV'erne?
  //
  // VIGTIGT:
  //  - Ret csvUrl, så det matcher DINE rigtige filer.
  //  - key skal matche candidateFile i manifestet (fx "ft2022").
  // ============================================================
  const ELECTION_CONFIG = [
    // FOLKETINGSVALG
    {
      key: "ft2022",
      type: "ft",
      year: 2022,
      label: "Folketingsvalg 2022",
      typeLabel: "Folketingsvalg",
      detailUrl: "/ft/2022/",
      // RET HER hvis din CSV ligger et andet sted / hedder noget andet:
      csvUrl: "../data/ft/2022/kandidater-ft2022.csv"
    },
    {
      key: "ft2019",
      type: "ft",
      year: 2019,
      label: "Folketingsvalg 2019",
      typeLabel: "Folketingsvalg",
      detailUrl: "/ft/2019/",
      csvUrl: "../data/ft/2019/kandidater-ft2019.csv"
    },
    {
      key: "ft2015",
      type: "ft",
      year: 2015,
      label: "Folketingsvalg 2015",
      typeLabel: "Folketingsvalg",
      detailUrl: "/ft/2015/",
      csvUrl: "../data/ft/2015/kandidater-ft2015.csv"
    },
    {
      key: "ft2011",
      type: "ft",
      year: 2011,
      label: "Folketingsvalg 2011",
      typeLabel: "Folketingsvalg",
      detailUrl: "/ft/2011/",
      csvUrl: "../data/ft/2011/kandidater-ft2011.csv"
    },
    {
      key: "ft2007",
      type: "ft",
      year: 2007,
      label: "Folketingsvalg 2007",
      typeLabel: "Folketingsvalg",
      detailUrl: "/ft/2007/",
      csvUrl: "../data/ft/2007/kandidater-ft2007.csv"
    },

    // REGIONSRÅDSVALG
    {
      key: "rv2021",
      type: "rv",
      year: 2021,
      label: "Regionsrådsvalg 2021",
      typeLabel: "Regionsrådsvalg",
      detailUrl: "/rv/2021/",
      csvUrl: "../data/rv/2021/kandidater-rv2021.csv"
    },
    {
      key: "rv2017",
      type: "rv",
      year: 2017,
      label: "Regionsrådsvalg 2017",
      typeLabel: "Regionsrådsvalg",
      detailUrl: "/rv/2017/",
      csvUrl: "../data/rv/2017/kandidater-rv2017.csv"
    },
    {
      key: "rv2013",
      type: "rv",
      year: 2013,
      label: "Regionsrådsvalg 2013",
      typeLabel: "Regionsrådsvalg",
      detailUrl: "/rv/2013/",
      csvUrl: "../data/rv/2013/kandidater-rv2013.csv"
    },

    // EUROPA-PARLAMENTSVALG
    {
      key: "ep2024",
      type: "ep",
      year: 2024,
      label: "Europa-Parlamentsvalg 2024",
      typeLabel: "Europa-Parlamentsvalg",
      detailUrl: "/ep/2024/",
      csvUrl: "../data/ep/2024/kandidater-ep2024.csv"
    },
    {
      key: "ep2019",
      type: "ep",
      year: 2019,
      label: "Europa-Parlamentsvalg 2019",
      typeLabel: "Europa-Parlamentsvalg",
      detailUrl: "/ep/2019/",
      csvUrl: "../data/ep/2019/kandidater-ep2019.csv"
    },
    {
      key: "ep2014",
      type: "ep",
      year: 2014,
      label: "Europa-Parlamentsvalg 2014",
      typeLabel: "Europa-Parlamentsvalg",
      detailUrl: "/ep/2014/",
      csvUrl: "../data/ep/2014/kandidater-ep2014.csv"
    },
    {
      key: "ep2009",
      type: "ep",
      year: 2009,
      label: "Europa-Parlamentsvalg 2009",
      typeLabel: "Europa-Parlamentsvalg",
      detailUrl: "/ep/2009/",
      csvUrl: "../data/ep/2009/kandidater-ep2009.csv"
    }
  ];

  const el  = id => document.getElementById(id);
  const fmt = n  => new Intl.NumberFormat("da-DK").format(n);

  const selectEl   = el("electionSelect");
  const cfgTable   = el("configTableBody");
  const logEl      = el("log");
  const outEl      = el("outputJson");
  const hintEl     = el("outputHint");
  const btnGenerate= el("btnGenerate");

  function logLine(msg){
    const time = new Date().toLocaleTimeString("da-DK");
    const div = document.createElement("div");
    div.textContent = `[${time}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ============================================================
  // UI-init: dropdown + config-tabel
  // ============================================================
  (function initUI(){
    ELECTION_CONFIG
      .slice()
      .sort((a,b)=> b.year - a.year || a.type.localeCompare(b.type))
      .forEach(cfg => {
        const opt = document.createElement("option");
        opt.value = cfg.key;
        opt.textContent = `${cfg.label} (${cfg.key})`;
        selectEl.appendChild(opt);
      });

    selectEl.value = "ft2022";

    function renderCfgTable(){
      const cfg = ELECTION_CONFIG.find(c=>c.key===selectEl.value) || ELECTION_CONFIG[0];
      cfgTable.innerHTML = `
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Valg</td>
          <td class="px-3 py-2">${cfg.label}</td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Type</td>
          <td class="px-3 py-2"><code>${cfg.type}</code> – ${cfg.typeLabel}</td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">År</td>
          <td class="px-3 py-2">${cfg.year}</td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Nøgle</td>
          <td class="px-3 py-2"><code>${cfg.key}</code></td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Detail-URL</td>
          <td class="px-3 py-2 font-mono text-xs">${cfg.detailUrl}</td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">CSV-sti</td>
          <td class="px-3 py-2 font-mono text-xs">${cfg.csvUrl}</td>
        </tr>
      `;
      hintEl.textContent = "";
      outEl.value = "";
      logEl.innerHTML = "";
    }

    renderCfgTable();

    selectEl.addEventListener("change", renderCfgTable);
  })();

  // ============================================================
  // CSV helpers
  // ============================================================
  async function fetchCsvText(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  }

  function parseCsvText(text){
    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => (h || "").toString().trim().toLowerCase()
    });
    return parsed.data;
  }

  function toNum(v){
    if(v == null || v === "") return 0;
    const s = String(v)
      .trim()
      .replace(/\./g, "")   // fjern tusindtals-punktum
      .replace(",", ".");   // dansk komma -> punktum
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function mapRowGeneric(raw, type){
    const r = raw;

    // Kandidatnavn
    let kandidatNavn =
      (r.kandidat_navn ||
       r.kandidatnavn ||
       r["navn"] ||
       r["kandidat"] ||
       "").toString().trim();

    if(!kandidatNavn){
      for(const [key,val] of Object.entries(r)){
        const lk = key.toLowerCase();
        if(/navn/.test(lk) && !/parti|kommune|region|kreds/.test(lk)){
          kandidatNavn = String(val || "").trim();
          if(kandidatNavn) break;
        }
      }
    }

    // Kandidat-ID
    let kandidatId =
      (r.kandidat_id ||
       r.kandidatid ||
       r["kandidat id"] ||
       r["kandidat-id"] ||
       r["kandidat nr"] ||
       r["kandidat_nr"] ||
       r["kandidat nr."] ||
       r["kandidatnummer"] ||
       r["kandidat"] ||
       kandidatNavn ||
       "").toString().trim();

    // Parti
    let parti =
      (r.parti ||
       r.partinavn ||
       "").toString().trim();

    if(!parti){
      for(const [key,val] of Object.entries(r)){
        const lk = key.toLowerCase();
        if(/parti/.test(lk) && !/bogstav|kode|nr/.test(lk)){
          parti = String(val || "").trim();
          if(parti) break;
        }
      }
    }

    // Partibogstav
    let partiBogstav =
      (r.parti_bogstav ||
       r.listebogstav ||
       r["partibogstav"] ||
       "").toString().trim();

    if(!partiBogstav){
      for(const [key,val] of Object.entries(r)){
        const lk = key.toLowerCase();
        if(/bogstav/.test(lk) || /listebogstav/.test(lk)){
          partiBogstav = String(val || "").trim();
          if(partiBogstav) break;
        }
      }
    }

    // Stemmer
    let stemmer = 0;
    const voteFields = [
      "stemmer",
      "personlige_stemmer",
      "personlige stemmer",
      "personlige stemmer i alt",
      "pers_stemmer",
      "pers. stemmer",
      "persstemmer",
      "antal stemmer",
      "stemmer i alt"
    ];
    for(const f of voteFields){
      if(r[f] != null && r[f] !== ""){
        stemmer += toNum(r[f]);
      }
    }
    if(stemmer === 0){
      for(const [key,val] of Object.entries(r)){
        const lk = key.toLowerCase();
        if(/stem/.test(lk) && val !== ""){
          stemmer += toNum(val);
        }
      }
    }

    // Område afhænger af valgtype
    let area   = "";
    let region = "";
    let kommune= "";

    if(type === "ft"){
      area =
        (r.storkreds ||
         r["storkredsnavn"] ||
         r["valgkreds"] ||
         r["valgkredsnavn"] ||
         "").toString().trim();
      region =
        (r.region ||
         r.regionsnavn ||
         "").toString().trim();
    } else if(type === "rv"){
      region =
        (r.region ||
         r.regionsnavn ||
         "").toString().trim();
      area = region;
    } else if(type === "ep"){
      // EP har ikke naturligt område – men brug evt. en "område"-kolonne hvis den findes
      area =
        (r.omraade ||
         r["område"] ||
         "").toString().trim();
      region = "";
    }

    return {
      candidateId: kandidatId,
      name: kandidatNavn,
      party: parti,
      partyShort: partiBogstav,
      totalVotes: stemmer,
      area,
      region,
      kommune
    };
  }

  function buildCandidateRecords(allMapped){
    // Vi slår sammen på (area + candidateId), så en kandidat i flere rækker
    // inden for samme område får summeret stemmerne.
    const map = new Map();

    for(const r of allMapped){
      if(!r.candidateId) continue;
      const areaKey = r.area || "";
      const key = `${areaKey}::${r.candidateId}`;

      if(!map.has(key)){
        const normName = (r.name || "")
          .toString()
          .normalize("NFD")
          .replace(/\p{Diacritic}/gu,"")
          .toLowerCase()
          .trim();

        map.set(key, {
          candidateId: r.candidateId,
          name: r.name,
          displayName: r.name,
          normalizedName: normName,
          nameVariants: [ r.name ].filter(Boolean),
          party: r.party,
          partyShort: r.partyShort || "",
          totalVotes: 0,
          area: r.area,
          region: r.region,
          kommune: r.kommune
        });
      }
      map.get(key).totalVotes += r.totalVotes || 0;
    }

    const list = Array.from(map.values());
    list.sort((a,b)=> (a.name || "").localeCompare(b.name || "", "da"));
    return list;
  }

  // ============================================================
  // Generér for valgt election
  // ============================================================
  async function generateForElection(cfg){
    logEl.innerHTML = "";
    outEl.value = "";
    hintEl.textContent = "";

    logLine(`Starter generering for ${cfg.label} (${cfg.key})…`);
    logLine(`CSV: ${cfg.csvUrl}`);

    const text = await fetchCsvText(cfg.csvUrl);
    logLine("✔ CSV indlæst, parser…");

    const rows = parseCsvText(text);
    logLine(`Parser gav ${fmt(rows.length)} rækker.`);

    const mapped = rows.map(r => mapRowGeneric(r, cfg.type));
    logLine("Mapper rækker til kandidat-struktur…");

    const candidates = buildCandidateRecords(mapped);
    logLine(`Byggede ${fmt(candidates.length)} kandidatrekorder.`);

    const candidatesWithElection = candidates.map(c => ({
      ...c,
      electionKey: cfg.key,
      electionLabel: cfg.typeLabel,
      electionType: cfg.type,
      electionTypeLabel: cfg.typeLabel,
      electionYear: cfg.year,
      electionDetailUrl: cfg.detailUrl
    }));

    const wrapper = {
      electionKey: cfg.key,
      electionType: cfg.type,
      electionLabel: cfg.typeLabel,
      electionTypeLabel: cfg.typeLabel,
      electionYear: cfg.year,
      detailUrl: cfg.detailUrl,
      candidates: candidatesWithElection
    };

    outEl.value = JSON.stringify(wrapper, null, 2);
    hintEl.textContent = `Gem som /data/candidate-sources/${cfg.key}.json (matcher candidateFile i manifestet).`;
    logLine(`KOPIÉR til /data/candidate-sources/${cfg.key}.json`);
  }

  // ============================================================
  // Event handlers
  // ============================================================
  btnGenerate.addEventListener("click", async ()=>{
    const cfg = ELECTION_CONFIG.find(c=>c.key===selectEl.value) || ELECTION_CONFIG[0];
    try{
      await generateForElection(cfg);
    }catch(err){
      console.error(err);
      logLine(`❌ FEJL: ${err.message || err}`);
    }
  });
</script>
</body>
</html>
