<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – Kandidatindeks</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .vb-card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .vb-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #f9fafb;
      font-weight: 500;
      cursor: pointer;
    }
    .vb-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    code {
      background: #f3f4f6;
      border-radius: 4px;
      padding: 0.1rem 0.3rem;
      font-size: 0.85em;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <!-- Juster evt. sti til logoet -->
        <img src="/Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
          Admin
        </span>
        <span class="text-lg font-semibold text-slate-900">
          Kandidatindeks – opbygning
        </span>
      </div>
    </div>
    <span class="text-xs text-slate-500">
        Denne side er kun til internt brug (ingen login – gem URL'en).
      </span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <!-- Intro -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl md:text-2xl font-semibold">
      Byg globalt kandidatindeks
    </h1>
    <p class="text-sm md:text-base text-slate-700">
      Denne admin-side er kun til dig. Idéen er:
    </p>
    <ol class="list-decimal list-inside text-sm md:text-base text-slate-800 space-y-1">
      <li>Læs kandidater ind fra alle valg (folketingsvalg, kommunalvalg, regionsrådsvalg, EP-valg).</li>
      <li>Lav ét samlet indeks over kandidater (inkl. varianter af navne).</li>
      <li>Gem indekset som en JSON-fil, som forsiden kan bruge til søgning.</li>
    </ol>
    <p class="text-xs text-slate-500">
      <strong>Vigtigt:</strong> Ingen data ændres på serveren. Denne side læser kun filer
      og viser et JSON-output, som du selv lægger op (fx via FTP eller CMS).
    </p>
  </section>

  <!-- Liste over valg / konfiguration -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-2">
      <h2 class="text-lg font-semibold">Valg i kandidatindekset</h2>
      <span class="text-xs text-slate-500">
          Konfiguration styres i JavaScript nederst i denne fil.
        </span>
    </div>
    <p class="text-sm text-slate-700">
      Nedenfor vises de valg, som vil blive inkluderet i kandidatindekset.
      Du kan senere tilføje eller fjerne valg ved at redigere konfigurationen i <code>VB_ELECTION_SOURCES</code>.
    </p>
    <div class="overflow-auto">
      <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
        <thead class="bg-slate-100 text-slate-700">
        <tr>
          <th class="text-left px-3 py-2 border-b border-slate-200">Valg</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">År</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Nøgle</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Data-mappe</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Detalje-side (URL)</th>
        </tr>
        </thead>
        <tbody id="electionTableBody" class="divide-y divide-slate-100 bg-white">
        <!-- udfyldes via JS -->
        </tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500">
      Tjek især, at <code>dataRoot</code> og <code>detailUrl</code> matcher din faktiske mappestruktur.
    </p>
  </section>

  <!-- Byg indeks -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-lg font-semibold">Byg kandidatindeks</h2>
      <button id="btnBuildIndex" class="vb-btn text-sm">
        Byg kandidatindeks
      </button>
    </div>
    <p class="text-sm text-slate-700">
      Når du klikker på knappen, sker der følgende:
    </p>
    <ul class="list-disc list-inside text-sm text-slate-700 space-y-1">
      <li>Der bygges et skelet med alle valg fra <code>VB_ELECTION_SOURCES</code>.</li>
      <li>Der indlæses kandidater fra JSON-filer i <code>/data/candidate-sources/</code> (fx <code>kv2021.json</code>).</li>
      <li>Resultatet vises som et samlet JSON-objekt i tekstfeltet herunder.</li>
    </ul>
    <p class="text-xs text-slate-500">
      Når du er tilfreds, kan du kopiere JSON'en og gemme den som fx <code>/data/candidate-index.json</code>,
      som forsiden senere kan bruge til søgning.
    </p>

    <div class="space-y-2">
      <label for="outputJson" class="text-sm font-medium text-slate-800">
        Output (globalt kandidatindeks som JSON)
      </label>
      <textarea id="outputJson"
                class="w-full h-64 border border-slate-200 rounded-lg text-xs font-mono p-2 bg-slate-50"
                placeholder='Klik "Byg kandidatindeks" for at generere JSON...'
                spellcheck="false"></textarea>
    </div>

    <div id="statusText" class="text-xs text-slate-500"></div>
  </section>
</main>

<footer class="border-t bg-slate-100 mt-8">
  <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>Valgbar · Admin-værktøj (kandidatindeks)</span>
    <span>Side genereres statisk – ingen server-side ændringer</span>
  </div>
</footer>

<script>
  // ============================================================
  // 1) KONFIGURATION: Hvilke valg skal med i kandidatindekset?
  // ============================================================

  const VB_ELECTION_SOURCES = [
    // -----------------------------
    // Folketingsvalg
    // -----------------------------
    {
      key: "ft2022",
      label: "Folketingsvalg",
      year: 2022,
      type: "ft",
      dataRoot: "../data/ft/2022/",
      detailUrl: "/folketingsvalg/2022/"
    },
    {
      key: "ft2019",
      label: "Folketingsvalg",
      year: 2019,
      type: "ft",
      dataRoot: "../data/ft/2019/",
      detailUrl: "/folketingsvalg/2019/"
    },
    {
      key: "ft2015",
      label: "Folketingsvalg",
      year: 2015,
      type: "ft",
      dataRoot: "../data/ft/2015/",
      detailUrl: "/folketingsvalg/2015/"
    },
    {
      key: "ft2011",
      label: "Folketingsvalg",
      year: 2011,
      type: "ft",
      dataRoot: "../data/ft/2011/",
      detailUrl: "/folketingsvalg/2011/"
    },
    {
      key: "ft2007",
      label: "Folketingsvalg",
      year: 2007,
      type: "ft",
      dataRoot: "../data/ft/2007/",
      detailUrl: "/folketingsvalg/2007/"
    },

    // -----------------------------
    // Kommunalvalg
    // -----------------------------
    {
      key: "kv2021",
      label: "Kommunalvalg",
      year: 2021,
      type: "kv",
      dataRoot: "../data/kv/2021/",
      detailUrl: "/kommunalvalg/2021/"
    },
    {
      key: "kv2017",
      label: "Kommunalvalg",
      year: 2017,
      type: "kv",
      dataRoot: "../data/kv/2017/",
      detailUrl: "/kommunalvalg/2017/"
    },
    {
      key: "kv2013",
      label: "Kommunalvalg",
      year: 2013,
      type: "kv",
      dataRoot: "../data/kv/2013/",
      detailUrl: "/kommunalvalg/2013/"
    },
    {
      key: "kv2009",
      label: "Kommunalvalg",
      year: 2009,
      type: "kv",
      dataRoot: "../data/kv/2009/",
      detailUrl: "/kommunalvalg/2009/"
    },
    {
      key: "kv2005",
      label: "Kommunalvalg",
      year: 2005,
      type: "kv",
      dataRoot: "../data/kv/2005/",
      detailUrl: "/kommunalvalg/2005/"
    },

    // -----------------------------
    // Regionsrådsvalg
    // -----------------------------
    {
      key: "rv2021",
      label: "Regionsrådsvalg",
      year: 2021,
      type: "rv",
      dataRoot: "../data/rv/2021/",
      detailUrl: "/regionsraadsvalg/2021/"
    },
    {
      key: "rv2017",
      label: "Regionsrådsvalg",
      year: 2017,
      type: "rv",
      dataRoot: "../data/rv/2017/",
      detailUrl: "/regionsraadsvalg/2017/"
    },

    // -----------------------------
    // Europa-Parlamentsvalg
    // -----------------------------
    {
      key: "ep2024",
      label: "Europa-Parlamentsvalg",
      year: 2024,
      type: "ep",
      dataRoot: "../data/ep/2024/",
      detailUrl: "/europaparlamentsvalg/2024/"
    },
    {
      key: "ep2019",
      label: "Europa-Parlamentsvalg",
      year: 2019,
      type: "ep",
      dataRoot: "../data/ep/2019/",
      detailUrl: "/europaparlamentsvalg/2019/"
    },
    {
      key: "ep2014",
      label: "Europa-Parlamentsvalg",
      year: 2014,
      type: "ep",
      dataRoot: "../data/ep/2014/",
      detailUrl: "/europaparlamentsvalg/2014/"
    },
    {
      key: "ep2009",
      label: "Europa-Parlamentsvalg",
      year: 2009,
      type: "ep",
      dataRoot: "../data/ep/2009/",
      detailUrl: "/europaparlamentsvalg/2009/"
    }
  ];

  const VB_TYPE_LABELS = {
    ft: "Folketingsvalg",
    kv: "Kommunalvalg",
    rv: "Regionsrådsvalg",
    ep: "Europa-Parlamentsvalg"
  };

  // ============================================================
  // 2) KONFIG: Hvilke kandidat-kilder findes der allerede?
  //    (LIGE NU kun kv2021 – de andre kan du tilføje senere)
  // ============================================================

  // Sti er relativ fra admin-siden. Hvis admin ligger i /admin/,
  // og din mappe er /data/candidate-sources/, så er ../data/... korrekt.
  const VB_CANDIDATE_SOURCE_FILES = {
    // eksempel: Kommunalvalg 2021
    kv2021: "../data/candidate-sources/kv2021.json"
    // senere kan du tilføje fx:
    // kv2017: "../data/candidate-sources/kv2017.json",
    // ft2022: "../data/candidate-sources/ft2022.json", osv.
  };

  // ============================================================
  // 3) Navne-helpers (til søgning og normalisering)
  // ============================================================

  function vbNormalizeName(name) {
    if (!name) return "";
    // fjern dobbeltmellemrum og trim
    return name.replace(/\s+/g, " ").trim();
  }

  function vbFold(str) {
    return (str || "")
      .normalize("NFD")
      .replace(/\p{Diacritic}/gu, "")
      .toLowerCase()
      .trim();
  }

  function vbMakeSearchName(displayName) {
    const clean = vbNormalizeName(displayName)
      .replace(/,.+$/, ""); // fjern evt. ", Nørrebro" mm.
    return vbFold(clean);
  }

  // ============================================================
  // 4) UI: Vis valg-konfigurationen i tabellen
  // ============================================================

  (function renderElectionTable() {
    const tbody = document.getElementById("electionTableBody");
    if (!tbody) return;

    const rows = VB_ELECTION_SOURCES
      .slice()
      .sort((a, b) => {
        const ta = VB_TYPE_LABELS[a.type] || a.type;
        const tb = VB_TYPE_LABELS[b.type] || b.type;
        if (ta < tb) return -1;
        if (ta > tb) return 1;
        return b.year - a.year;
      })
      .map(src => {
        const typeLabel = VB_TYPE_LABELS[src.type] || src.type;
        return `
          <tr>
            <td class="px-3 py-2 align-top">${typeLabel}</td>
            <td class="px-3 py-2 align-top">${src.year}</td>
            <td class="px-3 py-2 align-top"><code>${src.key}</code></td>
            <td class="px-3 py-2 align-top font-mono text-xs">${src.dataRoot}</td>
            <td class="px-3 py-2 align-top font-mono text-xs">${src.detailUrl}</td>
          </tr>
        `;
      });

    tbody.innerHTML = rows.join("");
  })();

  // ============================================================
  // 5) Byg skelet + indlæs kandidat-kilder
  // ============================================================

  function buildGlobalIndexSkeleton() {
    return {
      version: 1,
      builtAt: new Date().toISOString(),
      elections: VB_ELECTION_SOURCES.map(src => ({
        key: src.key,
        type: src.type,
        typeLabel: VB_TYPE_LABELS[src.type] || src.type,
        year: src.year,
        label: src.label,
        detailUrl: src.detailUrl,
        candidates: []   // udfyldes nedenfor, hvis der findes en kandidat-kilde
      }))
    };
  }

  async function loadCandidateSourceFile(electionKey) {
    const path = VB_CANDIDATE_SOURCE_FILES[electionKey];
    if (!path) return null; // ingen kandidat-kilde for dette valg (endnu)

    try {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) {
        console.warn("Kunne ikke hente kandidatkilde for", electionKey, path, res.status);
        return null;
      }
      const data = await res.json();
      if (!data || !Array.isArray(data.candidates)) {
        console.warn("Uventet format i kandidatkilde for", electionKey, data);
        return null;
      }

      // Normalisér kandidater en smule, så vi er sikre på felterne
      const normCandidates = data.candidates.map(c => {
        const displayName = vbNormalizeName(c.displayName || "");
        const searchName = c.searchName || vbMakeSearchName(displayName);
        const aliases = Array.isArray(c.aliases) ? c.aliases : [];

        return {
          id: c.id || null,
          displayName,
          searchName,
          aliases,
          party: c.party || "",
          partyLetter: c.partyLetter || "",
          areaType: c.areaType || "",
          areaName: c.areaName || "",
          votes: typeof c.votes === "number" ? c.votes : 0,
          detailUrl: c.detailUrl || ""
        };
      }).filter(c => c.id && c.displayName);

      return {
        meta: {
          electionKey: data.electionKey || electionKey,
          year: data.year || null,
          label: data.electionLabel || null
        },
        candidates: normCandidates
      };
    } catch (err) {
      console.error("Fejl ved hentning af kandidatkilde for", electionKey, err);
      return null;
    }
  }

  async function buildGlobalIndexWithSources() {
    const index = buildGlobalIndexSkeleton();

    for (const election of index.elections) {
      const loaded = await loadCandidateSourceFile(election.key);
      if (loaded && Array.isArray(loaded.candidates)) {
        election.candidates = loaded.candidates;
        // hvis vi vil, kan vi overskrive label/year med mere præcis info fra kilden:
        if (loaded.meta.label) election.label = loaded.meta.label;
        if (loaded.meta.year) election.year = loaded.meta.year;
      }
    }

    return index;
  }

  // ============================================================
  // 6) Knap: Byg kandidatindeks
  // ============================================================

  const btn = document.getElementById("btnBuildIndex");
  const outputEl = document.getElementById("outputJson");
  const statusEl = document.getElementById("statusText");

  async function handleBuildClick() {
    if (!btn || !outputEl) return;
    btn.disabled = true;
    statusEl.textContent = "Bygger kandidatindeks – læser kandidatkilder (fx kv2021.json)...";

    try {
      const index = await buildGlobalIndexWithSources();
      outputEl.value = JSON.stringify(index, null, 2);

      const totalElections = index.elections.length;
      const withCandidates = index.elections.filter(e => (e.candidates || []).length > 0);
      const totalCandidates = withCandidates.reduce((sum, e) => sum + e.candidates.length, 0);

      statusEl.textContent =
        `Færdig. Valg i alt: ${totalElections}. ` +
        `Valg med kandidater: ${withCandidates.length}. ` +
        `Kandidater i alt: ${totalCandidates}.`;

      alert("Kandidatindeks er bygget. Du kan nu kopiere JSON'en og gemme den som fx /data/candidate-index.json.");
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Der opstod en fejl under opbygning af kandidatindekset. Se konsollen for detaljer.";
      alert("Der opstod en fejl under opbygning af kandidatindekset.");
    } finally {
      btn.disabled = false;
    }
  }

  btn?.addEventListener("click", handleBuildClick);
</script>
</body>
</html>
