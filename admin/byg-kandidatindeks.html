<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – Kandidatindeks</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .vb-card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .vb-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #f9fafb;
      font-weight: 500;
      cursor: pointer;
    }
    .vb-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    code {
      background: #f3f4f6;
      border-radius: 4px;
      padding: 0.1rem 0.3rem;
      font-size: 0.85em;
    }
    .vb-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      background: #e5e7eb;
      color: #374151;
    }
    .vb-log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <!-- Juster evt. sti til logoet -->
        <img src="/Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
          Admin
        </span>
        <span class="text-lg font-semibold text-slate-900">
          Kandidatindeks – opbygning
        </span>
      </div>
    </div>
    <span class="text-xs text-slate-500">
      Denne side er kun til internt brug (ingen login – gem URL'en).
    </span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <!-- Intro -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl md:text-2xl font-semibold">
      Byg globalt kandidatindeks
    </h1>
    <p class="text-sm md:text-base text-slate-700">
      Denne admin-side er kun til dig. Idéen er:
    </p>
    <ol class="list-decimal list-inside text-sm md:text-base text-slate-800 space-y-1">
      <li>Læs kandidater ind fra alle valg (folketingsvalg, kommunalvalg, regionsrådsvalg, EP-valg).</li>
      <li>Lav ét samlet indeks over kandidater (inkl. varianter af navne).</li>
      <li>Gem indekset som en JSON-fil, som forsiden kan bruge til søgning.</li>
    </ol>
    <p class="text-xs text-slate-500">
      <strong>Vigtigt:</strong> Ingen data ændres på serveren. Denne side læser kun filer
      og viser et JSON-output, som du selv lægger op (fx via FTP eller CMS).
    </p>
  </section>

  <!-- Liste over valg / konfiguration -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-2">
      <h2 class="text-lg font-semibold">Valg i kandidatindekset</h2>
      <span class="text-xs text-slate-500">
        Konfiguration og kildefiler styres i JavaScript nederst i denne fil.
      </span>
    </div>
    <p class="text-sm text-slate-700">
      Nedenfor vises de valg, som vil blive inkluderet i kandidatindekset.
      For hvert valg kan du (på sigt) lave en lille kandidat-kildefil
      under <code>/data/candidate-sources/</code>, som admin-siden læser.
    </p>
    <div class="overflow-auto">
      <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
        <thead class="bg-slate-100 text-slate-700">
        <tr>
          <th class="text-left px-3 py-2 border-b border-slate-200">Valg</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">År</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Nøgle</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Data-mappe</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Detalje-side (URL)</th>
          <th class="text-left px-3 py-2 border-b border-slate-200">Kandidat-kilde</th>
        </tr>
        </thead>
        <tbody id="electionTableBody" class="divide-y divide-slate-100 bg-white">
        <!-- udfyldes via JS -->
        </tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500">
      Tjek især, at <code>detailUrl</code> og <code>candidateSource</code> matcher din faktiske mappestruktur.
    </p>
  </section>

  <!-- Byg indeks -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Byg kandidatindeks</h2>
        <p class="text-xs text-slate-600">
          Kører i din browser. Ingen filer skrives automatisk – du kopierer selv JSON-outputtet.
        </p>
      </div>
      <button id="btnBuildIndex" class="vb-btn text-sm">
        Byg kandidatindeks
      </button>
    </div>

    <div id="buildStatus" class="text-xs text-slate-600 vb-log space-y-1"></div>

    <div class="space-y-2">
      <label for="outputJson" class="text-sm font-medium text-slate-800">
        Output (JSON til <code>/data/candidate-index.json</code>)
      </label>
      <textarea id="outputJson"
                class="w-full h-64 border border-slate-200 rounded-lg text-xs font-mono p-2 bg-slate-50"
                placeholder='Tryk på "Byg kandidatindeks" for at generere JSON...'
                spellcheck="false"></textarea>
    </div>
  </section>
</main>

<footer class="border-t bg-slate-100 mt-8">
  <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>Valgbar · Admin-værktøj (kandidatindeks)</span>
    <span>Side genereres statisk – ingen server-side ændringer</span>
  </div>
</footer>

<script>
  // ============================================================
  // KONFIGURATION: Hvilke valg skal med i kandidatindekset?
  // ============================================================

  const VB_ELECTION_SOURCES = [
    // -----------------------------
    // Folketingsvalg
    // -----------------------------
    {
      key: "ft2022",
      label: "Folketingsvalg",
      year: 2022,
      type: "ft",
      dataRoot: "../data/ft/2022/",
      detailUrl: "/folketingsvalg/2022/",
      candidateSource: "../data/candidate-sources/ft2022.json"
    },
    {
      key: "ft2019",
      label: "Folketingsvalg",
      year: 2019,
      type: "ft",
      dataRoot: "../data/ft/2019/",
      detailUrl: "/folketingsvalg/2019/",
      candidateSource: "../data/candidate-sources/ft2019.json"
    },
    {
      key: "ft2015",
      label: "Folketingsvalg",
      year: 2015,
      type: "ft",
      dataRoot: "../data/ft/2015/",
      detailUrl: "/folketingsvalg/2015/",
      candidateSource: "../data/candidate-sources/ft2015.json"
    },
    {
      key: "ft2011",
      label: "Folketingsvalg",
      year: 2011,
      type: "ft",
      dataRoot: "../data/ft/2011/",
      detailUrl: "/folketingsvalg/2011/",
      candidateSource: "../data/candidate-sources/ft2011.json"
    },
    {
      key: "ft2007",
      label: "Folketingsvalg",
      year: 2007,
      type: "ft",
      dataRoot: "../data/ft/2007/",
      detailUrl: "/folketingsvalg/2007/",
      candidateSource: "../data/candidate-sources/ft2007.json"
    },

    // -----------------------------
    // Kommunalvalg
    // -----------------------------
    {
      key: "kv2021",
      label: "Kommunalvalg",
      year: 2021,
      type: "kv",
      dataRoot: "../data/kv/2021/",
      detailUrl: "/kommunalvalg/2021/",
      candidateSource: "../data/candidate-sources/kv2021.json"
    },
    {
      key: "kv2017",
      label: "Kommunalvalg",
      year: 2017,
      type: "kv",
      dataRoot: "../data/kv/2017/",
      detailUrl: "/kommunalvalg/2017/",
      candidateSource: "../data/candidate-sources/kv2017.json"
    },
    {
      key: "kv2013",
      label: "Kommunalvalg",
      year: 2013,
      type: "kv",
      dataRoot: "../data/kv/2013/",
      detailUrl: "/kommunalvalg/2013/",
      candidateSource: "../data/candidate-sources/kv2013.json"
    },
    {
      key: "kv2009",
      label: "Kommunalvalg",
      year: 2009,
      type: "kv",
      dataRoot: "../data/kv/2009/",
      detailUrl: "/kommunalvalg/2009/",
      candidateSource: "../data/candidate-sources/kv2009.json"
    },
    {
      key: "kv2005",
      label: "Kommunalvalg",
      year: 2005,
      type: "kv",
      dataRoot: "../data/kv/2005/",
      detailUrl: "/kommunalvalg/2005/",
      candidateSource: "../data/candidate-sources/kv2005.json"
    },

    // -----------------------------
    // Regionsrådsvalg
    // -----------------------------
    {
      key: "rv2021",
      label: "Regionsrådsvalg",
      year: 2021,
      type: "rv",
      dataRoot: "../data/rv/2021/",
      detailUrl: "/regionsraadsvalg/2021/",
      candidateSource: "../data/candidate-sources/rv2021.json"
    },
    {
      key: "rv2017",
      label: "Regionsrådsvalg",
      year: 2017,
      type: "rv",
      dataRoot: "../data/rv/2017/",
      detailUrl: "/regionsraadsvalg/2017/",
      candidateSource: "../data/candidate-sources/rv2017.json"
    },

    // -----------------------------
    // Europa-Parlamentsvalg
    // -----------------------------
    {
      key: "ep2024",
      label: "Europa-Parlamentsvalg",
      year: 2024,
      type: "ep",
      dataRoot: "../data/ep/2024/",
      detailUrl: "/europaparlamentsvalg/2024/",
      candidateSource: "../data/candidate-sources/ep2024.json"
    },
    {
      key: "ep2019",
      label: "Europa-Parlamentsvalg",
      year: 2019,
      type: "ep",
      dataRoot: "../data/ep/2019/",
      detailUrl: "/europaparlamentsvalg/2019/",
      candidateSource: "../data/candidate-sources/ep2019.json"
    },
    {
      key: "ep2014",
      label: "Europa-Parlamentsvalg",
      year: 2014,
      type: "ep",
      dataRoot: "../data/ep/2014/",
      detailUrl: "/europaparlamentsvalg/2014/",
      candidateSource: "../data/candidate-sources/ep2014.json"
    },
    {
      key: "ep2009",
      label: "Europa-Parlamentsvalg",
      year: 2009,
      type: "ep",
      dataRoot: "../data/ep/2009/",
      detailUrl: "/europaparlamentsvalg/2009/",
      candidateSource: "../data/candidate-sources/ep2009.json"
    }
  ];

  const VB_TYPE_LABELS = {
    ft: "Folketingsvalg",
    kv: "Kommunalvalg",
    rv: "Regionsrådsvalg",
    ep: "Europa-Parlamentsvalg"
  };

  // ============================================================
  // Navne-helpers til kandidatindeks (for at matche fx "Line Barfod" / "Line Barfod, Nørrebro")
  // ============================================================
  const VB_NameHelpers = (() => {
    const stripPlaceSuffix = (name) => {
      if (!name) return "";
      let s = name.trim();
      const m = s.match(/^(.+?),\s*([^,]+)$/);
      if (!m) return s;
      const last = m[2].trim();
      if (!last) return s;
      if (/^(Nørrebro|Østerbro|Vesterbro|Amager|Valby|Vanløse|Bispebjerg|Brønshøj.*|Indre By)$/i.test(last)) {
        return m[1].trim();
      }
      if (/^(Aarhus|Aalborg|Odense|Esbjerg|Randers|Kolding|Horsens|Vejle|Roskilde|Helsingør)$/i.test(last)) {
        return m[1].trim();
      }
      return s;
    };

    const normalizeWhitespace = (s) => (s || "").replace(/\s+/g, " ").trim();

    const normalizeSearchString = (s) => {
      return (s || "")
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .toLowerCase()
        .replace(/[^a-z0-9æøå ]/gi, " ")
        .replace(/\s+/g, " ")
        .trim();
    };

    const unique = (arr) => {
      const seen = new Set();
      const out = [];
      for (const v of arr) {
        const key = v.toLowerCase();
        if (!seen.has(key)) {
          seen.add(key);
          out.push(v);
        }
      }
      return out;
    };

    const buildNameRecord = (rawName) => {
      const cleaned = normalizeWhitespace(rawName || "");
      const base = stripPlaceSuffix(cleaned);
      const variants = unique([cleaned, base].filter(Boolean));
      const searchName = normalizeSearchString(base || cleaned);
      return {
        raw: rawName || "",
        displayName: base || cleaned || "",
        baseName: base || cleaned || "",
        variants,
        searchName
      };
    };

    return { buildNameRecord, normalizeSearchString };
  })();

  // ============================================================
  // Render tabel over valg-konfiguration
  // ============================================================
  (function renderElectionTable() {
    const tbody = document.getElementById("electionTableBody");
    if (!tbody) return;

    const rows = VB_ELECTION_SOURCES
      .slice()
      .sort((a, b) => {
        const ta = VB_TYPE_LABELS[a.type] || a.type;
        const tb = VB_TYPE_LABELS[b.type] || b.type;
        if (ta < tb) return -1;
        if (ta > tb) return 1;
        return b.year - a.year;
      })
      .map(src => {
        const typeLabel = VB_TYPE_LABELS[src.type] || src.type;
        return `
          <tr>
            <td class="px-3 py-2 align-top">${typeLabel}</td>
            <td class="px-3 py-2 align-top">${src.year}</td>
            <td class="px-3 py-2 align-top"><code>${src.key}</code></td>
            <td class="px-3 py-2 align-top font-mono text-xs">${src.dataRoot}</td>
            <td class="px-3 py-2 align-top font-mono text-xs">${src.detailUrl}</td>
            <td class="px-3 py-2 align-top font-mono text-xs">${src.candidateSource || "—"}</td>
          </tr>
        `;
      });

    tbody.innerHTML = rows.join("");
  })();

  // ============================================================
  // Bygge-logik: læs kandidat-kildefiler og lav samlet indeks
  // ============================================================

  const elStatus = document.getElementById("buildStatus");
  const elOutput = document.getElementById("outputJson");

  function logLine(msg) {
    if (!elStatus) return;
    const time = new Date().toLocaleTimeString("da-DK");
    const div = document.createElement("div");
    div.textContent = `[${time}] ${msg}`;
    elStatus.appendChild(div);
  }

  async function loadCandidateSourceForElection(src) {
    if (!src.candidateSource) {
      logLine(`(${src.key}) Ingen candidateSource angivet – springer over.`);
      return [];
    }
    try {
      logLine(`(${src.key}) Henter kandidat-kilde: ${src.candidateSource}`);
      const res = await fetch(src.candidateSource, { cache: "no-store" });
      if (!res.ok) {
        logLine(`(${src.key}) Kunne ikke hente kandidat-kilde (HTTP ${res.status}) – ingen kandidater for dette valg.`);
        return [];
      }
      const data = await res.json();
      if (!Array.isArray(data)) {
        logLine(`(${src.key}) Kandidat-kilde er ikke et array – forventede en liste af kandidater. Ingen kandidater tilføjet.`);
        return [];
      }
      logLine(`(${src.key}) Indlæste ${data.length} kandidater fra kandidat-kilde.`);
      return data;
    } catch (err) {
      console.error(err);
      logLine(`(${src.key}) Fejl ved læsning af kandidat-kilde: ${err.message || err}`);
      return [];
    }
  }

  function mapCandidateRecord(raw, src) {
    // rå format fra candidateSource:
    // Vi forventer felter som:
    // - candidateId (eller id / kandidat_id)
    // - name (eller displayName / kandidat_navn)
    // - party, partyShort
    // - totalVotes (eller votes)
    // - area (kommune, kreds, region ...)
    const nameRaw = raw.name || raw.displayName || raw.kandidat_navn || raw.candidateName || "";
    const nameRec = VB_NameHelpers.buildNameRecord(nameRaw);

    const candidateId = String(
      raw.candidateId || raw.id || raw.kandidat_id || raw.personId || ""
    ).trim();

    const party = raw.party || raw.parti || "";
    const partyShort = raw.partyShort || raw.partyLetter || raw.parti_bogstav || "";
    const totalVotes = Number(raw.totalVotes ?? raw.votes ?? raw.stemmer ?? 0) || 0;
    const area = raw.area || raw.kommune || raw.kreds || raw.region || "";

    return {
      candidateId,
      displayName: nameRec.displayName,
      normalizedName: nameRec.searchName,
      nameVariants: nameRec.variants,
      party,
      partyShort,
      totalVotes,
      area,
      electionKey: src.key,
      electionLabel: src.label,
      electionYear: src.year,
      electionType: src.type,
      electionTypeLabel: VB_TYPE_LABELS[src.type] || src.type,
      electionDetailUrl: src.detailUrl
    };
  }

  async function buildCandidateIndex() {
    if (elStatus) elStatus.innerHTML = "";
    logLine("Starter opbygning af kandidatindeks...");

    const electionsOut = [];
    let globalCandidateCount = 0;

    for (const src of VB_ELECTION_SOURCES) {
      const typeLabel = VB_TYPE_LABELS[src.type] || src.type;
      logLine(`--- ${typeLabel} ${src.year} (${src.key}) ---`);

      const rawCandidates = await loadCandidateSourceForElection(src);
      const mapped = rawCandidates
        .map(c => mapCandidateRecord(c, src))
        .filter(c => c.candidateId); // kræver id

      const electionObj = {
        key: src.key,
        type: src.type,
        typeLabel,
        year: src.year,
        label: src.label,
        detailUrl: src.detailUrl,
        candidates: mapped
      };

      electionsOut.push(electionObj);
      globalCandidateCount += mapped.length;

      logLine(`(${src.key}) Tilføjede ${mapped.length} kandidater til kandidatindeks.`);
    }

    const indexObj = {
      version: 1,
      builtAt: new Date().toISOString(),
      elections: electionsOut
    };

    if (elOutput) {
      elOutput.value = JSON.stringify(indexObj, null, 2);
    }

    logLine(`FÆRDIG: ${electionsOut.length} valg og ${globalCandidateCount} kandidatrekorder i kandidatindekset.`);
    logLine(`Kopiér JSON ovenfor til /data/candidate-index.json på din server.`);
  }

  document.getElementById("btnBuildIndex")?.addEventListener("click", () => {
    buildCandidateIndex();
  });
</script>
</body>
</html>
