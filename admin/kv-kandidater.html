<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Admin – Kommunalvalg kandidater</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse til CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .vb-card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .vb-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #f9fafb;
      font-weight: 500;
      cursor: pointer;
    }
    .vb-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    code {
      background: #f3f4f6;
      border-radius: 4px;
      padding: 0.1rem 0.3rem;
      font-size: 0.85em;
    }
    .vb-log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      line-height: 1.4;
      max-height: 260px;
      overflow-y: auto;
      background: #f9fafb;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<header class="border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="/Valgbar-transparent3.png" alt="Valgbar" class="h-10 w-auto" />
      </a>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
          Admin
        </span>
        <span class="text-lg font-semibold text-slate-900">
          Kommunalvalg – generér kandidat-kildefil
        </span>
      </div>
    </div>
    <span class="text-xs text-slate-500">
      Denne side er kun til internt brug (ingen login – gem URL'en).
    </span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
  <!-- Intro -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <h1 class="text-xl md:text-2xl font-semibold">
      Generér kandidat-kildefil til kommunalvalg
    </h1>
    <p class="text-sm md:text-base text-slate-700">
      Denne side læser dine CSV-filer for kommunalvalg og laver en samlet liste
      af kandidater pr. kommune, der kan bruges i kandidatindekset på forsiden.
    </p>
    <ol class="list-decimal list-inside text-sm md:text-base text-slate-800 space-y-1">
      <li>Vælg kommunalvalg (år).</li>
      <li>Tryk på <em>Generér kandidat-fil</em>.</li>
      <li>Kopiér JSON-outputtet til <code>/data/candidate-sources/kvYYYY.json</code>.</li>
    </ol>
    <p class="text-xs text-slate-500">
      <strong>Vigtigt:</strong> Denne side skriver ikke på serveren – du kopierer selv JSON’en op.
    </p>
  </section>

  <!-- Valg / konfiguration -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-lg font-semibold">Vælg kommunalvalg</h2>
      <div class="flex items-center gap-2">
        <label for="kvElectionSelect" class="text-xs text-slate-600">
          Kommunalvalg:
        </label>
        <select id="kvElectionSelect"
                class="rounded-md border border-slate-300 text-sm px-2 py-1 bg-white">
        </select>
      </div>
    </div>

    <p class="text-sm text-slate-700">
      Konfiguration for det valgte valg:
    </p>
    <table class="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
      <tbody id="kvConfigTableBody" class="bg-white divide-y divide-slate-100">
      <!-- udfyldes via JS -->
      </tbody>
    </table>
    <p class="text-xs text-slate-500">
      Vi prøver automatisk både uden region-mappe
      (<code>../data/kv/ÅR/Albertslund.csv</code>) og med region-mappe
      (<code>../data/kv/ÅR/Region Hovedstaden/Albertslund.csv</code>).
      Det burde passe til både 2021, 2017, 2013, 2009 og 2005.
    </p>
  </section>

  <!-- Generér kandidat-fil -->
  <section class="vb-card p-4 md:p-5 space-y-3">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-semibold">Generér kandidat-kildefil</h2>
        <p class="text-xs text-slate-600">
          Resultatet er en liste af kandidater, grupperet pr. kommune, med total stemmetal for kommunen.
        </p>
      </div>
      <button id="btnGenerate" class="vb-btn text-sm">
        Generér kandidat-fil
      </button>
    </div>

    <div id="log" class="vb-log" aria-live="polite"></div>

    <div class="space-y-2">
      <label for="outputJson" class="text-sm font-medium text-slate-800">
        Output (JSON – gem som <code>/data/candidate-sources/kvYYYY.json</code>)
      </label>
      <textarea id="outputJson"
                class="w-full h-72 border border-slate-200 rounded-lg text-xs font-mono p-2 bg-slate-50"
                placeholder='Tryk på "Generér kandidat-fil" for at se JSON…'
                spellcheck="false"></textarea>
    </div>
  </section>
</main>

<footer class="border-t bg-slate-100 mt-8">
  <div class="max-w-5xl mx-auto px-4 py-4 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-2">
    <span>Valgbar · Admin-værktøj (kommunalvalg kandidater)</span>
    <span>Side genereres statisk – ingen server-side ændringer</span>
  </div>
</footer>

<script>
  // ============================================================
  // REGIONS – samme struktur som på KV2021-siden
  // ============================================================
  const REGIONS = {
    "Region Hovedstaden": [
      "Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg",
      "Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov",
      "Halsnæs","Helsingør","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm",
      "Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"
    ],
    "Region Sjælland": [
      "Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved",
      "Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"
    ],
    "Region Syddanmark": [
      "Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev",
      "Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense",
      "Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"
    ],
    "Region Midtjylland": [
      "Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig",
      "Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg",
      "Skive","Struer","Syddjurs","Viborg","Aarhus"
    ],
    "Region Nordjylland": [
      "Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord",
      "Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"
    ]
  };

  const ALL_KOMMUNER = Array.from(
    new Set(Object.values(REGIONS).flat())
  ).sort((a,b)=>a.localeCompare(b,'da'));

  function findRegionForKommune(kommune){
    for(const [reg, kommuner] of Object.entries(REGIONS)){
      if(kommuner.includes(kommune)) return reg;
    }
    return "";
  }

  // ============================================================
  // KONFIG: Kommunalvalg-setup
  // ============================================================
  const KV_CONFIG = [
    {
      key: "kv2021",
      year: 2021,
      label: "Kommunalvalg 2021",
      dataRoot: "../data/kv/2021/"
    },
    {
      key: "kv2017",
      year: 2017,
      label: "Kommunalvalg 2017",
      dataRoot: "../data/kv/2017/"
    },
    {
      key: "kv2013",
      year: 2013,
      label: "Kommunalvalg 2013",
      dataRoot: "../data/kv/2013/"
    },
    {
      key: "kv2009",
      year: 2009,
      label: "Kommunalvalg 2009",
      dataRoot: "../data/kv/2009/"
    },
    {
      key: "kv2005",
      year: 2005,
      label: "Kommunalvalg 2005",
      dataRoot: "../data/kv/2005/"
    }
  ];

  const el  = id => document.getElementById(id);
  const fmt = n  => new Intl.NumberFormat("da-DK").format(n);

  const logEl      = el("log");
  const outEl      = el("outputJson");
  const selectEl   = el("kvElectionSelect");
  const cfgTableBody = el("kvConfigTableBody");

  function logLine(msg){
    const time = new Date().toLocaleTimeString("da-DK");
    const div = document.createElement("div");
    div.textContent = `[${time}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ============================================================
  // UI: udfyld dropdown og config-tabel
  // ============================================================
  (function initUI(){
    KV_CONFIG
      .slice()
      .sort((a,b)=>b.year-a.year)
      .forEach(cfg=>{
        const opt = document.createElement("option");
        opt.value = cfg.key;
        opt.textContent = cfg.label;
        selectEl.appendChild(opt);
      });
    selectEl.value = "kv2021";

    function renderCfgTable(){
      const cfg = KV_CONFIG.find(c=>c.key===selectEl.value) || KV_CONFIG[0];
      cfgTableBody.innerHTML = `
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Valg</td>
          <td class="px-3 py-2">${cfg.label}</td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">År</td>
          <td class="px-3 py-2">${cfg.year}</td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Nøgle</td>
          <td class="px-3 py-2"><code>${cfg.key}</code></td>
        </tr>
        <tr>
          <td class="px-3 py-2 font-medium text-slate-600">Data-mappe</td>
          <td class="px-3 py-2 font-mono text-xs">${cfg.dataRoot}</td>
        </tr>
      `;
    }

    renderCfgTable();
    selectEl.addEventListener("change", ()=>{
      logEl.innerHTML = "";
      outEl.value = "";
      renderCfgTable();
    });
  })();

  // ============================================================
  // CSV helpers
  // ============================================================
  async function fetchCsvText(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  }

  function parseCsvTextToRows(text){
    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      transformHeader: h => (h || "").toString().trim().toLowerCase()
    });
    return parsed.data.map(r => {
      const region  = (r.region  || "").toString().trim();
      const kommune = (r.kommune || "").toString().trim();
      const kandidatId = (r.kandidat_id || r.kandidatid || r.kandidat_navn || r.kandidatnavn || "").toString().trim();
      const kandidatNavn = (r.kandidat_navn || r.kandidatnavn || "").toString().trim();
      const parti = (r.parti || "").toString().trim();
      const partiBogstav = (r.parti_bogstav || r.listebogstav || "").toString().trim();
      const stemmer = Number(r.stemmer || r.personlige_stemmer || 0) || 0;

      return {
        region,
        kommune,
        kandidat_id: kandidatId,
        kandidat_navn: kandidatNavn,
        parti,
        parti_bogstav: partiBogstav,
        stemmer
      };
    });
  }

  async function loadRowsForKommune(kommune, cfg){
    const base = cfg.dataRoot;
    const safeKommune = encodeURIComponent(kommune);

    // Vi prøver både uden og med regions-undermapper for ALLE år
    const paths = [];

    // Uden regions-mappe
    paths.push(`${base}${safeKommune}_allepartier.csv`);
    paths.push(`${base}${safeKommune}.csv`);

    // Med alle mulige regioner som undermappe
    for(const region of Object.keys(REGIONS)){
      const safeRegion = encodeURIComponent(region);
      paths.push(`${base}${safeRegion}/${safeKommune}_allepartier.csv`);
      paths.push(`${base}${safeRegion}/${safeKommune}.csv`);
    }

    for(const url of paths){
      try{
        const text = await fetchCsvText(url);
        const rows = parseCsvTextToRows(text);
        logLine(`✔ Indlæste ${rows.length} rækker for ${kommune} fra ${url}`);
        return rows;
      }catch(err){
        logLine(`… Kunne ikke læse ${url} (${err.message || err}) – prøver næste variant`);
      }
    }

    logLine(`⚠ Fandt ingen CSV-fil for ${kommune}`);
    return [];
  }

  function buildCandidateRecords(allRows, cfg){
    const map = new Map();
    for(const r of allRows){
      if(!r.kandidat_id) continue;
      const komm = r.kommune || "";
      const key = `${komm}::${r.kandidat_id}`;
      if(!map.has(key)){
        const reg = r.region || findRegionForKommune(komm) || "";
        map.set(key, {
          candidateId: r.kandidat_id,
          name: r.kandidat_navn,
          party: r.parti,
          partyShort: r.parti_bogstav || "",
          totalVotes: 0,
          area: komm,
          region: reg,
          kommune: komm
        });
      }
      map.get(key).totalVotes += r.stemmer || 0;
    }

    const list = Array.from(map.values());
    list.sort((a,b)=> (a.name || "").localeCompare(b.name || "", "da"));
    return list;
  }

  async function generateForElection(cfg){
    logEl.innerHTML = "";
    outEl.value = "";

    logLine(`Starter generering for ${cfg.label} (${cfg.key})…`);
    logLine(`Data-mappe: ${cfg.dataRoot}`);
    logLine(`Indlæser data for ${ALL_KOMMUNER.length} kommuner…`);

    const allRows = [];
    for(const kommune of ALL_KOMMUNER){
      const rows = await loadRowsForKommune(kommune, cfg);
      allRows.push(...rows);
    }

    logLine(`Færdig med at læse CSV – totalt ${fmt(allRows.length)} rækker.`);

    const candidates = buildCandidateRecords(allRows, cfg);
    logLine(`Byggede ${fmt(candidates.length)} kandidatrekorder (kandidat × kommune).`);

    outEl.value = JSON.stringify(candidates, null, 2);
    logLine(`KOPIÉR til /data/candidate-sources/${cfg.key}.json`);
  }

  // ============================================================
  // Event handlers
  // ============================================================
  el("btnGenerate").addEventListener("click", async ()=>{
    const cfg = KV_CONFIG.find(c=>c.key===selectEl.value) || KV_CONFIG[0];
    try{
      await generateForElection(cfg);
    }catch(err){
      console.error(err);
      logLine(`❌ FEJL: ${err.message || err}`);
    }
  });
</script>
</body>
</html>
