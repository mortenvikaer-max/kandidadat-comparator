<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Kommunalvalg 2025</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{ --vb-navy:#234a5a; --vb-navy-2:#1b3d4d; }
    .vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
    .vb-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
    .vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }
    .vb-tabbox.small{ flex:0 0 auto; padding:.4rem .8rem; font-size:.9rem; }

    .vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff;
                   display:flex; align-items:center; justify-content:space-between; }
    .vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
    .vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center;
               border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }

    .vb-menu{ position:absolute; z-index:50; margin-top:.25rem; width:max-content; min-width:16rem;
              max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb;
              border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
    .vb-option span{ white-space:normal; word-break:break-word; }
    .vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }

    .table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{
      position:sticky; left:0; background:#fff;
    }
    .vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }

    .rank-pill{ width:28px; height:28px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center;
                font-weight:700; border:1px solid #e5e7eb; background:#f9fafb; }
    .top10-item{ display:flex; align-items:center; gap:.75rem; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:12px; cursor:pointer; }
    .top10-item:hover{ background:#f9fafb; }
    .top10-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media (min-width:768px){ .top10-grid{ grid-template-columns:1fr 1fr; } }

    .context-bar{ display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; }
    .crumb{ color:#374151; text-decoration:underline; cursor:pointer; }
    .crumb-strong{ background:#111827; color:#fff; border-radius:9999px; padding:.15rem .6rem; font-weight:600; }
    .sep{ color:#9ca3af; }

    .cell-na{ color:#9ca3af; }

    /* Loader */
    .loader-wrap{ display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#6b7280; }
    .progress{ position:relative; height:6px; background:#f3f4f6; border-radius:9999px; overflow:hidden; }
    .progress::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, rgba(0,0,0,0) 0%, #c7d2fe 50%, rgba(0,0,0,0) 100%);
      animation:loadbar 1.2s infinite;
    }
    @keyframes loadbar{
      0%{ transform:translateX(-100%); }
      50%{ transform:translateX(0%); }
      100%{ transform:translateX(100%); }
    }

    .hier-toggle{ width:1.5rem; display:inline-flex; align-items:center; justify-content:center; font-size:.75rem; }
    .hier-indent-1{ padding-left:1.5rem; }
    .hier-indent-2{ padding-left:3rem; }

    /* Mini-barer til partisammenligning (andel af gyldige stemmer) */
    .mini-bar-wrap{
      width:100%;
      max-width:90px;
      height:4px;
      border-radius:9999px;
      background:transparent;
      overflow:hidden;
      margin-top:2px;
      margin-left:auto;
    }
    .mini-bar-fill{
      height:100%;
      border-radius:9999px;
      opacity:.8;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
<!-- HEADER -->
<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="../../" class="flex items-center gap-3">
      <img src="../../Valgbar-transparent3.png" alt="Valgbar" class="h-32 w-auto" />
    </a>
  </div>

  <!-- Brødkrumme + årsvælger -->
  <nav aria-label="Brødkrumme" class="mx-auto max-w-6xl px-4 pb-2">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <ol class="flex items-center gap-2 text-lg font-semibold">
        <li><a href="../../" class="underline text-white">Forside</a></li>
        <li class="opacity-70 text-white">/</li>
        <li><span aria-current="page" class="text-white">Kommunalvalg 2025</span></li>
      </ol>

      <div class="flex items-center gap-3 text-lg font-semibold">
        <label for="kvYearSelect" class="text-white whitespace-nowrap">
          Skift år:
        </label>
        <select id="kvYearSelect"
                class="rounded-lg bg-white text-gray-900 text-sm md:text-base px-2 py-1">
          <option value="../2025/" selected>Kommunalvalg 2025</option>
          <option value="../2021/">Kommunalvalg 2021</option>
          <option value="../2017/">Kommunalvalg 2017</option>
          <option value="../2013/">Kommunalvalg 2013</option>
          <option value="../2009/">Kommunalvalg 2009</option>
          <option value="../2005/">Kommunalvalg 2005</option>
        </select>
      </div>
    </div>
  </nav>

  <div class="mx-auto max-w-6xl px-4 pb-4">
    <div id="error" class="mt-2 text-sm text-red-200"></div>
  </div>
</header>

<main class="mx-auto max-w-6xl p-4 space-y-6">

  <!-- LIVE STATUS -->
  <section id="liveStatus" class="vb-card p-3 flex items-center gap-2 bg-emerald-50 border-emerald-200 text-sm">
    <span class="inline-flex items-center justify-center rounded-full bg-emerald-600 text-white text-xs font-semibold px-2 py-0.5">
      LIVE
    </span>
    <span id="liveStatusText" class="text-gray-800">
      Scanner efter kommuner med opgjorte data…
    </span>
  </section>

  <!-- KONTEKST/BRODKRUMMER -->
  <div id="contextBar" class="context-bar"></div>

  <!-- LANDING (søg + dropdowns) -->
  <section id="landing" class="vb-card p-4 space-y-4">
    <!-- Række 1: søgefelter -->
    <div class="grid grid-cols-1 md:grid-cols-3 md:items-end gap-3">

      <!-- Søg kandidat -->
      <div class="relative">
        <label class="text-sm text-gray-600">Søg kandidat</label>
        <input id="candidateSearch" type="text"
               class="w-full mt-1 rounded-xl border p-2"
               placeholder="Indtast kandidatnavn…"
               autocomplete="off" />
        <div id="candidateMenu" class="vb-menu hidden" role="listbox" tabindex="-1"
             aria-labelledby="candidateSearch" style="max-width:36rem"></div>
      </div>

      <!-- Vælg parti (oversigt/sammenligning) -->
      <div>
        <label class="text-sm text-gray-600">Vælg parti (oversigt/sammenligning)</label>
        <select id="partyScopeSelect"
                class="w-full mt-1 rounded-xl border p-2 text-gray-900"
                disabled>
          <option value="">Vælg parti…</option>
        </select>
      </div>

      <!-- Søg kommune -->
      <div>
        <label class="text-sm text-gray-600">Søg kommune</label>
        <input id="kommuneSearch" type="text"
               class="w-full mt-1 rounded-xl border p-2"
               placeholder="Start med at skrive fx Aarhus, Odense, København…" />
      </div>
    </div>

    <!-- Række 2: Region / Kommune / Valgsted -->
    <div class="grid grid-cols-1 md:grid-cols-3 md:items-end gap-3">

      <!-- Region -->
      <div>
        <label class="text-sm text-gray-600">Region</label>
        <select id="regionSelect"
                class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
      </div>

      <!-- Kommune -->
      <div>
        <label class="text-sm text-gray-600">Kommune</label>
        <select id="kommuneSelect"
                class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
      </div>

      <!-- Valgsted -->
      <div>
        <label class="text-sm text-gray-600">Valgsted</label>
        <select id="valgstedSelect"
                class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled>
          <option value="">(Vælg kommune for at vælge valgsted)</option>
        </select>
      </div>
    </div>

    <p class="text-sm text-gray-600">
      Vælg en region, kommune og evt. valgsted – eller begynd at skrive i søgefelterne.
      Nedenfor vises Top 10 kandidater for det valgte område.
    </p>
  </section>


  <!-- TOP 10/50 -->
  <section id="overviewTop" class="vb-card p-4">
    <div class="flex items-center justify-between mb-2">
      <div>
        <h2 id="top10Title" class="font-semibold">Top 10 kandidater (personlige stemmer)</h2>
        <!-- Info-boks om procent -->
        <div id="percentInfoOverview"
             class="mt-1 text-xs text-gray-600 bg-gray-50 border border-dashed border-gray-200 rounded-lg px-3 py-1 hidden">
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div id="top10Scope" class="text-sm text-gray-500"></div>
        </div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnModeCand" class="vb-tabbox small active" type="button">Kandidater</button>
          <button id="btnModeParty" class="vb-tabbox small" type="button">Partitotal</button>
        </div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnTop10" class="vb-tabbox small active" type="button">Top 10</button>
          <button id="btnAll" class="vb-tabbox small" type="button">Top 50</button>
        </div>
      </div>
    </div>

    <!-- Loader bar -->
    <div id="loader" class="loader-wrap hidden" aria-live="polite">
      <div class="progress w-48 rounded-full"></div>
      <span>Indlæser…</span>
    </div>

    <div id="top10List" class="top10-grid mt-2">
      <ol id="top10ColLeft" class="space-y-2"></ol>
      <ol id="top10ColRight" class="space-y-2"></ol>
    </div>
  </section>

  <!-- SAMMENLIGN PARTIER -->
  <section id="partyCompareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenlign partier</h2>
      <button id="btnClearParties" class="vb-btn">Nulstil valgte partier</button>
    </div>

    <div id="partySelectedList" class="space-y-2 text-sm"></div>

    <div class="overflow-auto">
      <table class="table-sticky w-full text-sm min-w-[720px]" id="partyTable">
        <thead id="partyThead"></thead>
        <tbody id="partyTbody"></tbody>
        <tfoot id="partyTFoot"></tfoot>
      </table>
    </div>
    <p class="text-xs text-gray-500">
      Barerne viser partiets andel af alle gyldige stemmer i den valgte region / kommune / valgsted.
      Klik på ▸ for at folde regioner ud til kommuner og videre til valgsteder.
    </p>
  </section>

  <!-- PARTIER OG KANDIDATER -->
  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Partier og kandidater</h2>
      <div id="kommunetitel" class="text-gray-500"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <aside class="md:col-span-1 vb-card p-4 space-y-2">
        <label class="text-sm font-medium">Vælg parti</label>
        <div id="partyCombo" class="relative">
          <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
            <span id="partyButtonContent" class="vb-combo-label">
              <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
              <span class="truncate text-gray-500">Vælg kommune først…</span>
            </span>
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4-4.5z"/></svg>
          </button>
          <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
        </div>
      </aside>

      <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
        <div class="flex items-center justify-between gap-3">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg en kommune for at se partier.</div>
          <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
            <button id="btnSortAlpha" class="vb-tabbox small active" type="button" title="Alfabetisk">A–Å</button>
            <button id="btnSortVotes" class="vb-tabbox small" type="button" title="Flest stemmer">Flest stemmer</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div id="candidateColLeft" class="space-y-2"></div>
          <div id="candidateColRight" class="space-y-2"></div>
        </div>
      </section>
    </div>
  </section>

  <!-- SAMMENLIGNING (kandidater) -->
  <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenligning af kandidater</h2>
      <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
    </div>
    <div id="selectedList" class="space-y-2"></div>
  </section>

  <!-- KUN TABEL (diagram fjernet) -->
  <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
    <div class="text-sm text-gray-600">Tabel pr. valgsted</div>
    <div class="overflow-auto">
      <table class="table-sticky w-full text-sm min-w-[720px]" id="psTable">
        <thead id="psThead"></thead>
        <tbody id="psTbody"></tbody>
        <tfoot id="psTFoot"></tfoot>
      </table>
    </div>
  </section>
</main>

<footer class="mt-10 border-t bg-gray-100">
  <div class="mx-auto max-w-6xl px-4 py-6 md:py-8
              flex flex-col md:flex-row items-center justify-between
              gap-3 md:gap-6 text-sm md:text-base text-gray-700">
    
    <a href="mailto:hej@valgbar.dk" class="font-medium hover:text-gray-900">
      hej@valgbar.dk
    </a>

    <p class="text-center">
      Data stammer fra KMDValg, Danmarks Statistik og valg.dk
    </p>

    <a href="/om-valgbar/" class="font-medium underline hover:text-gray-900">
      Om Valgbar
    </a>
  </div>
</footer>

<script>
  /* ===== DATA-STI ===== */
  const BASE_PATH = '../../data/kv/2025';
  const VALGSTED_ALL_VALUE = "__ALL__";

  /* Regioner & kommuner (Hovedstaden + Sjælland slået sammen til Region Østdanmark) */
  const REGIONS = {
    "Region Østdanmark": [
      // Tidligere Region Hovedstaden
      "Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal",
      "Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe",
      "Glostrup","Gribskov","Halsnæs","Helsingør","Herlev","Hillerød","Hvidovre",
      "Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal",
      "Rødovre","Tårnby","Vallensbæk",
      // Tidligere Region Sjælland
      "Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland",
      "Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø",
      "Stevns","Vordingborg"
    ],
    "Region Syddanmark": [
      "Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev",
      "Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense",
      "Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"
    ],
    "Region Midtjylland": [
      "Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig",
      "Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg",
      "Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"
    ],
    "Region Nordjylland": [
      "Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord",
      "Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"
    ]
  };

  /* Partifarver */
  const PARTY_COLORS = {
    "A":"#e03a3e","B":"#712082","C":"#2e7d32","D":"#0f766e","F":"#e5003d",
    "I":"#00a0e3","K":"#ff9800","O":"#0044aa","V":"#1b5eaa","Ø":"#c8102e",
    "Å":"#3aaa35","Q":"#ff4fa3","Æ":"#666666"
  };
  const DEFAULT_BADGE_BG = "#e5e7eb";
  const DEFAULT_BADGE_FG = "#111827";

  /* Navnefix for partier (stavning – meget specifikke tastefejl) */
  const PARTY_NAME_FIX = {
    "Venstre, Danmarks Liberale Part": "Venstre, Danmarks Liberale Parti",
    "Enhedslisten - De Rød - Grønne": "Enhedslisten - De Rød-Grønne"
  };

  /* Lokale lister der findes i flere kommuner – skal have kommunenavn på */
  const LOCAL_MULTI_COMMUNE_PARTIES = new Set([
    "Lokallisten",
    "Fælleslisten",
    "Borgerlisten",
    "Beboerlisten"
  ]);

  /* Partier der ikke må have partibogstav/badge-bogstav */
  const NO_LETTER_PARTIES = new Set([
    "Frihedslisten",
    "Bornholmerlisten",
    "Fælleslisten",
    "SocialKonservative",
    "Feministisk Initiativ",
    "Ærøs Fremtid",
    "Bæredygtigt Samfund",
    "Deltagerlisten",
    "Det Demokratiske Parti",
    "Bydelenes Stemmer",
    "Egalitært Folkeparti",
    "Frigængerne",
    "Partiet Samfundssind",
    "Sten i Skoen"
  ]);

  /* Partier der altid skal ligge øverst i lister */
  const PRIORITY_PARTIES = [
    "Alternativet",
    "Borgernes Parti",
    "Danmarksdemokraterne - Inger Støjberg",
    "Dansk Folkeparti",
    "Det Konservative Folkeparti",
    "Enhedslisten - De Rød-Grønne",
    "Liberal Alliance",
    "Moderaterne",
    "Radikale Venstre",
    "Socialdemokratiet",
    "SF - Socialistisk Folkeparti",
    "Venstre, Danmarks Liberale Parti"
  ];

  /* Total antal kommuner (unikke) */
  const TOTAL_MUNICIPALITIES = (() => {
    const s = new Set();
    Object.values(REGIONS).forEach(list => list.forEach(k => s.add(k)));
    return s.size;
  })();

  /* State & helpers */
  const state = {
    rows:[],
    region:"",
    kommune:"",
    valgsted:"",
    activeParty:"",
    selected:new Map(),         // valgte kandidater
    selectedParties:new Set(),  // valgte partier til sammenligning
    candidateSortMode:"alpha",  // alpha | votes
    topListMode:"top10",        // top10 | all
    overviewMode:"cand",        // "cand" | "party"
    csvCache:new Map(), isLoading:false,
    pendingCandidateId:null,
    pendingCandidateIds:[],
    availableKommuner:new Set(),
    isAvailabilityScanDone:false
  };
  const el = id => document.getElementById(id);
  const fmt = n => new Intl.NumberFormat("da-DK").format(n);
  const fmtPct = v => new Intl.NumberFormat("da-DK",{style:"percent",minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
  const canon = s => (s||"").toString().trim();
  const escapeHtml = s => (s||"").replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  // Normaliser tekst til brug som nøgle (bindestreger, mellemrum, case)
  function normalizePartyKey(raw){
    return canon(raw)
      .replace(/[–—]/g, "-")        // en-/em-dash -> hyphen
      .replace(/\s*-\s*/g, " - ")   // ens mellemrum omkring '-'
      .replace(/\s+/g, " ")         // flere mellemrum -> ét
      .toLowerCase();
  }

  // Gør et råt partinavn til "rigtigt" navn (stavningsfix + heuristik)
  function standardizePartyName(raw){
    let p = canon(raw);
    if(!p) return "";

    if (PARTY_NAME_FIX[p]) {
      p = PARTY_NAME_FIX[p];
    }

    const key = normalizePartyKey(p);

    if (key.startsWith("venstre") || key.startsWith("danmarks liberale parti")) {
      return "Venstre, Danmarks Liberale Parti";
    }

    if (key.startsWith("sf ") || key.startsWith("sf-") || key.startsWith("sf -") ||
        key.startsWith("sf,") || key.startsWith("socialistisk folkeparti")) {
      return "SF - Socialistisk Folkeparti";
    }

    if (key.startsWith("radikale venstre") || key.startsWith("det radikale venstre")) {
      return "Radikale Venstre";
    }

    if (key.startsWith("enhedslisten")) {
      return "Enhedslisten - De Rød-Grønne";
    }

    if (key.startsWith("danmarksdemokraterne")) {
      return "Danmarksdemokraterne - Inger Støjberg";
    }

    return p;
  }

  /* Sortering med prioritetspartier først */
  function priorityPartySort(a, b){
    const ia = PRIORITY_PARTIES.indexOf(a);
    const ib = PRIORITY_PARTIES.indexOf(b);
    const aPr = ia !== -1;
    const bPr = ib !== -1;
    if (aPr && bPr) return ia - ib;
    if (aPr) return -1;
    if (bPr) return 1;
    return a.localeCompare(b, "da");
  }

  const isListestemmer = name => {
    const t=(canon(name)).toLowerCase();
    return t==="partiliste"||t==="listestemmer"||t==="liste";
  };

  const totalValidVotes = (rows) => {
    let sum = 0;
    for(const r of rows){ sum += r.stemmer || 0; }
    return sum;
  };

  function getActiveRows(){
    const rows = state.rows || [];
    if(state.kommune && state.valgsted && state.valgsted !== VALGSTED_ALL_VALUE){
      return rows.filter(r => r.valgsted_id === state.valgsted);
    }
    return rows;
  }

  // Stripper evt. foranstillet rækkenummer: "55. 9. Sydhavn" -> "9. Sydhavn"
  function formatValgstedNameForDisplay(name){
    const s = canon(name);
    const m = s.match(/^\d+\.\s*(.+)$/);
    return m ? m[1] : s;
  }

  function getCurrentValgstedName(){
    if(!state.kommune || !state.valgsted || state.valgsted === VALGSTED_ALL_VALUE) return "";
    const row = (state.rows || []).find(r => r.valgsted_id === state.valgsted);
    return row ? formatValgstedNameForDisplay(row.valgsted_navn) : "";
  }

  const normalizeCandidateName = (name) => (name||"").replace(/,(\S)/g, ', $1');

  const sortKandidaterAlpha = (a,b)=>{
    const aName = normalizeCandidateName(a.kandidat_navn);
    const bName = normalizeCandidateName(b.kandidat_navn);
    const al=isListestemmer(aName), bl=isListestemmer(bName);
    if(al&&!bl) return 1; if(!al&&bl) return -1;
    return aName.localeCompare(bName,"da");
  };
  const sortKandidaterVotes = (a,b)=>{
    const aName = normalizeCandidateName(a.kandidat_navn);
    const bName = normalizeCandidateName(b.kandidat_navn);
    const al=isListestemmer(aName), bl=isListestemmer(bName);
    if(al&&!bl) return 1; if(!al&&bl) return -1;
    const dv=(b.total||0)-(a.total||0); if(dv!==0) return dv;
    return aName.localeCompare(bName,"da");
  };

  function badge(letter){
    const bg=letter && PARTY_COLORS[letter] ? PARTY_COLORS[letter] : DEFAULT_BADGE_BG;
    const fg=letter && PARTY_COLORS[letter] ? "#fff" : DEFAULT_BADGE_FG;
    return { style:`background-color:${bg};color:${fg};border-color:${bg}`, text:(letter||" ") };
  }

  function detectPartyLetter(rowsForParti){
    if (!rowsForParti || !rowsForParti.length) return null;
    const name = standardizePartyName(rowsForParti[0].parti || "");

    const map = {
      "Socialdemokratiet": "A",
      "Radikale Venstre": "B",
      "Det Konservative Folkeparti": "C",
      "Nye Borgerlige": "D",
      "SF - Socialistisk Folkeparti": "F",
      "Liberal Alliance": "I",
      "Kristendemokraterne": "K",
      "Dansk Folkeparti": "O",
      "Venstre, Danmarks Liberale Parti": "V",
      "Enhedslisten - De Rød-Grønne": "Ø",
      "Alternativet": "Å"
    };

    return map[name] || null;
  }

  /* ===== Region-lookup ===== */
  function findRegionForKommune(kommune){
    for(const [reg, kommuner] of Object.entries(REGIONS)){
      if(kommuner.includes(kommune)) return reg;
    }
    return "";
  }

  function regionFolderForKommune(kommune){
    const region = findRegionForKommune(kommune);
    return region || null;
  }

  /* ===== URL helpers ===== */
  function getSelectedIds(){ return Array.from(state.selected.keys()); }
  function setSelectedFromIds(idArr){ state.pendingCandidateIds = (idArr||[]).filter(Boolean); }

  function persistUrl(push=false){
    const u=new URL(location.href);
    if(state.region) u.searchParams.set("region", state.region); else u.searchParams.delete("region");
    if(state.kommune) u.searchParams.set("kommune", state.kommune); else u.searchParams.delete("kommune");
    if(state.kommune){
      if(state.valgsted && state.valgsted !== VALGSTED_ALL_VALUE) u.searchParams.set("valgsted", state.valgsted);
      else u.searchParams.delete("valgsted");
    } else {
      u.searchParams.delete("valgsted");
    }
    if(state.activeParty) u.searchParams.set("parti", state.activeParty); else u.searchParams.delete("parti");
    const candList = getSelectedIds();
    if(candList.length) u.searchParams.set("cand", candList.join("|")); else u.searchParams.delete("cand");
    const partiesList = Array.from(state.selectedParties || []);
    if(partiesList.length) u.searchParams.set("parties", partiesList.join("|")); else u.searchParams.delete("parties");
    if(state.topListMode !== "top10") u.searchParams.set("view", "top50"); else u.searchParams.delete("view");
    if(state.candidateSortMode !== "alpha") u.searchParams.set("sort", "votes"); else u.searchParams.delete("sort");

    if(push) history.pushState({}, "", u); else history.replaceState({}, "", u);
  }

  async function hydrateFromUrl(){
    const p=new URLSearchParams(location.search);
    const r=p.get("region"); const k=p.get("kommune"); const parti=p.get("parti");
    const candParam = (p.get("cand") || "").trim();
    const cand = candParam
      ? (candParam.includes('|')
          ? candParam.split('|').map(s=>s.trim()).filter(Boolean)
          : [candParam])
      : [];
    const partiesParam = (p.get("parties") || "").trim();
    const parties = partiesParam
      ? partiesParam.split('|').map(s=>s.trim()).filter(Boolean)
      : [];
    const view=p.get("view");
    const sort=p.get("sort");
    const vsted=p.get("valgsted");

    state.topListMode = (view === "top50") ? "all" : "top10";
    state.candidateSortMode = (sort === "votes") ? "votes" : "alpha";
    state.selectedParties = new Set(parties);
    updateTopToggleUI();
    updateCandSortToggleUI();
    updateModeToggleUI();
    updateTopButtonsForScope();

    if(r && REGIONS[r]){
      el("regionSelect").value=r; populateKommuner(r); state.region=r;
      if(k && REGIONS[r].includes(k)){
        el("kommuneSelect").value=k; state.kommune=k;
        state.valgsted = vsted || VALGSTED_ALL_VALUE;
        await loadKommuneData(k);
      }
      else {
        el("kommuneSelect").value=""; state.kommune=""; state.valgsted = "";
        await loadRegionData(r);
      }
    }else{
      el("regionSelect").value="";
      el("kommuneSelect").innerHTML='<option value="">Vælg kommune…</option>';
      el("kommuneSelect").disabled=true;
      const vsel = el("valgstedSelect");
      if(vsel){
        vsel.disabled = true;
        vsel.innerHTML = '<option value="">(Vælg kommune for at vælge valgsted)</option>';
      }
      state.region=""; state.kommune=""; state.valgsted="";
      await loadNationalData();
    }

    if(state.kommune && parti){
      const stats = getPartyStats();
      if(stats.some(s=>s.parti===parti)){
        state.activeParty = parti;
        renderPartyCombobox();
        renderPartyDetail(parti);
      } else {
        state.activeParty = "";
        renderPartyCombobox();
      }
    }else{
      state.activeParty="";
      renderPartyCombobox();
    }

    setSelectedFromIds(cand);
    applyPendingSelections();

    renderOverview();
    renderAll();
    renderContextBar();
    updatePartyScopeSelect();
    renderPartyCompare();
  }

  /* ===== INIT ===== */
  window.addEventListener("DOMContentLoaded", async ()=>{
    renderLanding(); initRegionDropdown();

    const yearSel = el("kvYearSelect");
    if(yearSel){
      yearSel.addEventListener("change", ()=>{
        const url = yearSel.value;
        if(url) window.location.href = url;
      });
    }

    el("btnSortAlpha").addEventListener("click", ()=>{
      if(state.candidateSortMode!=="alpha"){
        state.candidateSortMode="alpha";
        updateCandSortToggleUI();
        if(state.activeParty) renderPartyDetail(state.activeParty);
        persistUrl(true);
      }
    });
    el("btnSortVotes").addEventListener("click", ()=>{
      if(state.candidateSortMode!=="votes"){
        state.candidateSortMode="votes";
        updateCandSortToggleUI();
        if(state.activeParty) renderPartyDetail(state.activeParty);
        persistUrl(true);
      }
    });

    el("btnModeCand").addEventListener("click", ()=>{
      if(state.overviewMode!=="cand"){
        state.overviewMode="cand";
        updateModeToggleUI();
        updateTopButtonsForScope();
        renderOverview();
      }
    });
    el("btnModeParty").addEventListener("click", ()=>{
      if(state.overviewMode!=="party"){
        state.overviewMode="party";
        updateModeToggleUI();
        updateTopButtonsForScope();
        renderOverview();
      }
    });

    el("btnTop10").addEventListener("click", ()=>{
      if(state.topListMode!=="top10"){
        state.topListMode="top10";
        updateTopToggleUI();
        renderOverview();
        persistUrl(true);
      }
    });
    el("btnAll").addEventListener("click", ()=>{
      if(state.topListMode!=="all"){
        state.topListMode="all";
        updateTopToggleUI();
        renderOverview();
        persistUrl(true);
      }
    });

    const partyScopeSel = el("partyScopeSelect");
    if (partyScopeSel) {
      partyScopeSel.addEventListener("change", () => {
        const val = partyScopeSel.value || "";
        if (!val) return;
        state.selectedParties.add(val);
        partyScopeSel.value = "";
        renderPartyCompare();
        persistUrl(false);
      });
    }

    const btnClearParties = el("btnClearParties");
    if (btnClearParties) {
      btnClearParties.addEventListener("click", () => {
        state.selectedParties.clear();
        renderPartyCompare();
        persistUrl(false);
      });
    }

    await hydrateFromUrl();

    el("btnClearAll").onclick=()=>{ state.selected.clear(); renderAll(); persistUrl(false); };
    document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePartyMenu(); });

    renderContextBar();
    updateModeToggleUI();
    updateTopButtonsForScope();
    renderLiveStatus();

    window.addEventListener('popstate', ()=>{ hydrateFromUrl(); });

    scanDataAvailability().catch(()=>{});
  });

  function updateCandSortToggleUI(){
    const a=el("btnSortAlpha"), b=el("btnSortVotes");
    if(state.candidateSortMode==="alpha"){ a.classList.add("active"); b.classList.remove("active"); }
    else { b.classList.add("active"); a.classList.remove("active"); }
  }
  function updateTopToggleUI(){
    const a=el("btnTop10"), b=el("btnAll");
    if(state.topListMode==="top10"){ a.classList.add("active"); b.classList.remove("active"); }
    else { b.classList.add("active"); a.classList.remove("active"); }
  }
  function updateModeToggleUI(){
    const a=el("btnModeCand"), b=el("btnModeParty");
    const isParty = state.overviewMode==="party";
    if(a && b){
      a.classList.toggle("active", !isParty);
      b.classList.toggle("active", isParty);
    }
  }

  /* ===== LOADER ===== */
  function showLoading(){
    state.isLoading = true;
    el('loader')?.classList.remove('hidden');
    el('overviewTop')?.setAttribute('aria-busy','true');
    el('regionSelect')?.setAttribute('disabled','');
    el('kommuneSelect')?.setAttribute('disabled','');
    el('valgstedSelect')?.setAttribute('disabled','');
  }
  function hideLoading(){
    state.isLoading = false;
    el('loader')?.classList.add('hidden');
    el('overviewTop')?.removeAttribute('aria-busy');
    if (state.region) el('kommuneSelect')?.removeAttribute('disabled'); else el('kommuneSelect')?.setAttribute('disabled','');
    if (state.kommune) el('valgstedSelect')?.removeAttribute('disabled'); else el('valgstedSelect')?.setAttribute('disabled','');
    el('regionSelect')?.removeAttribute('disabled');
  }

  /* ===== LIVE STATUS ===== */
  function renderLiveStatus(){
    const box = el('liveStatusText');
    if(!box) return;
    const count = state.availableKommuner ? state.availableKommuner.size : 0;
    if(!state.isAvailabilityScanDone && count === 0){
      box.textContent = 'Scanner efter kommuner med opgjorte data…';
    } else {
      box.textContent = `Der er opgjort data for ${count} ud af ${TOTAL_MUNICIPALITIES} kommuner.`;
    }
  }

  async function scanDataAvailability(){
    const allKommuner = Array.from(new Set(Object.values(REGIONS).flat()));
    const available = new Set(state.availableKommuner || []);
    for(const k of allKommuner){
      if(available.has(k)) continue;
      try{
        const rows = await loadRowsForKommune(k);
        if(rows && rows.length) available.add(k);
      }catch(_){}
    }
    state.availableKommuner = available;
    state.isAvailabilityScanDone = true;
    renderLiveStatus();

    if(state.region){
      const ksel = el('kommuneSelect');
      const current = ksel?.value || state.kommune || "";
      populateKommuner(state.region);
      if(ksel && current && state.availableKommuner.has(current)){
        ksel.value = current;
      }
    }
  }

  /* ===== Kandidatsøgning helpers ===== */
  const fold = (s) => (s||"").toString()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .toLowerCase().trim();

  function buildCandidateList(rows){
    const m = new Map();
    for(const r of rows){
      if(isListestemmer(r.kandidat_navn)) continue;
      if(!m.has(r.kandidat_id)){
        m.set(r.kandidat_id, { kandidat_id:r.kandidat_id, kandidat_navn:r.kandidat_navn, parti:r.parti });
      }
    }
    return Array.from(m.values());
  }

  function rankCandidates(cands, q){
    const Q = fold(q);
    if(!Q) return [];
    return cands.map(c=>{
      const name = normalizeCandidateName(c.kandidat_navn);
      const f = fold(name);
      let score = -Infinity;

      if(f.startsWith(Q)) score = 300 - (f.length - Q.length);
      else{
        const hasWordStart = f.split(/\s+/).some(w=>w.startsWith(Q));
        if(hasWordStart) score = 200 - f.indexOf(Q);
        else if(f.includes(Q)) score = 100 - f.indexOf(Q);
      }

      const pf = fold(c.parti);
      if(pf.startsWith(Q) || pf.includes("("+Q+")")) score += 20;

      return { ...c, _score: score, _name: name };
    })
    .filter(x=>x._score>-Infinity)
    .sort((a,b)=> b._score - a._score || a._name.localeCompare(b._name, "da"))
    .slice(0, 15);
  }

  /* ===== LANDING UI (inkl. kandidatsøgning) ===== */
  function renderLanding(){
    const inputK = el('kommuneSearch');
    if(inputK){
      inputK.addEventListener('input', (e)=>{
        const val=(e.target.value||'').toLowerCase();
        if(!val) return;
        const hit = Object.entries(REGIONS)
          .flatMap(([r,ks])=>ks.map(k=>({r,k})))
          .find(x=>x.k.toLowerCase().startsWith(val));
        if(hit){
          el('regionSelect').value=hit.r; populateKommuner(hit.r);
          el('kommuneSelect').value=hit.k; state.region=hit.r; state.kommune=hit.k; state.valgsted = VALGSTED_ALL_VALUE;
          persistUrl(true);
          loadKommuneData(hit.k);
        }
      });
    }

    const input = el('candidateSearch');
    const menu  = el('candidateMenu');
    let activeIndex = -1;

    function closeMenu(){ menu.classList.add('hidden'); activeIndex = -1; }
    function openMenu(){ menu.classList.remove('hidden'); }

    function renderMenuFor(query){
      const cands = buildCandidateList(state.rows || []);
      const results = rankCandidates(cands, query);
      if(!results.length){ closeMenu(); menu.innerHTML=""; return; }

      menu.innerHTML = results.map((c,i)=>{
        const letter = detectPartyLetter((state.rows||[]).filter(r=>r.parti===c.parti));
        const bd = badge(letter);
        const sub = `${escapeHtml(c.parti)}`;
        return `<div class="vb-option" role="option" data-idx="${i}" data-cand="${escapeHtml(c.kandidat_id)}" aria-selected="${i===activeIndex}">
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
          <span class="flex-1">
            <span class="font-medium">${escapeHtml(normalizeCandidateName(c.kandidat_navn))}</span><br/>
            <span class="text-xs text-gray-500">${sub}</span>
          </span>
        </div>`;
      }).join("");

      menu.querySelectorAll('.vb-option').forEach(opt=>{
        opt.onclick = ()=> selectByIndex(parseInt(opt.getAttribute('data-idx'),10));
      });

      openMenu();
    }

    function selectByIndex(i){
      const cands = buildCandidateList(state.rows || []);
      const results = rankCandidates(cands, input.value);
      const sel = results[i];
      if(!sel) return;
      toggleCandidateFromTop(sel.kandidat_id, state.rows || []);
      closeMenu();
      input.value = "";
    }

    let t=null;
    input?.addEventListener('input', ()=>{
      const q = input.value.trim();
      if(t) clearTimeout(t);
      if(!q){ closeMenu(); return; }
      t = setTimeout(()=>renderMenuFor(q), 120);
    });

    input?.addEventListener('keydown', (e)=>{
      const results = rankCandidates(buildCandidateList(state.rows||[]), input.value);
      if(e.key==='ArrowDown'){
        e.preventDefault();
        if(!results.length) return;
        activeIndex = (activeIndex+1) % results.length;
        renderMenuFor(input.value);
        const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
        if(opt){
          menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false'));
          opt.setAttribute('aria-selected','true');
          opt.scrollIntoView({block:'nearest'});
        }
      }else if(e.key==='ArrowUp'){
        e.preventDefault();
        if(!results.length) return;
        activeIndex = (activeIndex<=0 ? results.length-1 : activeIndex-1);
        renderMenuFor(input.value);
        const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
        if(opt){
          menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false'));
          opt.setAttribute('aria-selected','true');
          opt.scrollIntoView({block:'nearest'});
        }
      }else if(e.key==='Enter'){
        if(!menu.classList.contains('hidden')){
          e.preventDefault();
          selectByIndex(activeIndex>=0 ? activeIndex : 0);
        }
      }else if(e.key==='Escape'){
        closeMenu();
      }
    });

    document.addEventListener('click',(e)=>{
      const box = el('candidateSearch')?.parentElement;
      if(box && !box.contains(e.target)) closeMenu();
    });
  }

  /* ===== DROPDOWNS ===== */
  function initRegionDropdown(){
    const rsel=el("regionSelect");
    rsel.innerHTML=`<option value="">Hele Danmark</option>`+
      Object.keys(REGIONS).map(r=>`<option value="${r}">${r}</option>`).join("");
    rsel.onchange=()=>{
      const r=rsel.value; state.region=r; state.kommune=""; state.valgsted=""; state.activeParty="";
      el("kommuneSelect").disabled=!r;
      el("kommuneSelect").innerHTML=`<option value="">Vælg kommune…</option>`;
      const vsel = el("valgstedSelect");
      if(vsel){
        vsel.disabled = true;
        vsel.innerHTML = `<option value="">(Vælg kommune for at vælge valgsted)</option>`;
      }
      if(r) populateKommuner(r);
      clearAll();
      if(r){ persistUrl(true); loadRegionData(r); } else { persistUrl(true); loadNationalData(); }
      renderContextBar();
    };
    el("kommuneSelect").disabled=true;
  }

  function populateKommuner(region){
    const ksel = el("kommuneSelect");
    const kommuner = (REGIONS[region] || []).slice().sort((a, b) =>
      a.localeCompare(b, "da")
    );

    const hasAvailabilityInfo = state.isAvailabilityScanDone;
    const available = state.availableKommuner || new Set();
    ksel.innerHTML=`<option value="">Vælg kommune…</option>`+
      kommuner.map(k=>{
        const isAvailable = !hasAvailabilityInfo || available.has(k);
        const disabledAttr = isAvailable ? "" : " disabled";
        const label = isAvailable ? k : `${k} (ingen data endnu)`;
        const classAttr = isAvailable ? "" : " text-gray-400";
        return `<option value="${k}"${disabledAttr} class="${classAttr}">${label}</option>`;
      }).join("");
    ksel.onchange=()=>{
      const k=ksel.value; state.kommune=k; state.activeParty=""; state.valgsted=""; clearAll();
      const vsel = el("valgstedSelect");
      if(vsel){
        if(k){
          vsel.disabled = true;
          vsel.innerHTML = `<option value="">Indlæser valgsteder…</option>`;
        } else {
          vsel.disabled = true;
          vsel.innerHTML = `<option value="">(Vælg kommune for at vælge valgsted)</option>`;
        }
      }
      if(k){
        persistUrl(true);
        loadKommuneData(k);
      }else{
        persistUrl(true);
        loadRegionData(state.region);
      }
      renderContextBar();
    };
  }

  function clearAll(){
    state.rows=[]; state.selected.clear();
    state.valgsted="";
    resetPartyUI(); renderAll(); el("kommunetitel").textContent="";
    const vsel = el("valgstedSelect");
    if(vsel){
      if(state.kommune){
        vsel.disabled = false;
        vsel.innerHTML = `<option value="">Vælg valgsted…</option>`;
      } else {
        vsel.disabled = true;
        vsel.innerHTML = `<option value="">(Vælg kommune for at vælge valgsted)</option>`;
      }
    }
  }
  function resetPartyUI(){
    const btn=el("partyButton"), btnc=el("partyButtonContent");
    const disabled = !state.kommune;
    btn.disabled = disabled; btn.setAttribute('aria-expanded','false');
    btnc.innerHTML = disabled
      ? `<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg kommune først…</span>`
      : `<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`;
    el("partyMenu").innerHTML="";
    el("partyDetailHeader").textContent = disabled ? "Vælg en kommune for at se partier." : "Vælg et parti i drop-down menuen.";
    el("candidateColLeft").innerHTML=""; el("candidateColRight").innerHTML="";
  }

  function populateValgsteder(){
    const vsel = el("valgstedSelect");
    if(!vsel) return;
    if(!state.kommune){
      vsel.disabled = true;
      vsel.innerHTML = `<option value="">(Vælg kommune for at vælge valgsted)</option>`;
      state.valgsted = "";
      return;
    }
    const rows = state.rows || [];
    const map = new Map();
    for(const r of rows){
      const id = canon(r.valgsted_id);
      const navn = canon(r.valgsted_navn);
      if(!id || !navn) continue;
      if(!map.has(id)) map.set(id, navn);
    }
    const entries = Array.from(map.entries()).sort((a,b)=>a[1].localeCompare(b[1],'da'));
    if(!entries.length){
      vsel.disabled = true;
      vsel.innerHTML = `<option value="">(Ingen valgsteder fundet)</option>`;
      state.valgsted = "";
      return;
    }
    vsel.disabled = false;
    const allOpt = `<option value="${VALGSTED_ALL_VALUE}">Alle valgsteder i kommunen</option>`;
    const opts = entries.map(([id,navn])=>`<option value="${escapeHtml(id)}">${escapeHtml(formatValgstedNameForDisplay(navn))}</option>`).join("");
    vsel.innerHTML = `<option value="">Vælg valgsted…</option>${allOpt}${opts}`;
    let want = state.valgsted;
    if(!want){
      want = VALGSTED_ALL_VALUE;
    }
    vsel.value = want;
    if(!vsel.value){
      vsel.value = VALGSTED_ALL_VALUE;
    }
    state.valgsted = vsel.value;
    vsel.onchange = ()=>{
      const v = vsel.value;
      state.valgsted = v || "";
      renderOverview();
      renderAll();
      renderContextBar();
      persistUrl(true);
    };
  }

  /* ===== DATA ===== */
  async function fetchCsvText(url){
    const r=await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("404");
    return await r.text();
  }

  function parseCsvTextToRows(text, kommuneName){
    const res = Papa.parse(text,{
      header:true,
      skipEmptyLines:true,
      transformHeader:h=>canon(h.toLowerCase())
    });

    const kommuneFixed = canon(kommuneName || "");
    const regionFixed = kommuneFixed ? findRegionForKommune(kommuneFixed) : "";

    return res.data.map(r=>{
      const region = canon(r.region || regionFixed || "");
      const kommune = canon(r.kommune || kommuneFixed || "");

      const partiRaw = r.parti || r.listenavn;
      let parti = standardizePartyName(partiRaw);

      if (LOCAL_MULTI_COMMUNE_PARTIES.has(parti) && kommune){
        parti = `${parti} (${kommune})`;
      }

      const noLetter = NO_LETTER_PARTIES.has(parti);
      const parti_bogstav_raw = canon(
        r.parti_bogstav || r.listebogstav || r.bogstavsbetegnelse || ""
      );
      const parti_bogstav = noLetter ? "" : parti_bogstav_raw;

      const valgstedNavn = canon(
        r.valgsted_navn || r.sted_navn || r["afstemningsområde"] || ""
      );
      const valgstedId = canon(
        r.valgsted_id || r.sted_id || valgstedNavn
      );

      const kandidatNavnRaw = canon(
        r.kandidat_navn || r.navn || ""
      );
      const kandidatNavn = normalizeCandidateName(kandidatNavnRaw);
      const kandidatId = canon(
        r.kandidat_id || r.kandidat_navn || r.navn || kandidatNavn
      );

      const stemmer = Number(
        r.stemmer || r.stemmetal || 0
      ) || 0;

      return {
        region,
        kommune,
        valgsted_id: valgstedId,
        valgsted_navn: valgstedNavn,
        kandidat_id: kandidatId,
        kandidat_navn: kandidatNavn,
        parti,
        parti_bogstav,
        stemmer
      };
    });
  }

  async function loadRowsForKommune(k){
    if(state.csvCache.has(k)) return state.csvCache.get(k);
    const folder = regionFolderForKommune(k);
    const safeK = encodeURIComponent(k);
    const baseDir = folder ? `${BASE_PATH}/${encodeURIComponent(folder)}` : BASE_PATH;
    const candidates=[
      `${baseDir}/${safeK}_allepartier.csv`,
      `${baseDir}/${safeK}.csv`
    ];
    for(const url of candidates){
      try{
        const text = await fetchCsvText(url);
        const rows = parseCsvTextToRows(text, k);
        state.csvCache.set(k, rows);
        return rows;
      }catch(_){}
    }
    throw new Error('not found');
  }

  async function loadNationalData(){
    try{
      showLoading();
      el('error').textContent=''; el('kommunetitel').textContent='(Danmark)';
      state.valgsted = "";
      const allNames = Object.values(REGIONS).flat();
      const chunks = await Promise.all(allNames.map(name=>loadRowsForKommune(name).catch(()=>[])));
      state.rows = chunks.flat();
      afterDataLoaded();
    }finally{ hideLoading(); }
  }
  async function loadRegionData(region){
    try{
      showLoading();
      el('error').textContent=''; el('kommunetitel').textContent=`(${region})`;
      state.valgsted = "";
      const names = (REGIONS[region]||[]);
      const chunks = await Promise.all(names.map(name=>loadRowsForKommune(name).catch(()=>[])));
      state.rows = chunks.flat();
      afterDataLoaded();
    }finally{ hideLoading(); }
  }
  async function loadKommuneData(k){
    try{
      showLoading();
      el("error").textContent=""; el("kommunetitel").textContent=k?`(${k})`:"";
      const rows = await loadRowsForKommune(k);
      state.rows = rows; afterDataLoaded();
    }catch(e){
      const folder = regionFolderForKommune(k) || '[Region]';
      el("error").textContent=`Kunne ikke finde data for ${k}. Forventede fx ${BASE_PATH}/${folder}/${k}_allepartier.csv`;
    }finally{ hideLoading(); }
  }

  function afterDataLoaded(){
    if(state.pendingCandidateId){
      const sample = state.rows.find(r=>r.kandidat_id===state.pendingCandidateId);
      if(sample && !isListestemmer(sample.kandidat_navn)){
        state.selected.set(sample.kandidat_id, { kandidat_id: sample.kandidat_id, kandidat_navn: sample.kandidat_navn, parti: sample.parti });
      }
      state.pendingCandidateId = null;
    }

    applyPendingSelections();

    resetPartyUI();
    if(state.kommune){
      renderPartyCombobox();
      populateValgsteder();
    } else {
      const vsel = el("valgstedSelect");
      if(vsel){
        vsel.disabled = true;
        vsel.innerHTML = `<option value="">(Vælg kommune for at vælge valgsted)</option>`;
      }
      state.valgsted = "";
    }

    updateTopButtonsForScope();
    renderOverview();
    renderAll();
    renderContextBar();

    document.getElementById('candidateMenu')?.classList.add('hidden');

    updatePartyScopeSelect();
    renderPartyCompare();
  }

  function applyPendingSelections(){
    if(state.pendingCandidateIds && state.pendingCandidateIds.length){
      for(const id of state.pendingCandidateIds){
        const sample = state.rows.find(r=>r.kandidat_id===id);
        if(sample && !isListestemmer(sample.kandidat_navn)){
          state.selected.set(sample.kandidat_id, { kandidat_id: sample.kandidat_id, kandidat_navn: sample.kandidat_navn, parti: sample.parti });
        }
      }
      state.pendingCandidateIds = [];
    }
  }

  /* ===== TOP 10 / 50 – kandidater & partier ===== */
  function totalsByCandidate(rows){
    const m=new Map();
    for(const r of rows){
      if(!m.has(r.kandidat_id)){
        m.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
      }
      m.get(r.kandidat_id).total+=r.stemmer;
    }
    return Array.from(m.values())
      .filter(k=>!isListestemmer(k.kandidat_navn))
      .sort((a,b)=>b.total-a.total);
  }

  function totalsByPartyAllVotes(rows){
    const m = new Map();
    for(const r of rows){
      const parti = r.parti || "(ukendt parti)";
      m.set(parti, (m.get(parti)||0) + (r.stemmer||0));
    }
    const entries = Array.from(m.entries()).map(([parti,total])=>{
      const rowsForParti = rows.filter(x=>x.parti===parti);
      const letter = detectPartyLetter(rowsForParti);
      return { parti, total, letter };
    });
    entries.sort((a,b)=>(b.total-a.total) || a.parti.localeCompare(b.parti,"da"));
    return entries;
  }

  function primaryKommuneForCandidate(candId, rows){
    const count=new Map(); const reg=new Map();
    for(const r of rows){
      if(r.kandidat_id===candId){
        count.set(r.kommune,(count.get(r.kommune)||0)+1);
        if(r.region) reg.set(r.kommune, r.region);
      }
    }
    if(count.size===0) return null;
    const [kommune, ] = Array.from(count.entries()).sort((a,b)=>b[1]-a[1])[0];
    const regionFromCsv = reg.get(kommune) || "";
    const regionFinal = regionFromCsv || findRegionForKommune(kommune);
    return { kommune, region: regionFinal };
  }

  function renderOverview(){
    const rows = getActiveRows();
    const totalValid = totalValidVotes(rows);
    const showCandidatePercent = !!state.kommune;

    const isDK = !state.region && !state.kommune;
    let scopeText = "";
    if(isDK){
      scopeText = "Danmark";
    } else if(state.region && !state.kommune){
      scopeText = state.region;
    } else if(state.kommune){
      const vName = getCurrentValgstedName();
      if(state.valgsted && state.valgsted !== VALGSTED_ALL_VALUE && vName){
        scopeText = `${state.kommune} – ${vName}`;
      } else {
        scopeText = state.kommune;
      }
    }
    el("top10Scope").textContent = rows.length ? scopeText : '';

    const infoBox = el("percentInfoOverview");
    if(infoBox){
      if(state.overviewMode === "party"){
        infoBox.textContent = "Procenttallet viser partiets samlede andel af alle gyldige stemmer i det valgte område.";
        infoBox.classList.remove("hidden");
      } else if(state.overviewMode === "cand" && showCandidatePercent){
        infoBox.textContent = "Procenttallet viser en kandidats samlede andel af alle gyldige stemmer i det valgte område.";
        infoBox.classList.remove("hidden");
      } else {
        infoBox.classList.add("hidden");
      }
    }

    if(state.overviewMode === "party"){
      const ranked = totalsByPartyAllVotes(rows);
      const isTop10 = state.topListMode === "top10";
      const list = isTop10 ? ranked.slice(0,10) : ranked;

      el("top10Title").textContent = isTop10
        ? "Top 10 partier (personlige + listestemmer)"
        : "Alle partier (personlige + listestemmer)";

      function itemHTML(p, idx){
        const bd = badge(p.letter);
        const share = totalValid > 0 ? p.total / totalValid : null;
        const shareLabel = share !== null ? fmtPct(share) : null;
        const base = `${fmt(p.total)} stemmer i alt (personlige + liste)`;
        const meta = shareLabel ? `${base} · ${shareLabel}` : base;
        return `<li class="top10-item" data-parti="${escapeHtml(p.parti)}" role="button" tabindex="0">
          <span class="rank-pill">${idx}</span>
          <div class="min-w-0 flex-1">
            <div class="font-medium truncate">${escapeHtml(p.parti)}</div>
            <div class="text-xs text-gray-500 truncate">${meta}</div>
          </div>
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
        </li>`;
      }

      const half = Math.ceil(list.length/2);
      const left = list.slice(0,half);
      const right = list.slice(half);

      el("top10ColLeft").innerHTML =
        left.map((p,i)=>itemHTML(p, i+1)).join("") ||
        `<div class="text-sm text-gray-500">Ingen data at vise.</div>`;
      el("top10ColRight").innerHTML =
        right.map((p,i)=>itemHTML(p, i+1+half)).join("");

      ['top10ColLeft','top10ColRight'].forEach(rootId=>{
        const root = document.getElementById(rootId);
        if(!root) return;
        root.querySelectorAll('.top10-item').forEach(item=>{
          const parti=item.getAttribute('data-parti');
          const activate = ()=>{
            if(!state.kommune){
              state.selectedParties.add(parti);
              renderPartyCompare();
              persistUrl(false);
              el('partyScopeSelect') && (el('partyScopeSelect').value = "");
              document.getElementById('partyCompareSection')?.scrollIntoView({behavior:'smooth'});
              return;
            }
            state.activeParty = parti;
            renderPartyCombobox();
            renderPartyDetail(parti);
            const u=new URL(location.href);
            u.searchParams.set("parti", parti);
            u.searchParams.delete("cand");
            history.replaceState({}, "", u);
            document.getElementById('partyDetail')?.scrollIntoView({behavior:'smooth'});
          };
          item.addEventListener('click', activate);
          item.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===' '){
              e.preventDefault();
              activate();
            }
          });
        });
      });

    } else {
      const ranked = totalsByCandidate(rows);
      let list;
      if(state.topListMode==="top10"){
        list = ranked.slice(0,10);
        el("top10Title").textContent = "Top 10 kandidater (personlige stemmer)";
      }else{
        list = ranked.slice(0,50);
        el("top10Title").textContent = "Top 50 kandidater (personlige stemmer)";
      }

      function itemHTML(k, idx){
        const letter = detectPartyLetter(rows.filter(r=>r.parti===k.parti));
        const bd = badge(letter);
        const share = showCandidatePercent && totalValid > 0 ? (k.total || 0) / totalValid : null;
        const shareLabel = share !== null ? fmtPct(share) : null;
        const base = `${escapeHtml(k.parti)} · ${fmt(k.total)} personlige stemmer`;
        const meta = shareLabel ? `${base} · ${shareLabel}` : base;
        return `<li class="top10-item" data-cand="${escapeHtml(k.kandidat_id)}" role="button" tabindex="0" title="Klik for at se kandidatens kommune">
          <span class="rank-pill">${idx}</span>
          <div class="min-w-0 flex-1">
            <div class="font-medium truncate">${escapeHtml(normalizeCandidateName(k.kandidat_navn))}</div>
            <div class="text-xs text-gray-500 truncate">${meta}</div>
          </div>
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
        </li>`;
      }

      const half=Math.ceil(list.length/2), left=list.slice(0,half), right=list.slice(half);
      el("top10ColLeft").innerHTML =
        left.map((k,i)=>itemHTML(k, i+1)).join("") ||
        `<div class="text-sm text-gray-500">Ingen data at vise.</div>`;
      el("top10ColRight").innerHTML =
        right.map((k,i)=>itemHTML(k, i+1+half)).join("");

      ['top10ColLeft','top10ColRight'].forEach(rootId=>{
        const root = document.getElementById(rootId);
        if(!root) return;
        root.querySelectorAll('.top10-item').forEach(item=>{
          const candId=item.getAttribute('data-cand');
          item.addEventListener('click', ()=>toggleCandidateFromTop(candId, state.rows || []));
          item.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'||e.key===' '){
              e.preventDefault();
              toggleCandidateFromTop(candId, state.rows || []);
            }
          });
        });
      });
    }
  }

  function toggleCandidateFromTop(candId, rows){
    const target = primaryKommuneForCandidate(candId, rows);
    if(!state.kommune || (target && target.kommune && state.kommune!==target.kommune)){
      if(target){
        const rsel = el('regionSelect');
        rsel.value = target.region; state.region = target.region;
        populateKommuner(target.region);
        const ksel = el('kommuneSelect');
        ksel.value = target.kommune; state.kommune = target.kommune; state.valgsted = VALGSTED_ALL_VALUE;

        const existing = getSelectedIds();
        const nextCand = Array.from(new Set([...existing, candId]));
        state.pendingCandidateIds = [candId];
        persistUrl(true);
        const u=new URL(location.href);
        if(nextCand.length) u.searchParams.set("cand", nextCand.join("|")); else u.searchParams.delete("cand");
        history.replaceState({}, "", u);

        loadKommuneData(target.kommune);
        return;
      }
    }

    const sample = (state.rows||[]).find(r=>r.kandidat_id===candId);
    if(!sample || isListestemmer(sample.kandidat_navn)) return;
    if(state.selected.has(candId)){
      state.selected.delete(candId);
      renderAll(); persistUrl(false);
      return;
    }
    state.selected.set(candId, { kandidat_id:candId, kandidat_navn: sample.kandidat_navn, parti: sample.parti });
    renderAll(); persistUrl(false);
    document.getElementById('compareSection').scrollIntoView({behavior:'smooth', block:'start'});
  }

  function updateTopButtonsForScope(){
    const btnAll = el("btnAll");
    if(!btnAll) return;
    if(state.overviewMode==="party"){
      btnAll.textContent = "Alle partier";
    }else{
      btnAll.textContent = "Top 50";
    }
  }

  /* ===== PARTI-STATS & COMBOBOX ===== */
  function getPartyStats(){
    const byParti=new Map();
    const rows = getActiveRows();
    for(const r of rows){
      if(!byParti.has(r.parti)) byParti.set(r.parti,[]);
      byParti.get(r.parti).push(r);
    }
    const res=[];
    for(const [parti,rowsP] of byParti.entries()){
      const map=new Map();
      for(const r of rowsP){
        if(!map.has(r.kandidat_id))
          map.set(r.kandidat_id,{
            kandidat_id:r.kandidat_id,
            kandidat_navn:r.kandidat_navn,
            parti:r.parti,
            total:0
          });
        map.get(r.kandidat_id).total+=r.stemmer;
      }
      const kandidater=Array.from(map.values());
      const letter = detectPartyLetter(rowsP);
      res.push({
        parti,
        letter,
        hasLetter: !!letter,
        kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length,
        kandidater
      });
    }
    res.sort((a,b)=>{
      if(a.hasLetter!==b.hasLetter) return a.hasLetter?-1:1;
      if(a.hasLetter&&b.hasLetter) return a.letter.localeCompare(b.letter,"da");
      return a.parti.localeCompare(b.parti,"da");
    });
    return res;
  }

  function renderPartyCombobox(){
    if(!state.kommune){ resetPartyUI(); return; }

    const stats=getPartyStats(), btn=el("partyButton"), btnc=el("partyButtonContent"), menu=el("partyMenu");
    if(!stats.length){
      btn.disabled=true;
      btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Ingen partier fundet</span>`;
      menu.innerHTML="";
      return;
    }
    btn.disabled=false;

    function renderButton(){
      if(!state.activeParty){
        btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`;
        return;
      }
      const cur=stats.find(s=>s.parti===state.activeParty);
      const {style,text}=badge(cur?.letter||null);
      btnc.innerHTML=`<span class="vb-badge" style="${style}">${text}</span><span class="truncate">${escapeHtml(state.activeParty)}</span>`;
    }

    function renderMenu(){
      menu.innerHTML=stats.map(s=>{
        const {style,text}=badge(s.letter);
        const sel=s.parti===state.activeParty;
        return `<div class="vb-option" role="option" data-parti="${escapeHtml(s.parti)}" aria-selected="${sel}">
          <span class="vb-badge" style="${style}">${text}</span>
          <span class="flex-1">${escapeHtml(s.parti)}</span>
          <span class="text-xs text-gray-500">${s.kandidatAntal} kandidater</span>
        </div>`;
      }).join("");
      menu.querySelectorAll('.vb-option').forEach((opt,i)=>{
        opt.onclick=()=>{
          state.activeParty=opt.getAttribute('data-parti');
          renderButton(); closePartyMenu(); renderPartyDetail(state.activeParty);
          menu.querySelectorAll('.vb-option').forEach((x,j)=>x.setAttribute('aria-selected', j===i));
          persistUrl(false);
        };
      });
    }

    btn.onclick=()=>{
      const open=btn.getAttribute('aria-expanded')==='true';
      if(open) closePartyMenu(); else { renderMenu(); openPartyMenu(); }
    };
    function openPartyMenu(){ btn.setAttribute('aria-expanded','true'); menu.classList.remove('hidden'); menu.focus(); }
    function closePartyMenu(){ btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
    window.closePartyMenu=closePartyMenu;

    renderButton();
    el("partyDetailHeader").textContent = "Vælg et parti i drop-down menuen.";
    el("candidateColLeft").innerHTML = ""; el("candidateColRight").innerHTML = "";
  }

  function renderPartyDetail(parti){
    const header=el("partyDetailHeader"), left=el("candidateColLeft"), right=el("candidateColRight");
    left.innerHTML=""; right.innerHTML="";
    if(!parti){ header.textContent="Vælg et parti i drop-down menuen."; return; }
    header.textContent=parti;

    const kandidaterAll=getPartyStats().find(x=>x.parti===parti)?.kandidater||[];
    const sorted = kandidaterAll.slice().sort(
      state.candidateSortMode==='alpha' ? sortKandidaterAlpha : sortKandidaterVotes
    );

    const mid=Math.ceil(sorted.length/2), leftArr=sorted.slice(0,mid), rightArr=sorted.slice(mid);
    function card(k){
      const listestemmer=isListestemmer(k.kandidat_navn);
      const subtitle = listestemmer ? `${fmt(k.total)} listestemmer` : `${fmt(k.total)} stemmer i alt`;
      const meta = `${escapeHtml(k.parti)} · ${subtitle}`;
      const div=document.createElement('div');
      div.className='rounded-xl border px-3 py-2';
      const buttonHtml = listestemmer
        ? ''
        : `<button class="vb-btn" data-add="${k.kandidat_id}">Tilføj</button>`;
      div.innerHTML=`<div class="flex items-center justify-between">
        <div>
          <div class="font-medium">${escapeHtml(normalizeCandidateName(k.kandidat_navn))}</div>
          <div class="text-xs text-gray-500">${meta}</div>
        </div>
        ${buttonHtml}
      </div>`;
      if(!listestemmer){
        const btn = div.querySelector('button[data-add]');
        btn.onclick=()=>{
          state.selected.set(k.kandidat_id,{kandidat_id:k.kandidat_id,kandidat_navn:k.kandidat_navn,parti:k.parti});
          renderAll(); persistUrl(false);
        };
      }
      return div;
    }
    leftArr.forEach(k=>left.appendChild(card(k)));
    rightArr.forEach(k=>right.appendChild(card(k)));
  }

  /* ===== Parti-oversigts-dropdown (øverst) ===== */
  function updatePartyScopeSelect(){
    const sel = el("partyScopeSelect");
    if (!sel) return;

    const rows = state.rows || [];
    if (!rows.length) {
      sel.disabled = true;
      sel.innerHTML = '<option value="">Vælg parti…</option>';
      return;
    }

    const set = new Set();
    for (const r of rows) {
      if (r.parti) set.add(r.parti);
    }

    const partier = Array.from(set).sort(priorityPartySort);

    sel.disabled = false;
    sel.innerHTML =
      '<option value="">Vælg parti…</option>' +
      partier
        .map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`)
        .join("");
  }

  /* ===== Parti-sammenligning ===== */
  function getSelectedPartiesOrdered(){
    const arr = Array.from(state.selectedParties || []);
    arr.sort(priorityPartySort);
    return arr;
  }

  function renderPartyCompare(){
    const section = el("partyCompareSection");
    const listEl = el("partySelectedList");
    const thead = el("partyThead");
    const tbody = el("partyTbody");
    const tfoot = el("partyTFoot");
    const rows = state.rows || [];

    if (!section || !listEl || !thead || !tbody || !tfoot) return;

    const allSelected = getSelectedPartiesOrdered();
    const parties = allSelected.filter(p => rows.some(r => r.parti === p));

    if (!parties.length) {
      section.classList.add("hidden");
      listEl.innerHTML = '<div class="text-sm text-gray-500">Ingen partier valgt endnu.</div>';
      thead.innerHTML = "";
      tbody.innerHTML = "";
      tfoot.innerHTML = "";
      const btn = el("btnClearParties");
      if (btn) btn.disabled = true;
      return;
    }

    section.classList.remove("hidden");
    const btn = el("btnClearParties");
    if (btn) btn.disabled = false;

    listEl.innerHTML = parties.map(p => {
      const rowsForParti = rows.filter(r => r.parti === p);
      const letter = detectPartyLetter(rowsForParti);
      const bd = badge(letter);
      const total = rowsForParti.reduce((sum, r) => sum + (r.stemmer || 0), 0);
      return `<div class="rounded-xl border p-2 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
          <span class="font-medium">${escapeHtml(p)}</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-sm tabular-nums">${fmt(total)} stemmer i alt</span>
          <button class="vb-btn" data-party="${escapeHtml(p)}">Fjern</button>
        </div>
      </div>`;
    }).join("");

    listEl.querySelectorAll('button[data-party]').forEach(btnEl => {
      const partyName = btnEl.getAttribute('data-party');
      btnEl.addEventListener('click', () => {
        state.selectedParties.delete(partyName);
        renderPartyCompare();
        persistUrl(false);
      });
    });

    renderPartyHierarchyTable(parties, thead, tbody, tfoot, rows);
  }

  function renderPartyHierarchyTable(parties, thead, tbody, tfoot, rows){
    if (!rows.length || !parties.length) {
      thead.innerHTML = "";
      tbody.innerHTML = "";
      tfoot.innerHTML = "";
      return;
    }

    // Map: parti -> bogstav -> farve
    const partyLetters = new Map();
    const partyColors  = new Map();
    parties.forEach(p => {
      const rowsForParti = rows.filter(r => r.parti === p);
      const letter = detectPartyLetter(rowsForParti);
      partyLetters.set(p, letter);
      const col = letter && PARTY_COLORS[letter] ? PARTY_COLORS[letter] : "#9ca3af";
      partyColors.set(p, col);
    });

    const regionMap = new Map();
    const totalPerParty = new Map();

    // Byg hierarkiet – regn totalAll = alle gyldige stemmer i rækken
    for (const r of rows) {
      const regionName = r.region || findRegionForKommune(r.kommune) || "(Ukendt region)";
      const kommuneName = r.kommune || "(Ukendt kommune)";
      const valgstedKey = r.valgsted_id || r.valgsted_navn || "";
      const valgstedLabel = formatValgstedNameForDisplay(r.valgsted_navn || valgstedKey || "(Ukendt valgsted)");
      const stem = r.stemmer || 0;

      let reg = regionMap.get(regionName);
      if (!reg) {
        reg = { name: regionName, totals:new Map(), totalAll:0, kommuner:new Map() };
        regionMap.set(regionName, reg);
      }
      reg.totalAll += stem;
      if (parties.includes(r.parti)) {
        reg.totals.set(r.parti, (reg.totals.get(r.parti)||0)+stem);
      }

      let kom = reg.kommuner.get(kommuneName);
      if (!kom) {
        kom = { name: kommuneName, totals:new Map(), totalAll:0, valgsteder:new Map() };
        reg.kommuner.set(kommuneName, kom);
      }
      kom.totalAll += stem;
      if (parties.includes(r.parti)) {
        kom.totals.set(r.parti, (kom.totals.get(r.parti)||0)+stem);
      }

      let vs = kom.valgsteder.get(valgstedKey);
      if (!vs) {
        vs = { key: valgstedKey, name: valgstedLabel, totals:new Map(), totalAll:0 };
        kom.valgsteder.set(valgstedKey, vs);
      }
      vs.totalAll += stem;
      if (parties.includes(r.parti)) {
        vs.totals.set(r.parti, (vs.totals.get(r.parti)||0)+stem);
      }

      if (parties.includes(r.parti)) {
        totalPerParty.set(r.parti, (totalPerParty.get(r.parti)||0)+stem);
      }
    }

    const regions = Array.from(regionMap.values())
      .sort((a, b) => a.name.localeCompare(b.name, "da"));

    const headCols = parties.map(p => {
      const letter = partyLetters.get(p);
      const bd = badge(letter);
      return `<th class="py-2 pr-3 text-right">
        <div class="flex items-center justify-end gap-2">
          <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
          <span class="text-right">${escapeHtml(p)}</span>
        </div>
      </th>`;
    }).join("");

    thead.innerHTML = `<tr class="text-left border-b">
      <th class="py-2 pr-3">Region / kommune / valgsted</th>
      ${headCols}
    </tr>`;

    const rowsHtml = [];

    function partyCellHtml(n, totalAll, p){
      const total = totalAll || 0;
      const share = total > 0 ? n / total : 0;
      const pct = share * 100;
      const pctLabel = total > 0 ? fmtPct(share) : "";
      const color = partyColors.get(p) || "#9ca3af";
      if (total === 0 && n === 0) {
        return `<td class="py-2 pr-3 text-right tabular-nums cell-na">0</td>`;
      }
      return `<td class="py-2 pr-3 text-right tabular-nums">
        <div>${fmt(n)}${pctLabel ? `<span class="text-[11px] text-gray-500 ml-1">${pctLabel}</span>` : ""}</div>
        <div class="mini-bar-wrap"><div class="mini-bar-fill" style="width:${pct}%; background:${color};"></div></div>
      </td>`;
    }

    regions.forEach(reg => {
      const regionKey = `region:${reg.name}`;
      const hasKommuner = reg.kommuner.size > 0;

      const regCells = parties.map(p => {
        const n = reg.totals.get(p) || 0;
        return partyCellHtml(n, reg.totalAll, p);
      }).join("");

      rowsHtml.push(`
        <tr class="border-b" data-key="${escapeHtml(regionKey)}" data-parent="" data-level="region" data-expanded="false">
          <td class="py-2 pr-3 font-medium">
            <div class="flex items-center">
              ${hasKommuner ? `<button type="button" class="hier-toggle toggle-row" data-target="${escapeHtml(regionKey)}">▸</button>` : `<span class="hier-toggle"></span>`}
              <span>${escapeHtml(reg.name)}</span>
            </div>
          </td>
          ${regCells}
        </tr>
      `);

      const kommuner = Array.from(reg.kommuner.values())
        .sort((a, b) => a.name.localeCompare(b.name, "da"));

      kommuner.forEach(kom => {
        const kommuneKey = `kommune:${reg.name}:${kom.name}`;
        const hasValgsteder = kom.valgsteder.size > 0;

        const komCells = parties.map(p => {
          const n = kom.totals.get(p) || 0;
          return partyCellHtml(n, kom.totalAll, p);
        }).join("");

        rowsHtml.push(`
          <tr class="border-b hidden" data-key="${escapeHtml(kommuneKey)}" data-parent="${escapeHtml(regionKey)}" data-level="kommune" data-expanded="false">
            <td class="py-2 pr-3 font-medium">
              <div class="flex items-center hier-indent-1">
                ${hasValgsteder ? `<button type="button" class="hier-toggle toggle-row" data-target="${escapeHtml(kommuneKey)}">▸</button>` : `<span class="hier-toggle"></span>`}
                <span>${escapeHtml(kom.name)}</span>
              </div>
            </td>
            ${komCells}
          </tr>
        `);

        const valgsteder = Array.from(kom.valgsteder.values())
          .sort((a, b) => a.name.localeCompare(b.name, "da"));

        valgsteder.forEach(vs => {
          const vsKey = `valgsted:${reg.name}:${kom.name}:${vs.key}`;

          const vsCells = parties.map(p => {
            const n = vs.totals.get(p) || 0;
            return partyCellHtml(n, vs.totalAll, p);
          }).join("");

          rowsHtml.push(`
            <tr class="border-b hidden" data-key="${escapeHtml(vsKey)}" data-parent="${escapeHtml(kommuneKey)}" data-level="valgsted">
              <td class="py-2 pr-3">
                <div class="flex items-center hier-indent-2">
                  <span class="hier-toggle"></span>
                  <span>${escapeHtml(vs.name)}</span>
                </div>
              </td>
              ${vsCells}
            </tr>
          `);
        });
      });
    });

    tbody.innerHTML = rowsHtml.join("");

    const totalCells = parties.map(p => {
      const n = totalPerParty.get(p) || 0;
      return `<td class="py-2 pr-3 text-right tabular-nums font-medium">${fmt(n)}</td>`;
    }).join("");

    tfoot.innerHTML = `<tr class="border-t">
      <th class="py-2 pr-3 text-left">Total (valgte partier)</th>
      ${totalCells}
    </tr>`;

    const toggleButtons = tbody.querySelectorAll('.toggle-row');
    toggleButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-target');
        const selectorKey = key.replace(/"/g, '\\"');
        const row = tbody.querySelector('tr[data-key="'+selectorKey+'"]');
        if (!row) return;
        const isExpanded = row.getAttribute('data-expanded') === 'true';

        if (!isExpanded) {
          row.setAttribute('data-expanded', 'true');
          btn.textContent = '▾';
          const children = tbody.querySelectorAll('tr[data-parent="'+selectorKey+'"]');
          children.forEach(ch => ch.classList.remove('hidden'));
        } else {
          row.setAttribute('data-expanded', 'false');
          btn.textContent = '▸';
          collapseDescendants(selectorKey);
        }
      });
    });

    function collapseDescendants(parentKey){
      const children = tbody.querySelectorAll('tr[data-parent="'+parentKey.replace(/"/g,'\\"')+'"]');
      children.forEach(ch => {
        const chKey = ch.getAttribute('data-key');
        ch.classList.add('hidden');
        ch.setAttribute('data-expanded','false');
        const toggle = ch.querySelector('.toggle-row');
        if (toggle) toggle.textContent = '▸';
        collapseDescendants(chKey);
      });
    }
  }

  /* ===== SAMLET RENDER (kandidater) ===== */
  function renderAll(){
    for (const [id, sel] of Array.from(state.selected.entries())){
      if(isListestemmer(sel.kandidat_navn)) state.selected.delete(id);
    }

    renderSelected();
    renderPsTable(getPollingStations(), getSelectedOrdered());
    const hasSel=getSelected().length>0;
    el("compareSection").classList.toggle("hidden",!hasSel);
    el("tabsCard").classList.toggle("hidden",!hasSel);
  }
  function computeTotalsByCandidate(){
    const m=new Map();
    const rows = getActiveRows();
    for(const r of rows) m.set(r.kandidat_id,(m.get(r.kandidat_id)||0)+r.stemmer);
    return m;
  }
  function stemmerLabel(n){ return n===1 ? 'stemme' : 'stemmer'; }
  function renderSelected(){
    const root=el("selectedList"), totals=computeTotalsByCandidate(), sel=getSelectedOrdered();
    function letterForParti(parti){
      const stat=getPartyStats().find(s=>s.parti===parti);
      return stat?.letter||null;
    }
    root.innerHTML= sel.map(k=>{
      const letter=letterForParti(k.parti), bd=badge(letter), total=totals.get(k.kandidat_id)||0;
      const listestemmer=isListestemmer(k.kandidat_navn);
      const totalTekst=listestemmer
        ? `${fmt(total)} ${total===1?'listestemme':'listestemmer'}`
        : `${fmt(total)} personlige ${stemmerLabel(total)} i alt`;
      return `<div class="rounded-xl border p-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
          <div class="font-medium">${escapeHtml(normalizeCandidateName(k.kandidat_navn))} <span class="text-gray-500">(${escapeHtml(k.parti)})</span></div>
        </div>
        <div class="flex items-center gap-3">
          <div class="tabular-nums font-medium">${totalTekst}</div>
          <button class="vb-btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
        </div>
      </div>`;
    }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;
    el("btnClearAll").disabled = sel.length===0;
  }
  window.removeCandidate = id => { state.selected.delete(id); renderAll(); persistUrl(false); };
  const getSelected = () => Array.from(state.selected.values()).filter(k=>!isListestemmer(k.kandidat_navn));
  const getSelectedOrdered = () => { const s=getSelected().slice(); s.sort(sortKandidaterAlpha); return s; };

  function getPollingStations(){
    const m=new Map();
    const rows = getActiveRows();
    for(const r of rows){
      const key = `${r.kommune}::${r.valgsted_id}`;
      if(!m.has(key)) m.set(key,{id:key,navn:r.valgsted_navn,kommune:r.kommune});
      const ps=m.get(key);
      ps[r.kandidat_id]=(ps[r.kandidat_id]||0)+r.stemmer;
    }
    return Array.from(m.values()).sort((a,b)=>a.navn.localeCompare(b.navn,'da'));
  }
  function renderPsTable(psList, sel){
    const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
    if(!sel.length){
      thead.innerHTML=`<tr><th class="text-left py-2 pr-3">Valgsted</th></tr>`;
      tbody.innerHTML=""; tfoot.innerHTML=""; return;
    }
    const header = sel.map(s=>{
      const stat= state.kommune ? getPartyStats().find(x=>x.parti===s.parti) : null;
      const bd = badge(stat?.letter || null);
      return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
        <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
        <span>${escapeHtml(normalizeCandidateName(s.kandidat_navn))} (${escapeHtml(s.parti)})</span></div></th>`;
    }).join("");
    thead.innerHTML=`<tr class="text-left border-b"><th class="py-2 pr-3">Valgsted</th>${header}</tr>`;

    tbody.innerHTML=psList.map(ps=>`<tr class="border-b last:border-0">
      <td class="py-2 pr-3 font-medium">${escapeHtml(formatValgstedNameForDisplay(ps.navn))}</td>
      ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums">${fmt(ps[s.kandidat_id]||0)}</td>`).join("")}
    </tr>`).join("");

    const totals=computeTotalsByCandidate();
    let label = 'Total';
    if(state.kommune){
      if(state.valgsted && state.valgsted !== VALGSTED_ALL_VALUE) label = 'Valgsted total';
      else label = 'Kommunetotal';
    }
    tfoot.innerHTML=`<tr class="border-t"><th class="py-2 pr-3 text-left">${label}</th>
      ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("")}
    </tr>`;
  }

  /* ===== BRODKRUMMER ===== */
  function renderContextBar(){
    const bar = document.getElementById('contextBar');
    const parts = [];
    const hasRegion = !!state.region;
    const hasKommune = !!state.kommune;
    const hasValgsted = !!state.kommune && !!state.valgsted && state.valgsted !== VALGSTED_ALL_VALUE && !!getCurrentValgstedName();

    parts.push(!hasRegion ? `<span class="crumb-strong">Danmark</span>` : `<span class="crumb" data-nav="dk">Danmark</span>`);
    if(state.region){
      parts.push(`<span class="sep">/</span>`);
      const regionIsActive = state.region && !state.kommune;
      parts.push(regionIsActive ? `<span class="crumb-strong">${escapeHtml(state.region)}</span>` : `<span class="crumb" data-nav="region">${escapeHtml(state.region)}</span>`);
      if(state.kommune){
        parts.push(`<span class="sep">/</span>`);
        if(hasValgsted){
          parts.push(`<span class="crumb" data-nav="kommune">${escapeHtml(state.kommune)}</span>`);
          parts.push(`<span class="sep">/</span>`);
          const vName = getCurrentValgstedName() || "Valgsted";
          parts.push(`<span class="crumb-strong">${escapeHtml(vName)}</span>`);
        } else {
          parts.push(`<span class="crumb-strong">${escapeHtml(state.kommune)}</span>`);
        }
      }
    }
    bar.innerHTML = parts.join("");
    bar.querySelector('[data-nav="dk"]')?.addEventListener('click', ()=>{
      el('regionSelect').value='';
      el('kommuneSelect').innerHTML='<option value="">Vælg kommune…</option>';
      el('kommuneSelect').disabled=true;
      const vsel = el('valgstedSelect');
      if(vsel){
        vsel.disabled=true;
        vsel.innerHTML='<option value="">(Vælg kommune for at vælge valgsted)</option>';
      }
      state.region=''; state.kommune=''; state.valgsted='';
      clearAll(); persistUrl(true); loadNationalData();
    });
    bar.querySelector('[data-nav="region"]')?.addEventListener('click', ()=>{
      el('kommuneSelect').value='';
      const vsel = el('valgstedSelect');
      if(vsel){
        vsel.disabled=true;
        vsel.innerHTML='<option value="">(Vælg kommune for at vælge valgsted)</option>';
      }
      state.kommune=''; state.valgsted='';
      clearAll(); persistUrl(true); loadRegionData(state.region);
    });
    bar.querySelector('[data-nav="kommune"]')?.addEventListener('click', ()=>{
      state.valgsted = VALGSTED_ALL_VALUE;
      const vsel = el('valgstedSelect');
      if(vsel){
        vsel.value = VALGSTED_ALL_VALUE;
      }
      renderOverview();
      renderAll();
      renderContextBar();
      persistUrl(true);
    });
  }

  function closePartyMenu(){
    const btn=el('partyButton'), menu=el('partyMenu');
    btn?.setAttribute('aria-expanded','false');
    menu?.classList.add('hidden');
  }
</script>
</body>
</html>
