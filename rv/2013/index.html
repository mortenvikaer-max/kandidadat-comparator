<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valgbar – Regionsrådsvalg 2013</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --vb-navy:#234a5a; --vb-navy-2:#1b3d4d; }
    .vb-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .vb-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
    .vb-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .vb-tabbox{ flex:1 1 auto; border:1px solid #e5e7eb; border-radius:12px; padding:.6rem 1rem; text-align:center; cursor:pointer; user-select:none; background:#fff; }
    .vb-tabbox.active{ background:#111827; color:#fff; border-color:#111827; }
    .vb-tabbox.small{ flex:0 0 auto; padding:.4rem .8rem; font-size:.9rem; }

    .vb-combo-btn{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .75rem; background:#fff;
                   display:flex; align-items:center; justify-content:space-between; }
    .vb-combo-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .vb-combo-label{ display:flex; align-items:center; gap:.75rem; min-width:0; }
    .vb-badge{ height:28px; width:28px; display:inline-flex; align-items:center; justify-content:center;
               border-radius:9999px; border:1px solid transparent; font-weight:600; font-size:.9rem; }

    .vb-menu{ position:absolute; z-index:50; margin-top:.25rem; width:max-content; min-width:16rem;
              max-height:18rem; overflow:auto; background:#fff; border:1px solid #e5e7eb;
              border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .vb-option{ display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; cursor:pointer; }
    .vb-option span{ white-space:normal; word-break:break-word; }
    .vb-option:hover, .vb-option[aria-selected="true"]{ background:#f3f4f6; }

    .table-sticky thead th:first-child, .table-sticky tbody td:first-child, .table-sticky tfoot th:first-child{
      position:sticky; left:0; background:#fff;
    }
    .vb-hero{ background:linear-gradient(180deg, var(--vb-navy) 0%, var(--vb-navy-2) 100%); color:#fff; }

    .rank-pill{ width:28px; height:28px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center;
                font-weight:700; border:1px solid #e5e7eb; background:#f9fafb; }
    .top10-item{ display:flex; align-items:center; gap:.75rem; padding:.6rem .7rem; border:1px solid #e5e7eb; border-radius:12px; cursor:pointer; }
    .top10-item:hover{ background:#f9fafb; }
    .top10-grid{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media (min-width:768px){ .top10-grid{ grid-template-columns:1fr 1fr; } }

    .context-bar{ display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; }
    .crumb{ color:#374151; text-decoration:underline; cursor:pointer; }
    .crumb-strong{ background:#111827; color:#fff; border-radius:9999px; padding:.15rem .6rem; font-weight:600; }
    .sep{ color:#9ca3af; }

    /* Loader */
    .loader-wrap{ display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#6b7280; }
    .progress{ position:relative; height:6px; background:#f3f4f6; border-radius:9999px; overflow:hidden; }
    .progress::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, rgba(0,0,0,0) 0%, #c7d2fe 50%, rgba(0,0,0,0) 100%);
      animation:loadbar 1.2s infinite;
    }
    @keyframes loadbar{
      0%{ transform:translateX(-100%); }
      50%{ transform:translateX(0%); }
      100%{ transform:translateX(100%); }
    }

    /* Modal */
    .vb-modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:100; }
    .vb-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:101; }
    .vb-modal.open, .vb-modal-backdrop.open{ display:flex; }
    .vb-modal-card{ width:100%; max-width:820px; max-height:80vh; overflow:auto; background:#fff; border-radius:16px; border:1px solid #e5e7eb; box-shadow:0 24px 60px rgba(0,0,0,.25); }
    .accordion-body{ display:none; }
    .accordion.open .accordion-body{ display:block; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
<header class="vb-hero">
  <div class="mx-auto max-w-6xl px-4 py-6 flex items-center gap-4">
    <a href="../../" class="flex items-center gap-3">
      <img src="../../Valgbar-transparent3.png" alt="Valgbar" class="h-32 w-auto" />
    </a>
  </div>

  <div class="mx-auto max-w-6xl px-4 pb-1">
    <div class="text-white/90 text-base md:text-lg">Vælg en region og/eller kommune – og få overblik over partier og kandidater.</div>
    <div id="error" class="mt-2 text-sm text-red-200"></div>
  </div>

  <!-- Site-breadcrumb: Forside / Regionsrådsvalg / 2013 -->
  <nav aria-label="Brødkrumme" class="mx-auto max-w-6xl px-4 pb-4">
    <ol class="flex items-center gap-2 text-sm">
      <li><a href="../../" class="underline text-white">Forside</a></li>
      <li class="opacity-70">/</li>
      <!-- Justér linket herunder, hvis din mappe­struktur er anderledes -->
      <li><a href="../" class="underline text-white">Regionsrådsvalg</a></li>
      <li class="opacity-70">/</li>
      <li><span aria-current="page" class="font-semibold text-white">2013</span></li>
    </ol>
  </nav>
</header>

<main class="mx-auto max-w-6xl p-4 space-y-6">
  <div id="contextBar" class="context-bar"></div>

  <!-- LANDING -->
  <section id="landing" class="vb-card p-4 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 md:items-end gap-3">
      <!-- Søg kandidat -->
      <div class="relative">
        <label class="text-sm text-gray-600">Søg kandidat</label>
        <input id="candidateSearch" type="text" class="w-full mt-1 rounded-xl border p-2" placeholder="Indtast kandidatnavn…" autocomplete="off" />
        <div id="candidateMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="candidateSearch" style="max-width:36rem"></div>
      </div>

      <!-- Søg kommune -->
      <div>
        <label class="text-sm text-gray-600">Søg kommune</label>
        <input id="kommuneSearch" type="text" class="w-full mt-1 rounded-xl border p-2" placeholder="Start med at skrive fx Aarhus, Odense, København…" />
      </div>

      <!-- Region -->
      <div>
        <label class="text-sm text-gray-600">Region</label>
        <select id="regionSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900"></select>
      </div>

      <!-- Kommune -->
      <div>
        <label class="text-sm text-gray-600">Kommune</label>
        <select id="kommuneSelect" class="w-full mt-1 rounded-xl border p-2 text-gray-900" disabled></select>
      </div>
    </div>

    <p class="text-sm text-gray-600">Klik på en kandidat for at se stemmer opdelt på kommuner – og fold valgsteder ud efter behov.</p>
  </section>

  <!-- TOP 10/50 -->
  <section id="overviewTop" class="vb-card p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 id="top10Title" class="font-semibold">Top 10 kandidater (personlige stemmer)</h2>
      <div class="flex items-center gap-3">
        <div id="top10Scope" class="text-sm text-gray-500"></div>
        <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
          <button id="btnTop10" class="vb-tabbox small active" type="button">Top 10</button>
          <button id="btnAll" class="vb-tabbox small" type="button">Top 50</button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader-wrap hidden" aria-live="polite">
      <div class="progress w-48 rounded-full"></div>
      <span>Indlæser…</span>
    </div>

    <div id="top10List" class="top10-grid mt-2">
      <ol id="top10ColLeft" class="space-y-2"></ol>
      <ol id="top10ColRight" class="space-y-2"></ol>
    </div>
  </section>

  <!-- PARTIER OG KANDIDATER -->
  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Partier og kandidater</h2>
      <div id="kommunetitel" class="text-gray-500"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <aside class="md:col-span-1 vb-card p-4 space-y-2">
        <label class="text-sm font-medium">Vælg parti</label>
        <div id="partyCombo" class="relative">
          <button id="partyButton" type="button" class="vb-combo-btn" aria-haspopup="listbox" aria-expanded="false" disabled>
            <span id="partyButtonContent" class="vb-combo-label">
              <span class="vb-badge" style="background:#e5e7eb; color:#111827; border-color:#e5e7eb"> </span>
              <span class="truncate text-gray-500">Vælg kommune først…</span>
            </span>
            <svg class="h-4 w-4 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.104l3.71-3.873a.75.75 0 011.08 1.04l-4.24 4.43a.75.75 0 01-1.08 0l-4.24-4.43a.75.75 0 01.02-1.06z"/></svg>
          </button>
          <div id="partyMenu" class="vb-menu hidden" role="listbox" tabindex="-1" aria-labelledby="partyButton"></div>
        </div>
      </aside>

      <section class="md:col-span-2 vb-card p-4 space-y-3" id="partyDetail">
        <div class="flex items-center justify-between gap-3">
          <div id="partyDetailHeader" class="text-gray-500 text-sm">Vælg en kommune for at se partier.</div>
          <div class="rounded-2xl border bg-white p-1 shadow-sm flex gap-2">
            <button id="btnSortAlpha" class="vb-tabbox small active" type="button" title="Alfabetisk">A–Å</button>
            <button id="btnSortVotes" class="vb-tabbox small" type="button" title="Flest stemmer">Flest stemmer</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div id="candidateColLeft" class="space-y-2"></div>
          <div id="candidateColRight" class="space-y-2"></div>
        </div>
      </section>
    </div>
  </section>

  <!-- SAMMENLIGNING -->
  <section id="compareSection" class="vb-card p-4 space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="font-medium">Sammenligning af kandidater</h2>
      <button id="btnClearAll" class="vb-btn">Nulstil alle valgte kandidater</button>
    </div>
    <div id="selectedList" class="space-y-2"></div>
  </section>

  <!-- KUN TABEL -->
  <section id="tabsCard" class="vb-card p-4 space-y-4 hidden">
    <div class="text-sm text-gray-600">Tabel pr. valgsted</div>
    <div class="overflow-auto">
      <table class="table-sticky w-full text-sm min-w-[720px]" id="psTable">
        <thead id="psThead"></thead>
        <tbody id="psTbody"></tbody>
        <tfoot id="psTFoot"></tfoot>
      </table>
    </div>
  </section>
</main>

<!-- MODAL (centered) -->
<div id="modalBackdrop" class="vb-modal-backdrop"></div>
<div id="candidateModal" class="vb-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="vb-modal-card">
    <div class="p-4 border-b flex items-center justify-between">
      <div>
        <div id="modalTitle" class="font-semibold"></div>
        <div id="modalSub" class="text-sm text-gray-500"></div>
      </div>
      <button id="modalClose" class="vb-btn">Luk</button>
    </div>
    <div class="p-4 space-y-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Stemmer i alt</label>
        <div id="modalTotal" class="w-full rounded-xl border p-2 bg-gray-50 tabular-nums font-medium"></div>
      </div>
      <div class="space-y-2">
        <div class="text-sm text-gray-600">Stemmetal pr. kommune (klik “Se valgsteder” for at folde ud)</div>
        <div id="modalKommuneList" class="space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ===== DATA-STI (Regionsrådsvalg 2013) ===== */
  const BASE_PATH = '../../data/rv/2013/';

  /* “Alle kommuner i regionen” – syntetisk kommune-værdi */
  const ALL_IN_REGION = "__ALL_REGION__";

  /* Regioner & kommuner (uændret) */
  const REGIONS = {
    "Region Hovedstaden": ["Albertslund","Allerød","Ballerup","Bornholm","Brøndby","Dragør","Egedal","Fredensborg","Frederiksberg","Frederikssund","Furesø","Gentofte","Gladsaxe","Glostrup","Gribskov","Halsnæs","Herlev","Hillerød","Hvidovre","Høje-Taastrup","Hørsholm","Ishøj","København","Lyngby-Taarbæk","Rudersdal","Rødovre","Tårnby","Vallensbæk"],
    "Region Sjælland": ["Faxe","Greve","Guldborgsund","Holbæk","Kalundborg","Køge","Lejre","Lolland","Næstved","Odsherred","Ringsted","Roskilde","Slagelse","Solrød","Sorø","Stevns","Vordingborg"],
    "Region Syddanmark": ["Assens","Billund","Esbjerg","Fanø","Fredericia","Faaborg-Midtfyn","Haderslev","Kerteminde","Kolding","Langeland","Middelfart","Nordfyns","Nyborg","Odense","Svendborg","Tønder","Varde","Vejen","Vejle","Ærø","Aabenraa","Sønderborg"],
    "Region Midtjylland": ["Favrskov","Hedensted","Herning","Holstebro","Horsens","Ikast-Brande","Lemvig","Norddjurs","Odder","Randers","Ringkøbing-Skjern","Samsø","Silkeborg","Skanderborg","Skive","Struer","Syddjurs","Viborg","Aarhus"],
    "Region Nordjylland": ["Brønderslev","Frederikshavn","Hjørring","Jammerbugt","Læsø","Mariagerfjord","Morsø","Rebild","Thisted","Vesthimmerlands","Aalborg"]
  };

  /* Partifarver + mapping af bogstav efter partinavn */
  const PARTY_COLORS = { "A":"#e03a3e","B":"#712082","C":"#2e7d32","F":"#e5003d","I":"#00a0e3","O":"#0044aa","S":"#666666","V":"#1b5eaa","Ø":"#c8102e" };
  const DEFAULT_BADGE_BG = "#e5e7eb"; const DEFAULT_BADGE_FG = "#111827";

  const PARTY_LETTERS_BY_NAME = new Map([
    ["socialdemokratiet","A"],["radikale venstre","B"],["det konservative folkeparti","C"],["konservative","C"],
    ["sf – socialistisk folkeparti","F"],["sf socialistisk folkeparti","F"],["sf","F"],["liberal alliance","I"],
    ["dansk folkeparti","O"],["slesvigsk parti","S"],["venstre, danmarks liberale parti","V"],["venstre","V"],["enhedslisten","Ø"]
  ]);

  /* State & helpers */
  const state = {
    rows:[], region:"", kommune:"", activeParty:"",
    selected:new Map(),
    candidateSortMode:"alpha", // alpha | votes
    topListMode:"top10",       // top10 | all
    csvCache:new Map(), isLoading:false,
    pendingCandidateIds:[],
    modalCache:new Map(), // kommune -> valgsteder rows for current candidate
  };
  const el = id => document.getElementById(id);
  const fmt = n => new Intl.NumberFormat("da-DK").format(n);
  const canon = s => (s||"").toString().trim();
  const escapeHtml = s => (s||"").replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const isListestemmer = name => { const t=(canon(name)).toLowerCase(); return t==="partiliste"||t==="listestemmer"||t==="liste"; };
  const fold = (s) => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
  const normalizeCandidateName = (name) => (name||"").replace(/,(\S)/g, ', $1');

  function badge(letter){
    const bg = letter && PARTY_COLORS[letter] ? PARTY_COLORS[letter] : DEFAULT_BADGE_BG;
    const fg = letter && PARTY_COLORS[letter] ? "#fff" : DEFAULT_BADGE_FG;
    return { style:`background-color:${bg};color:${fg};border-color:${bg}`, text:(letter||" ") };
  }
  function detectPartyLetter(rowsForParti){
    for(const r of rowsForParti){
      const nameKey = fold(r.parti||""); const fixed = PARTY_LETTERS_BY_NAME.get(nameKey);
      if(fixed) return fixed;
    }
    for(const r of rowsForParti){
      const m=(r.parti_bogstav||r.listebogstav||r.kandidat_id||"").toString().trim().toUpperCase().match(/^([A-ZÆØÅ])/);
      const L=m?.[1]; if(L && PARTY_COLORS[L]) return L;
    }
    return null;
  }
  function findRegionForKommune(kommune){
    for(const [reg, kommuner] of Object.entries(REGIONS)){ if(kommuner.includes(kommune)) return reg; }
    return "";
  }

  /* ===== URL helpers ===== */
  function getSelectedIds(){ return Array.from(state.selected.keys()); }
  function setSelectedFromIds(idArr){ state.pendingCandidateIds = (idArr||[]).filter(Boolean); }

  function persistUrl(push=false){
    const u=new URL(location.href);
    if(state.region) u.searchParams.set("region", state.region); else u.searchParams.delete("region");
    if(state.kommune) u.searchParams.set("kommune", state.kommune); else u.searchParams.delete("kommune");
    if(state.activeParty) u.searchParams.set("parti", state.activeParty); else u.searchParams.delete("parti");
    const candList = getSelectedIds(); if(candList.length) u.searchParams.set("cand", candList.join(",")); else u.searchParams.delete("cand");
    if(state.topListMode !== "top10") u.searchParams.set("view", "top50"); else u.searchParams.delete("view");
    if(state.candidateSortMode !== "alpha") u.searchParams.set("sort", "votes"); else u.searchParams.delete("sort");
    if(push) history.pushState({}, "", u); else history.replaceState({}, "", u);
  }

  async function hydrateFromUrl(){
    const p=new URLSearchParams(location.search);
    const r=p.get("region"); const k=p.get("kommune"); const parti=p.get("parti");
    const cand=(p.get("cand")||"").split(",").map(s=>s.trim()).filter(Boolean);
    const view=p.get("view"); const sort=p.get("sort");

    state.topListMode = (view === "top50") ? "all" : "top10";
    state.candidateSortMode = (sort === "votes") ? "votes" : "alpha";
    updateTopToggleUI(); updateCandSortToggleUI();

    if(r && REGIONS[r]){
      el("regionSelect").value=r; populateKommuner(r); state.region=r;
      if (k === ALL_IN_REGION) { el("kommuneSelect").value = ALL_IN_REGION; state.kommune = ALL_IN_REGION; await loadRegionData(r); }
      else if (k && REGIONS[r].includes(k)) { el("kommuneSelect").value=k; state.kommune=k; await loadKommuneData(k); }
      else { el("kommuneSelect").value=""; state.kommune=""; await loadRegionData(r); }
    }else{
      el("regionSelect").value=""; el("kommuneSelect").innerHTML='<option value="">Vælg kommune…</option>'; el("kommuneSelect").disabled=true;
      state.region=""; state.kommune=""; await loadNationalData();
    }

    if(state.kommune && parti){
      const stats = getPartyStats();
      if(stats.some(s=>s.parti===parti)){ state.activeParty = parti; renderPartyCombobox(); renderPartyDetail(parti); }
      else { state.activeParty = ""; renderPartyCombobox(); }
    }else{ state.activeParty=""; renderPartyCombobox(); }

    setSelectedFromIds(cand);
    applyPendingSelections();

    renderOverview();
    renderAll();
    renderContextBar();
  }

  /* INIT */
  window.addEventListener("DOMContentLoaded", async ()=>{
    renderLanding(); initRegionDropdown();

    el("btnSortAlpha").addEventListener("click", ()=>{ if(state.candidateSortMode!=="alpha"){ state.candidateSortMode="alpha"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); persistUrl(true); } });
    el("btnSortVotes").addEventListener("click", ()=>{ if(state.candidateSortMode!=="votes"){ state.candidateSortMode="votes"; updateCandSortToggleUI(); if(state.activeParty) renderPartyDetail(state.activeParty); persistUrl(true); } });

    el("btnTop10").addEventListener("click", ()=>{ if(state.topListMode!=="top10"){ state.topListMode="top10"; updateTopToggleUI(); renderOverview(); persistUrl(true); } });
    el("btnAll").addEventListener("click", ()=>{ if(state.topListMode!=="all"){ state.topListMode="all"; updateTopToggleUI(); renderOverview(); persistUrl(true); } });

    await hydrateFromUrl();

    el("btnClearAll").onclick=()=>{ state.selected.clear(); renderAll(); persistUrl(false); };
    document.addEventListener('click',(e)=>{ const box=el('partyCombo'); if(box && !box.contains(e.target)) closePartyMenu(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePartyMenu(); });

    // Modal close handlers
    el('modalClose').addEventListener('click', closeCandidateModal);
    el('modalBackdrop').addEventListener('click', closeCandidateModal);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeCandidateModal(); });

    renderContextBar();
    window.addEventListener('popstate', ()=>{ hydrateFromUrl(); });
  });

  function updateCandSortToggleUI(){
    const a=el("btnSortAlpha"), b=el("btnSortVotes");
    if(state.candidateSortMode==="alpha"){ a.classList.add("active"); b.classList.remove("active"); }
    else { b.classList.add("active"); a.classList.remove("active"); }
  }
  function updateTopToggleUI(){
    const a=el("btnTop10"), b=el("btnAll");
    if(state.topListMode==="top10"){ a.classList.add("active"); b.classList.remove("active"); }
    else { b.classList.add("active"); a.classList.remove("active"); }
  }

  /* Loader */
  function showLoading(){
    state.isLoading = true;
    el('loader')?.classList.remove('hidden');
    el('overviewTop')?.setAttribute('aria-busy','true');
    el('regionSelect')?.setAttribute('disabled','');
    el('kommuneSelect')?.setAttribute('disabled','');
  }
  function hideLoading(){
    state.isLoading = false;
    el('loader')?.classList.add('hidden');
    el('overviewTop')?.removeAttribute('aria-busy');
    if (state.region) el('kommuneSelect')?.removeAttribute('disabled'); else el('kommuneSelect')?.setAttribute('disabled','');
    el('regionSelect')?.removeAttribute('disabled');
  }

  /* Kandidatsøgning (landing) */
  function buildCandidateList(rows){
    const m = new Map();
    for(const r of rows){
      if(isListestemmer(r.kandidat_navn)) continue;
      if(!m.has(r.kandidat_id)){
        m.set(r.kandidat_id, { kandidat_id:r.kandidat_id, kandidat_navn:r.kandidat_navn, parti:r.parti });
      }
    }
    return Array.from(m.values());
  }
  function rankCandidates(cands, q){
    const Q = fold(q);
    if(!Q) return [];
    return cands.map(c=>{
      const name = normalizeCandidateName(c.kandidat_navn);
      const f = fold(name);
      let score = -Infinity;
      if(f.startsWith(Q)) score = 300 - (f.length - Q.length);
      else{
        const hasWordStart = f.split(/\s+/).some(w=>w.startsWith(Q));
        if(hasWordStart) score = 200 - f.indexOf(Q);
        else if(f.includes(Q)) score = 100 - f.indexOf(Q);
      }
      const pf = fold(c.parti);
      if(pf.startsWith(Q) || pf.includes("("+Q+")")) score += 20;
      return { ...c, _score: score, _name: name };
    })
    .filter(x=>x._score>-Infinity)
    .sort((a,b)=> b._score - a._score || a._name.localeCompare(b._name, "da"))
    .slice(0, 15);
  }

  function renderLanding(){
    const inputK = el('kommuneSearch');
    if(inputK){
      inputK.addEventListener('input', (e)=>{
        const val=(e.target.value||'').toLowerCase();
        if(!val) return;
        const hit = Object.entries(REGIONS).flatMap(([r,ks])=>ks.map(k=>({r,k}))).find(x=>x.k.toLowerCase().startsWith(val));
        if(hit){
          el('regionSelect').value=hit.r; populateKommuner(hit.r);
          el('kommuneSelect').value=hit.k; state.region=hit.r; state.kommune=hit.k;
          persistUrl(true);
          loadKommuneData(hit.k);
        }
      });
    }

    const input = el('candidateSearch');
    const menu  = el('candidateMenu');
    let activeIndex = -1;

    function closeMenu(){ menu.classList.add('hidden'); activeIndex = -1; }
    function openMenu(){ menu.classList.remove('hidden'); }

    function renderMenuFor(query){
      const cands = buildCandidateList(state.rows || []);
      const results = rankCandidates(cands, query);
      if(!results.length){ closeMenu(); menu.innerHTML=""; return; }

      menu.innerHTML = results.map((c,i)=>{
        const letter = detectPartyLetter((state.rows||[]).filter(r=>r.parti===c.parti));
        const bd = badge(letter);
        const sub = `${escapeHtml(c.parti)}`;
        return `<div class="vb-option" role="option" data-idx="${i}" data-cand="${escapeHtml(c.kandidat_id)}" aria-selected="${i===activeIndex}">
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
          <span class="flex-1">
            <span class="font-medium">${escapeHtml(normalizeCandidateName(c.kandidat_navn))}</span><br/>
            <span class="text-xs text-gray-500">${sub}</span>
          </span>
        </div>`;
      }).join("");

      menu.querySelectorAll('.vb-option').forEach(opt=>{
        opt.onclick = ()=> selectByIndex(parseInt(opt.getAttribute('data-idx'),10));
      });

      openMenu();
    }

    function selectByIndex(i){
      const cands = buildCandidateList(state.rows || []);
      const results = rankCandidates(cands, input.value);
      const sel = results[i];
      if(!sel) return;
      openCandidateModal(sel.kandidat_id);
      closeMenu();
      input.value = "";
    }

    let t=null;
    input?.addEventListener('input', ()=>{
      const q = input.value.trim();
      if(t) clearTimeout(t);
      if(!q){ closeMenu(); return; }
      t = setTimeout(()=>renderMenuFor(q), 120);
    });

    input?.addEventListener('keydown', (e)=>{
      const results = rankCandidates(buildCandidateList(state.rows||[]), input.value);
      if(e.key==='ArrowDown'){
        e.preventDefault();
        if(!results.length) return;
        activeIndex = (activeIndex+1) % results.length;
        renderMenuFor(input.value);
        const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
        if(opt){ menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); opt.scrollIntoView({block:'nearest'}); }
      }else if(e.key==='ArrowUp'){
        e.preventDefault();
        if(!results.length) return;
        activeIndex = (activeIndex<=0 ? results.length-1 : activeIndex-1);
        renderMenuFor(input.value);
        const opt = menu.querySelector(`[data-idx="${activeIndex}"]`);
        if(opt){ menu.querySelectorAll('.vb-option').forEach(x=>x.setAttribute('aria-selected','false')); opt.setAttribute('aria-selected','true'); opt.scrollIntoView({block:'nearest'}); }
      }else if(e.key==='Enter'){
        if(!menu.classList.contains('hidden')){
          e.preventDefault();
          selectByIndex(activeIndex>=0 ? activeIndex : 0);
        }
      }else if(e.key==='Escape'){
        closeMenu();
      }
    });

    document.addEventListener('click',(e)=>{
      const box = el('candidateSearch')?.parentElement;
      if(box && !box.contains(e.target)) closeMenu();
    });
  }

  /* DROPDOWNS */
  function initRegionDropdown(){
    const rsel=el("regionSelect");
    rsel.innerHTML=`<option value="">Hele Danmark</option>`+Object.keys(REGIONS).map(r=>`<option value="${r}">${r}</option>`).join("");
    rsel.onchange=()=>{
      const r=rsel.value; state.region=r; state.kommune=""; state.activeParty="";
      el("kommuneSelect").disabled=!r;
      el("kommuneSelect").innerHTML=`<option value="">Vælg kommune…</option>`;
      if(r) populateKommuner(r);
      clearAll();
      if(r){ persistUrl(true); loadRegionData(r); } else { persistUrl(true); loadNationalData(); }
      renderContextBar();
    };
    el("kommuneSelect").disabled=true;
  }

  function populateKommuner(region){
    const ksel=el("kommuneSelect");
    const kommuner=REGIONS[region]||[];
    const first = `<option value="${ALL_IN_REGION}">Alle kommuner i regionen</option>`;
    const items = kommuner.map(k=>`<option value="${k}">${k}</option>`).join("");
    ksel.innerHTML=`<option value="">Vælg kommune…</option>${first}${items}`;
    ksel.onchange=()=>{
      const k=ksel.value; state.kommune=k; state.activeParty=""; clearAll();
      if(k === ALL_IN_REGION){ persistUrl(true); loadRegionData(state.region); }
      else if(k){ persistUrl(true); loadKommuneData(k); }
      else{ persistUrl(true); loadRegionData(state.region); }
      renderContextBar();
    };
  }

  function clearAll(){
    state.rows=[]; state.selected.clear();
    resetPartyUI(); renderAll(); el("kommunetitel").textContent="";
  }
  function resetPartyUI(){
    const btn=el("partyButton"), btnc=el("partyButtonContent");
    const disabled = !state.kommune || state.kommune===ALL_IN_REGION;
    btn.disabled = disabled; btn.setAttribute('aria-expanded','false');
    btnc.innerHTML = disabled
      ? `<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">${state.kommune===ALL_IN_REGION?'Ikke tilgængelig i regionsvisning':'Vælg kommune først…'}</span>`
      : `<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`;
    el("partyMenu").innerHTML="";
    el("partyDetailHeader").textContent = disabled ? (state.kommune===ALL_IN_REGION ? "Vælg en specifik kommune for at se partier." : "Vælg en kommune for at se partier.") : "Vælg et parti i drop-down menuen.";
    el("candidateColLeft").innerHTML=""; el("candidateColRight").innerHTML="";
  }

  /* ======== FETCH-HELPERS ======== */
  async function fetchArrayBuffer(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`404 for ${url}`);
    return await r.arrayBuffer();
  }
  async function fetchTextSmart(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`404 for ${url}`);
    const buf = await r.arrayBuffer();
    const bytes = new Uint8Array(buf);
    const hasUTF8BOM  = bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF;
    const hasUTF16LE  = bytes.length >= 2 && bytes[0] === 0xFF && bytes[1] === 0xFE;
    const hasUTF16BE  = bytes.length >= 2 && bytes[0] === 0xFE && bytes[1] === 0xFF;
    try{
      if(hasUTF16LE) return new TextDecoder("utf-16le").decode(buf);
      if(hasUTF16BE) return new TextDecoder("utf-16be").decode(buf);
      if(hasUTF8BOM) return new TextDecoder("utf-8").decode(buf);
      const sample = bytes.slice(0, 512);
      const nulCount = sample.filter(b => b === 0x00).length;
      if(nulCount > sample.length * 0.1) return new TextDecoder("utf-16le").decode(buf);
      const utf8Text = new TextDecoder("utf-8", { fatal:false }).decode(buf);
      if(/\uFFFD/.test(utf8Text)){ try{ return new TextDecoder("windows-1252").decode(buf); }catch(_){ } }
      return utf8Text;
    }catch(e){ return new TextDecoder().decode(buf); }
  }

  /* ======== PARSING ======== */
  function parseXlsxToRows(buf){
    const wb = XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
    return rows.map(r => ({
      region: canon(r.Region || r.region || ""),
      kommune: canon(r.Kommune || r.kommune || ""),
      valgsted_id: canon(r.Valgsted_ID || r.ValgstedId || r.Afstemningssted_ID || r.Afstemningsområde_ID || r.valgsted_id || r.sted_id || ""),
      valgsted_navn: canon(r.Valgsted || r.Valgsted_Navn || r.Afstemningssted || r.Afstemningsområde || r.valgsted_navn || r.sted_navn || ""),
      kandidat_id: canon(r.Kandidat_ID || r.kandidat_id || r.Kandidat || r.kandidat_navn || r.Navn || ""),
      kandidat_navn: normalizeCandidateName(canon(r.Navn || r.Kandidat || r.kandidat_navn || r.kandidat_id || "")),
      parti: canon(r.Listenavn || r.Parti || r.parti || ""),
      parti_bogstav: canon(r.Bogstavbetegnelse || r.Listebogstav || r.parti_bogstav || r.listebogstav || ""),
      stemmer: Number(r.Stemmetal || r.stemmer || r.Stemmer || 0) || 0
    }));
  }
  function parseCsvTextToRows(text){
    let res = Papa.parse(text, { header:true, skipEmptyLines:true, delimiter:"", transformHeader:h=>canon(h.toLowerCase()) });
    const bad = !res.data.length || Object.keys(res.data[0] || {}).length <= 1;
    if (bad) {
      const head = text.slice(0, 4096);
      const counts = { ";": (head.match(/;/g)||[]).length, ",": (head.match(/,/g)||[]).length, "\t": (head.match(/\t/g)||[]).length };
      const delim = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
      res = Papa.parse(text, { header:true, skipEmptyLines:true, delimiter:delim, transformHeader:h=>canon(h.toLowerCase()) });
      console.warn("CSV: heuristik delimiter =", JSON.stringify(delim));
    }
    return res.data.map(r=>({
      region: canon(r.region||""),
      kommune: canon(r.kommune||""),
      valgsted_id: canon(r.valgsted_id||r.sted_id||r.afstemningssted_id||r.afstemningsområde_id||r["valgsted id"]||""),
      valgsted_navn: canon(r.valgsted_navn||r.sted_navn||r.afstemningssted||r.afstemningsområde||r["valgsted"]||""),
      kandidat_id: canon(r.kandidat_id||r.kandidat||r.navn||r.kandidat_navn||""),
      kandidat_navn: normalizeCandidateName(canon(r.kandidat_navn||r.navn||r.kandidat||r.kandidat_id||"")),
      parti: canon(r.parti||r.listenavn||r["listenavn"]||""),
      parti_bogstav: canon(r.parti_bogstav||r.listebogstav||r.bogstavbetegnelse||""),
      stemmer: Number(r.stemmer||r.stemmetal||r["stemmer"]||r["stemmetal"]||0)||0
    }));
  }

  function regionFileBase(regionName){ return (regionName||"").replace(/\s+/g,"_"); }

  async function loadRowsForRegion(region){
    const regFolder = encodeURIComponent(region || "");
    const base = regionFileBase(region || "");
    const candidatesXlsx = [
      `${BASE_PATH}${regFolder}/${base}_allepartier.xlsx`,
      `${BASE_PATH}${regFolder}/${base}.xlsx`,
    ];
    const candidatesCsv = [
      `${BASE_PATH}${regFolder}/${base}_allepartier.csv`,
      `${BASE_PATH}${regFolder}/${base}.csv`,
    ];

    for(const url of candidatesXlsx){ try{ const buf=await fetchArrayBuffer(url); return parseXlsxToRows(buf); }catch(_){ } }
    for(const url of candidatesCsv){ try{ const text=await fetchTextSmart(url); return parseCsvTextToRows(text); }catch(_){ } }

    const names=(REGIONS[region]||[]);
    const chunks=await Promise.all(names.map(name=>loadRowsForKommune(name).catch(()=>[])));
    return chunks.flat();
  }

  // Kommunedata fra regionsfilen
  async function loadRowsForKommune(k){
    if(state.csvCache.has(k)) return state.csvCache.get(k);
    const regName = findRegionForKommune(k);
    if(!regName) throw new Error(`Ukendt kommune: ${k}`);
    const regionRows = await loadRowsForRegion(regName);
    const rows = regionRows.filter(r => (r.kommune || k) === k);
    state.csvCache.set(k, rows);
    return rows;
  }

  /* ======== Danmark (aggregér regionsfiler) ======== */
  async function loadNationalData(){
    try{
      showLoading();
      el('error').textContent=''; el('kommunetitel').textContent='(Danmark)';
      const regioner = Object.keys(REGIONS);
      const chunks = await Promise.all(regioner.map(r => loadRowsForRegion(r).catch(() => [])));
      state.rows = chunks.flat();
      if(!state.rows.length){ el('error').textContent = 'Ingen data indlæst for Danmark – tjek at regionsfilerne findes og kan læses.'; }
      afterDataLoaded();
    }finally{ hideLoading(); }
  }

  async function loadRegionData(region){
    try{
      showLoading();
      el('error').textContent=''; el('kommunetitel').textContent = state.kommune===ALL_IN_REGION ? `(${region} – alle kommuner)` : `(${region})`;
      const rows = await loadRowsForRegion(region);
      state.rows = rows.filter(r => (r.region||region) === region);
      if(!state.rows.length){ el('error').textContent = 'Ingen rækker indlæst for denne region.'; }
      afterDataLoaded();
    }catch(e){ el('error').textContent = `Kunne ikke indlæse region: ${e.message||e}`; }
    finally{ hideLoading(); }
  }

  async function loadKommuneData(k){
    try{
      showLoading();
      el("error").textContent=""; el("kommunetitel").textContent=k?`(${k})`:"";
      const rows = await loadRowsForKommune(k);
      state.rows = rows.filter(r => (r.kommune||k) === k);
      if(!state.rows.length){ el('error').textContent = 'Ingen rækker indlæst for denne kommune.'; }
      afterDataLoaded();
    }catch(e){ el("error").textContent=`Kunne ikke hente kommunedata for ${k} fra regionsfilen.`; }
    finally{ hideLoading(); }
  }

  function afterDataLoaded(){
    applyPendingSelections(); resetPartyUI();
    if(state.kommune && state.kommune!==ALL_IN_REGION) renderPartyCombobox();
    updateTopButtonsForScope(); renderOverview(); renderAll(); renderContextBar();
    document.getElementById('candidateMenu')?.classList.add('hidden');
  }
  function applyPendingSelections(){
    if(state.pendingCandidateIds && state.pendingCandidateIds.length){
      for(const id of state.pendingCandidateIds){
        const sample = state.rows.find(r=>r.kandidat_id===id);
        if(sample){ state.selected.set(sample.kandidat_id, { kandidat_id: sample.kandidat_id, kandidat_navn: sample.kandidat_navn, parti: sample.parti }); }
      }
      state.pendingCandidateIds = [];
    }
  }

  /* TOP 10/50 */
  const sortKandidaterAlpha = (a,b)=>{
    const aName = normalizeCandidateName(a.kandidat_navn), bName = normalizeCandidateName(b.kandidat_navn);
    const al=isListestemmer(aName), bl=isListestemmer(bName);
    if(al&&!bl) return 1; if(!al&&bl) return -1;
    return aName.localeCompare(bName,"da");
  };
  const sortKandidaterVotes = (a,b)=>{
    const aName = normalizeCandidateName(a.kandidat_navn), bName = normalizeCandidateName(b.kandidat_navn);
    const al=isListestemmer(aName), bl=isListestemmer(bName);
    if(al&&!bl) return 1; if(!al&&bl) return -1;
    const dv=(b.total||0)-(a.total||0); if(dv!==0) return dv;
    return aName.localeCompare(bName,"da");
  };

  function totalsByCandidate(rows){
    const m=new Map();
    for(const r of rows){
      if(!m.has(r.kandidat_id)){ m.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0}); }
      m.get(r.kandidat_id).total+=r.stemmer;
    }
    return Array.from(m.values()).filter(k=>!isListestemmer(k.kandidat_navn)).sort((a,b)=>b.total-a.total);
  }

  function renderOverview(){
    const rows = state.rows || [];
    const scopeText =
      state.kommune === ALL_IN_REGION ? `${state.region} – alle kommuner` :
      (state.kommune ? state.kommune : (state.region? `${state.region}` : 'Danmark'));
    el("top10Scope").textContent = rows.length ? scopeText : '';
    const ranked = totalsByCandidate(rows);
    let list;
    if(state.topListMode==="top10"){ list = ranked.slice(0,10); el("top10Title").textContent = "Top 10 kandidater (personlige stemmer)"; }
    else { list = ranked.slice(0,50); el("top10Title").textContent = "Top 50 kandidater (personlige stemmer)"; }

    function itemHTML(k, idx){
      const letter = detectPartyLetter(rows.filter(r=>r.parti===k.parti));
      const bd = badge(letter);
      const meta = `${escapeHtml(k.parti)} · ${fmt(k.total)} stemmer`;
      return `<li class="top10-item" data-cand="${escapeHtml(k.kandidat_id)}" role="button" tabindex="0" title="Klik for detaljer">
        <span class="rank-pill">${idx}</span>
        <div class="min-w-0 flex-1">
          <div class="font-medium truncate">${escapeHtml(normalizeCandidateName(k.kandidat_navn))}</div>
          <div class="text-xs text-gray-500 truncate">${meta}</div>
        </div>
        <span class="vb-badge" style="${bd.style}">${bd.text}</span>
      </li>`;
    }

    const half=Math.ceil(list.length/2), left=list.slice(0,half), right=list.slice(half);
    el("top10ColLeft").innerHTML = left.map((k,i)=>itemHTML(k, i+1)).join("") || `<div class="text-sm text-gray-500">Ingen data at vise.</div>`;
    el("top10ColRight").innerHTML = right.map((k,i)=>itemHTML(k, i+1+half)).join("");

    ['top10ColLeft','top10ColRight'].forEach(rootId=>{
      document.getElementById(rootId).querySelectorAll('.top10-item').forEach(item=>{
        const candId=item.getAttribute('data-cand');
        item.addEventListener('click', ()=>openCandidateModal(candId));
        item.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openCandidateModal(candId); } });
      });
    });
  }

  /* ====== Kandidat-modal ====== */
  function openCandidateModal(candId){
    const rows = state.rows || [];
    const candRows = rows.filter(r => r.kandidat_id === candId);
    if(!candRows.length) return;

    const name = normalizeCandidateName(candRows[0].kandidat_navn);
    const parti = candRows[0].parti || "";
    const letter = detectPartyLetter(rows.filter(r=>r.parti===parti));
    const bd = badge(letter);
    const total = candRows.reduce((s,r)=>s+(r.stemmer||0),0);

    // Header
    el('modalTitle').textContent = name;
    el('modalSub').innerHTML = `<span class="inline-flex items-center gap-2"><span class="vb-badge" style="${bd.style};height:22px;width:22px;font-size:.8rem">${bd.text}</span><span>${escapeHtml(parti)}</span></span>`;
    el('modalTotal').textContent = fmt(total);

    // Kommuner (sum pr. kommune)
    const byK=new Map();
    for(const r of candRows){
      const k=r.kommune||"(ukendt kommune)";
      const o=byK.get(k)||{ kommune:k, total:0 };
      o.total += r.stemmer||0;
      byK.set(k,o);
    }
    const kommuner = Array.from(byK.values()).sort((a,b)=>b.total-a.total);

    const root = el('modalKommuneList');
    root.innerHTML = kommuner.map(k => kommuneRowHTML(k.kommune, k.total)).join("");

    // bind knapper
    root.querySelectorAll('[data-kommune]').forEach(div=>{
      const kommune = div.getAttribute('data-kommune');
      // Se valgsteder (accordion)
      div.querySelector('[data-toggle]')?.addEventListener('click', async ()=>{
        const row = div;
        const body = row.querySelector('.accordion-body');
        const arrow = row.querySelector('[data-arrow]');
        const open = row.classList.toggle('open');
        arrow.style.transform = open ? 'rotate(90deg)' : 'rotate(0deg)';
        if(open){
          if(!body.getAttribute('data-filled')){
            const ps = getPollingStationsForCandidateInKommune(candRows, kommune);
            body.innerHTML = renderValgstederTable(ps);
            body.setAttribute('data-filled', '1');
          }
        }
      });
      // Se i kommune (navigate)
      div.querySelector('[data-goto]')?.addEventListener('click', ()=>{
        goToMunicipality(kommune);
        closeCandidateModal();
      });
    });

    openModal();
  }

  function kommuneRowHTML(kommune, total){
    return `<div class="accordion rounded-xl border p-2" data-kommune="${escapeHtml(kommune)}">
      <div class="flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <button class="vb-btn" data-toggle title="Se valgsteder">
            <svg data-arrow class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7 5l6 5-6 5V5z"/></svg>
          </button>
          <div class="font-medium">${escapeHtml(kommune)}</div>
        </div>
        <div class="flex items-center gap-3">
          <div class="tabular-nums font-medium">${fmt(total)}</div>
          <button class="vb-btn" data-goto>Se i kommune</button>
        </div>
      </div>
      <div class="accordion-body mt-2 pl-10"></div>
    </div>`;
  }

  function getPollingStationsForCandidateInKommune(candRows, kommune){
    const list = candRows.filter(r => (r.kommune||"") === kommune);
    const m=new Map();
    for(const r of list){
      const key = r.valgsted_id || r.valgsted_navn || "–";
      if(!m.has(key)) m.set(key, { navn: r.valgsted_navn || r.valgsted_id || "–", total:0 });
      m.get(key).total += r.stemmer||0;
    }
    // Sortér efter flest stemmer (sekundært alfabetisk)
    return Array.from(m.values()).sort((a,b)=>b.total-a.total || a.navn.localeCompare(b.navn,'da'));
  }

  // >>> NUMMERERET TABEL OVER VALGSTEDER <<<
  function renderValgstederTable(ps){
    if(!ps.length) return `<div class="text-sm text-gray-500">Ingen stemmer registreret.</div>`;
    const rows = ps.map((p, i)=>`
      <tr class="border-b last:border-0">
        <td class="py-1 pr-3 tabular-nums text-right w-12">${i+1}</td>
        <td class="py-1 pr-3">${escapeHtml(p.navn)}</td>
        <td class="py-1 pr-1 tabular-nums text-right">${fmt(p.total)}</td>
      </tr>`).join("");
    return `<div class="overflow-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-1 pr-3 text-right w-12">#</th>
            <th class="py-1 pr-3">Valgsted</th>
            <th class="py-1 pr-1 text-right">Stemmer</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  }

  function goToMunicipality(kommune){
    const reg = findRegionForKommune(kommune);
    if(!reg) return;
    el('regionSelect').value = reg; populateKommuner(reg);
    state.region = reg;
    const ksel = el('kommuneSelect'); ksel.value = kommune;
    state.kommune = kommune;
    clearAll(); persistUrl(true); loadKommuneData(kommune);
    renderContextBar();
  }

  function openModal(){
    el('modalBackdrop').classList.add('open');
    el('candidateModal').classList.add('open');
    el('modalClose').focus();
  }
  function closeCandidateModal(){
    el('modalBackdrop').classList.remove('open');
    el('candidateModal').classList.remove('open');
  }

  function primaryRegionForCandidate(candId, rows){
    const count=new Map();
    for(const r of rows){
      if(r.kandidat_id===candId){
        const reg = r.region || findRegionForKommune(r.kommune);
        if(reg){ count.set(reg,(count.get(reg)||0)+1); }
      }
    }
    if(count.size===0) return null;
    const [region,] = Array.from(count.entries()).sort((a,b)=>b[1]-a[1])[0];
    return region || null;
  }

  function updateTopButtonsForScope(){ const btnAll = el("btnAll"); if(btnAll) btnAll.textContent = "Top 50"; }

  /* PARTI-STATS & COMBOBOX */
  function getPartyStats(){
    const byParti=new Map();
    for(const r of state.rows){ if(!byParti.has(r.parti)) byParti.set(r.parti,[]); byParti.get(r.parti).push(r); }
    const res=[];
    for(const [parti,rowsP] of byParti.entries()){
      const map=new Map();
      for(const r of rowsP){
        if(!map.has(r.kandidat_id)) map.set(r.kandidat_id,{kandidat_id:r.kandidat_id,kandidat_navn:r.kandidat_navn,parti:r.parti,total:0});
        map.get(r.kandidat_id).total+=r.stemmer;
      }
      const kandidater=Array.from(map.values());
      const letter = detectPartyLetter(rowsP);
      res.push({ parti, letter, hasLetter: !!letter, kandidatAntal: kandidater.filter(k=>!isListestemmer(k.kandidat_navn)).length, kandidater });
    }
    res.sort((a,b)=>{ if(a.hasLetter!==b.hasLetter) return a.hasLetter?-1:1; if(a.hasLetter&&b.hasLetter) return a.letter.localeCompare(b.letter,"da"); return a.parti.localeCompare(b.parti,"da"); });
    return res;
  }
  function renderPartyCombobox(){
    if(!state.kommune || state.kommune===ALL_IN_REGION){ resetPartyUI(); return; }

    const stats=getPartyStats(), btn=el("partyButton"), btnc=el("partyButtonContent"), menu=el("partyMenu");
    if(!stats.length){ btn.disabled=true; btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Ingen partier fundet</span>`; menu.innerHTML=""; return; }
    btn.disabled=false;
    function renderButton(){
      if(!state.activeParty){ btnc.innerHTML=`<span class="vb-badge" style="background:#e5e7eb;color:#111827;border-color:#e5e7eb"> </span><span class="truncate text-gray-500">Vælg parti…</span>`; return; }
      const cur=stats.find(s=>s.parti===state.activeParty);
      const {style,text}=badge(cur?.letter||null);
      btnc.innerHTML=`<span class="vb-badge" style="${style}">${text}</span><span class="truncate">${escapeHtml(state.activeParty)}</span>`;
    }
    function renderMenu(){
      menu.innerHTML=stats.map(s=>{
        const {style,text}=badge(s.letter);
        const sel=s.parti===state.activeParty;
        return `<div class="vb-option" role="option" data-parti="${escapeHtml(s.parti)}" aria-selected="${sel}">
          <span class="vb-badge" style="${style}">${text}</span>
          <span class="flex-1">${escapeHtml(s.parti)}</span>
          <span class="text-xs text-gray-500">${s.kandidatAntal} kandidater</span>
        </div>`;
      }).join("");
      menu.querySelectorAll('.vb-option').forEach((opt,i)=>{
        opt.onclick=()=>{
          state.activeParty=opt.getAttribute('data-parti');
          renderButton(); closePartyMenu(); renderPartyDetail(state.activeParty);
          menu.querySelectorAll('.vb-option').forEach((x,j)=>x.setAttribute('aria-selected', j===i));
          persistUrl(false);
        };
      });
    }
    btn.onclick=()=>{ const open=btn.getAttribute('aria-expanded')==='true'; if(open) closePartyMenu(); else { renderMenu(); openPartyMenu(); } };
    function openPartyMenu(){ btn.setAttribute('aria-expanded','true'); menu.classList.remove('hidden'); menu.focus(); }
    function closePartyMenu(){ btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden'); }
    window.closePartyMenu=closePartyMenu;

    renderButton();
    el("partyDetailHeader").textContent = "Vælg et parti i drop-down menuen.";
    el("candidateColLeft").innerHTML = ""; el("candidateColRight").innerHTML = "";
  }

  function renderPartyDetail(parti){
    const header=el("partyDetailHeader"), left=el("candidateColLeft"), right=el("candidateColRight");
    left.innerHTML=""; right.innerHTML="";
    if(!parti){ header.textContent="Vælg et parti i drop-down menuen."; return; }
    header.textContent=parti;

    const kandidaterAll=getPartyStats().find(x=>x.parti===parti)?.kandidater||[];
    const sorted = kandidaterAll.slice().sort(state.candidateSortMode==='alpha' ? sortKandidaterAlpha : sortKandidaterVotes);

    const mid=Math.ceil(sorted.length/2), leftArr=sorted.slice(0,mid), rightArr=sorted.slice(mid);
    function card(k){
      const listestemmer=isListestemmer(k.kandidat_navn);
      const subtitle = listestemmer ? `${fmt(k.total)} listestemmer` : `${fmt(k.total)} stemmer i alt`;
      const meta = `${escapeHtml(k.parti)} · ${subtitle}`;
      const div=document.createElement('div');
      div.className='rounded-xl border px-3 py-2';
      div.innerHTML=`<div class="flex items-center justify-between">
        <div><div class="font-medium">${escapeHtml(normalizeCandidateName(k.kandidat_navn))}</div><div class="text-xs text-gray-500">${meta}</div></div>
        <div class="flex gap-2">
          <button class="vb-btn" data-detail="${k.kandidat_id}">Detaljer</button>
          <button class="vb-btn" data-add="${k.kandidat_id}">Tilføj</button>
        </div></div>`;
      div.querySelector('button[data-add]').onclick=()=>{
        state.selected.set(k.kandidat_id,{kandidat_id:k.kandidat_id,kandidat_navn:k.kandidat_navn,parti:k.parti});
        renderAll(); persistUrl(false);
      };
      div.querySelector('button[data-detail]').onclick=()=>openCandidateModal(k.kandidat_id);
      return div;
    }
    leftArr.forEach(k=>left.appendChild(card(k)));
    rightArr.forEach(k=>right.appendChild(card(k)));
  }

  function getSelectedInScope(){
    const idsInRows = new Set((state.rows||[]).map(r => r.kandidat_id));
    return Array.from(state.selected.values()).filter(k => idsInRows.has(k.kandidat_id));
  }
  const getSelected = () => getSelectedInScope();
  const getSelectedOrdered = () => { const s=getSelectedInScope().slice(); s.sort(sortKandidaterAlpha); return s; };

  function renderAll(){
    renderSelected();
    renderPsTable(getPollingStations(), getSelectedOrdered());
    const hasSel=getSelected().length>0;
    el("compareSection").classList.toggle("hidden",!hasSel);
    el("tabsCard").classList.toggle("hidden",!hasSel);
  }
  function computeTotalsByCandidate(){
    const m=new Map();
    for(const r of state.rows) m.set(r.kandidat_id,(m.get(r.kandidat_id)||0)+r.stemmer);
    return m;
  }
  function stemmerLabel(n){ return n===1 ? 'stemme' : 'stemmer'; }

  function renderSelected(){
    const root=el("selectedList"), totals=computeTotalsByCandidate(), sel=getSelectedOrdered();
    function letterForParti(parti){
      const rowsFor = (state.rows||[]).filter(r=>r.parti===parti);
      const letter = detectPartyLetter(rowsFor);
      return letter || null;
    }
    root.innerHTML= sel.map(k=>{
      const letter=letterForParti(k.parti), bd=badge(letter), total=totals.get(k.kandidat_id)||0;
      const listestemmer=isListestemmer(k.kandidat_navn);
      const totalTekst=listestemmer?`${fmt(total)} ${total===1?'listestemme':'listestemmer'}`:`${fmt(total)} personlige ${stemmerLabel(total)} i alt`;
      return `<div class="rounded-xl border p-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="vb-badge" style="${bd.style}">${bd.text}</span>
          <div class="font-medium">${escapeHtml(normalizeCandidateName(k.kandidat_navn))} <span class="text-gray-500">(${escapeHtml(k.parti)})</span></div>
        </div>
        <div class="flex items-center gap-3">
          <div class="tabular-nums font-medium">${totalTekst}</div>
          <button class="vb-btn" onclick="removeCandidate('${k.kandidat_id}')">Fjern</button>
        </div>
      </div>`;
    }).join("") || `<div class="text-sm text-gray-500">Ingen kandidater valgt endnu.</div>`;
    el("btnClearAll").disabled = sel.length===0;
  }
  window.removeCandidate = id => { state.selected.delete(id); renderAll(); persistUrl(false); };

  function getPollingStations(){
    const m=new Map();
    for(const r of state.rows){
      const key = `${r.kommune||state.region}::${r.valgsted_id}`;
      if(!m.has(key)) m.set(key,{id:key,navn:r.valgsted_navn,kommune:r.kommune});
      const ps=m.get(key);
      ps[r.kandidat_id]=(ps[r.kandidat_id]||0)+r.stemmer;
    }
    return Array.from(m.values()).sort((a,b)=> (a.kommune||"").localeCompare(b.kommune||"", 'da') || (a.navn||"").localeCompare(b.navn||"", 'da'));
  }

  function renderPsTable(psList, sel){
    const thead=el("psThead"), tbody=el("psTbody"), tfoot=el("psTFoot");
    if(!sel.length){
      thead.innerHTML=`<tr><th class="text-left py-2 pr-3">Valgsted</th></tr>`;
      tbody.innerHTML=""; tfoot.innerHTML=""; return;
    }
    const header = sel.map(s=>{
      const rowsFor = (state.rows||[]).filter(r=>r.parti===s.parti);
      const bd = badge(detectPartyLetter(rowsFor));
      return `<th class="py-2 pr-3"><div class="flex items-center gap-2">
        <span class="vb-badge" style="${bd.style};height:24px;width:24px;font-size:.75rem">${bd.text}</span>
        <span>${escapeHtml(normalizeCandidateName(s.kandidat_navn))} (${escapeHtml(s.parti)})</span></div></th>`;
    }).join("");
    thead.innerHTML=`<tr class="text-left border-b"><th class="py-2 pr-3">Valgsted</th>${header}</tr>`;

    tbody.innerHTML=psList.map(ps=>`<tr class="border-b last:border-0">
      <td class="py-2 pr-3 font-medium">${escapeHtml(ps.kommune? `${ps.kommune}: ${ps.navn}` : ps.navn)}</td>
      ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums">${fmt(ps[s.kandidat_id]||0)}</td>`).join("")}
    </tr>`).join("");

    const totals=computeTotalsByCandidate();
    tfoot.innerHTML=`<tr class="border-t"><th class="py-2 pr-3 text-left">${state.kommune && state.kommune!==ALL_IN_REGION ? 'Kommunetotal' : 'Regionstotal'}</th>
      ${sel.map(s=>`<td class="py-2 pr-3 tabular-nums font-medium">${fmt(totals.get(s.kandidat_id)||0)}</td>`).join("")}
    </tr>`;
  }

  function renderContextBar(){
    const bar = document.getElementById('contextBar');
    const parts = [];
    parts.push(!state.region ? `<span class="crumb-strong">Danmark</span>` : `<span class="crumb" data-nav="dk">Danmark</span>`);
    if(state.region){
      parts.push(`<span class="sep">/</span>`);
      parts.push(!state.kommune ? `<span class="crumb-strong">${escapeHtml(state.region)}</span>` : `<span class="crumb" data-nav="region">${escapeHtml(state.region)}</span>`);
      if(state.kommune){
        parts.push(`<span class="sep">/</span>`);
        const kommotekst = (state.kommune===ALL_IN_REGION) ? "Alle kommuner i regionen" : escapeHtml(state.kommune);
        parts.push(`<span class="crumb-strong">${kommotekst}</span>`);
      }
    }
    bar.innerHTML = parts.join("");
    bar.querySelector('[data-nav="dk"]')?.addEventListener('click', ()=>{
      el('regionSelect').value=''; el('kommuneSelect').innerHTML='<option value="">Vælg kommune…</option>'; el('kommuneSelect').disabled=true;
      state.region=''; state.kommune=''; clearAll(); persistUrl(true); loadNationalData();
    });
    bar.querySelector('[data-nav="region"]')?.addEventListener('click', ()=>{
      const ksel=el('kommuneSelect');
      if(ksel){ ksel.value=ALL_IN_REGION; state.kommune=ALL_IN_REGION; clearAll(); persistUrl(true); loadRegionData(state.region); }
    });
  }

  function closePartyMenu(){ const btn=el('partyButton'), menu=el('partyMenu'); btn?.setAttribute('aria-expanded','false'); menu?.classList.add('hidden'); }
</script>
</body>
</html>
